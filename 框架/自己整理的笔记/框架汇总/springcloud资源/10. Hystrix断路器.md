

#### 服务雪崩

​    多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B、C调用其他微服务，这就是"扇出"。当扇出的链路上某个微服务的调用响应事件过长或不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，所谓"雪崩效应"。

​    对于高流量的应用，单一的后端依赖可能会导致所有服务器上的所有资源在几秒内饱和。比失败更糟糕的是，这些应用程序还可能导致服务之间的延迟增加，备份队列，线程和其他资源紧张，导致整个系统发生更多的级联故障。这些都表示需要对故障和延迟进行隔离和管理，以便单个依赖关系的失败，不能取消整个应用程序或系统。

​    通常当你发现一个模块下的某个实例失败后，这时候这个模块依然还会接受流量，然后这个有问题的模块还调用了其他的模块，这样就会发生级联故障，或者叫雪崩。

#### Hystrix是什么？

​    Hystrix是一个用于处理分布式系统的延迟和容错的开源库，在分布式系统里，许多依赖不可避免的会调用失败，比如超时、异常等，Hystrix能够在一个依赖出问题的情况下，不会导致整体服务失败，避免级联故障，以提高分布式系统的弹性。

​    "短路器"本身是一种开关装置，当某个服务单元发生故障后，通过断路器的故障监控，向调用方返回一个符合预期的、可处理的备选响应(FallBack)，而不是长时间的等待或者抛出调用方无法处理的异常，这样就保证了服务调用方的线程不会被长时间、不必要的占用，从而避免了故障在分布式系统的蔓延，乃至雪崩。

#### 服务降级

  服务器忙，清稍后再试，不让客户端等待并立即返回一个友好提示，fallback（服务没停）

  发生场景：

- 程序运行异常
- 超时
- 服务熔断触发服务降级
- 线程池/信号量打满也会造成服务降级

#### 服务熔断

​    类比保险丝达到最大服务访问后，直接拒绝访问，拉闸先点，然后调用服务降级的方法并返回友好提示（breake，服务不可用）

​    服务的降级--服务熔断--恢复调用链路

#### 服务限流

​    秒杀高并发等操作，严禁一窝蜂的过来拥挤，大家排队，一秒钟N个，有序进行（flowlimit）

---

#### 服务降级

@HystrixCommand

单独使用线程池，隔离

降级即可放在服务端，也可放在客户端，大部分放在客户端



@DefaultProperties(defaultFallback="")

如果没有配置降级方法，可以走默认的



可以实现接口实现类，代码解耦

---

#### 服务熔断

**熔断机制概述**

熔断机制是对应雪崩效应的一种微服务链路保护机制。当扇出链路的某个微服务出错不可用或者响应时间太长时，会进行服务的降级，进而熔断该 节点微服务的调用，快速返回错误的响应信息。

当检测到该几点微服务调用响应正常后，回复调用链路。

 Hystrix会监控微服务间调用的状况，当失败的调用到一定阈值，缺省事5秒内调用20次失败，就会启动熔断机制。注解还是@HystrixCommand。

**状态**

- 开：请求不在进行调用当前服务，内部设置时钟一般为MTTR(平均故障处理时间)，当打开时长达到所设置时钟进入半熔断
- 半开：部分请求根据规则调用当前服务，如果请求成功且符合规则任务当前服务恢复正常，关闭熔断
- 关：熔断关闭不会对服务进行熔断

多次错误，然后慢慢正确，发现刚开始不满足条件，就算是正确的访问地址也不能进行正常访问。

**设计断路器三个参数**：快照时间窗、请求总数法制、错误百分比阀值

1. 快照时间窗：断路器是否打开需要统计一些请求和错误数据，而统计的时间范围就是快照时间窗，默认最近10秒。
2. 请求总数法制：在快照时间窗内，必须满足请求总数阀值才有资格熔断。默认是20，意味在10秒内，如果该hystrix命令调用的次数不足20次，即使发生错误，断路器也不开启。
3. 错误百分比阀值：当请求总数在快照时间窗内超过了阀值，比如调用了30次，有15次发生异常，假设默认50%阀值的情况下开启，则断路器打开。

*断路器工作步骤：

1. 当满足一定的阀值的时候，默认10秒内超过20个请求数
2. 当失败率达到一定的时候，默认10秒内超过50%的请求失败
3. 当满足1和2时，断路器会开启
4. 当开启断路器是，所有请求走兜底的方法(fallback)
5. 当一段时间后，默认5秒，这个时候断路器是半开状态，会让其中一个请求进行转发。如果成功，断路器会关闭，如果失败，继续开启，重复4和5

当断路器打开：

1. 再有请求调用的时候，将不会调用主逻辑，而是直接调用降级fallback，通过断路器，实现了自动的发现错误并将降级逻辑切换为主逻辑，减少响应延迟的效果。

2. 原来的主逻辑如何恢复？

   hystrix实现了自动恢复功能。当断路器打开，对主逻辑进行熔断后，hystrix会启动一个休眠时间窗，在这个时间窗内，降级逻辑临时成为主逻辑，当休眠时间窗到期，断路器进入半开状态，释放一次请求到原来的主逻辑上，如果此次请求正常返回，那么短裤及将继续闭合，主逻辑恢复，如果这次请求依然有问题，断路器继续进入打开状态，休眠时间窗重新计时。

**hystrix工作流程**

1. 创建HystrixCOmmand对象
2. 命令执行。execute()同步执行：从依赖的服务返回一个单一的结果对象，或者在发生错误的时候抛出异常；queue()异步执行，直接返回一个FUture对象，其中包含了对服务执行结束时需要返回的单一结果对象。
3. 如果当前命令的请求缓存功能是启用的，并且该命令缓存命中，name缓存的结果会以及以Observerable对象的方式返回。
4. 检查断路器是否为打开状态，如果断路器是打开的，nameHystrix不会执行命令，而是转到fallback处理逻辑【8】；如果断路器是关闭的，检查是否有可用的资源来执行命令【5】。
5. 线程池、请求队列、信号量是否占满，如果命令依赖服务的专有线程池和请求队列会信号量已经占满，namehystrix不会执行命令，而是转到fallback处理逻辑【8】。
6. hystrix会根据我们编写的方法来决定采取什么样的方式去请求依赖服务，hystrixcommand.run()，返回一个单一的结果，或者抛出异常。
7. hystrx会将成功、失败、拒绝、超时等信息报告给断路器，而断路器会维护一组计数器来统计这些数据。断路器会统计这些数据来决定断路器是否打开，来对某个依赖服务的请求进行熔断、短路。
8. 当命令失败的时候，hystrix会进入fallback返回结构，称为降级服务。能够引起降级服务的情况：第四步当前命令初一熔断短路状态，断路器是打开的时候；第五步当前命令的线程池、请求队列或信号量满的时候；第六步hystrixcommand.run()抛出异常的时候。
9. 当hystrix命令执行成功后，会将处理结果直接返回。

如果我们没有提供降级逻辑，当出现异常时，hystrix依然返回Observerable对象，但是不会发射任何结果数据，而是通过onError方法通知命令以及中断请求，并通过onError()方法引起命令失败的异常发送给调用者。

----

**Hystrix图形化Dashboard搭建**

Hystrix提供准实时的调用监控，hystrix会持续的记录所有通过hystrix发送的求情的执行信息，并以统计报表和图像的形式展示给用户，包括没秒执行多少请求成功失败等。netflix通过hystrix-metrics-event-stream项目实现了对以上指标的监控。spring cloud也提供了hystrix dashboard的整合，对监控内容转化成可视化界面。

http://localhost:9001/hystrix



服务提供者

```java
    /**
     * 此配置为了服务监控而配置，与服务容错本身无关，Spring cloud 升级后的坑
     * ServletRegistrationBean因为springboot的默认路径不是"hystrix/stream"，
     * 只要自己再项目上配置下面的servlet就可以了
     */
    @Bean
    public ServletRegistrationBean getServlet(){
        HystrixMetricsStreamServlet streamServlet = new HystrixMetricsStreamServlet();
        ServletRegistrationBean registrationBean = new ServletRegistrationBean(streamServlet);
        registrationBean.setLoadOnStartup(1);
        registrationBean.addUrlMappings("/hystrix.stream");
        registrationBean.setName("HystrixMetricsStreamServlet");
        return registrationBean;
    }
```

http://localhost:8001/hystrix.stream




# [1.Mycat简介](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1mycat简介)

数据库中间件

活跃的、性能好的开源数据库中间件!

> 数据库中间件:

处于底层数据库和用户应用系统之间，主要用于屏蔽异构数据库的底层细节的中间件。是客户端与后台的数据库之间进行通信的桥梁。

## [1.1Mycat前世今生](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_11mycat前世今生)

2013年阿里的Cobar在社区使用过程中发现存在一些比较严重的问题，及其使用限制，经过Mycat发起人第一次改良，第一代改良版——Mycat诞生。 Mycat开源以后，一些Cobar的用户参与了Mycat的开发，最终Mycat发展成为一个由众多软件公司的实力派架构师和资深开发人员维护的社区型开源软件。

2014年Mycat首次在上海的《中华架构师》大会上对外宣讲，更多的人参与进来，随后越来越多的项目采用了Mycat。

2015年5月，由核心参与者们一起编写的第一本官方权威指南《Mycat权威指南》电子版发布，累计超过500本，成为开源项目中的首创。

2015年10月为止，Mycat项目总共有16个Committer。

截至2015年11月，超过300个项目采用Mycat，涵盖银行、电信、电子商务、物流、移动应用、O2O的众多领域和公司。

截至2015年12月，超过4000名用户加群或研究讨论或测试或使用Mycat。

Mycat是基于开源cobar演变而来，我们对cobar的代码进行了彻底的重构，使用NIO重构了网络模块，并且优化了Buffer内核，增强了聚合，Join等基本特性，同时兼容绝大多数数据库成为通用的数据库中间件。1.4 版本以后 完全的脱离基本cobar内核，结合Mycat集群管理、自动扩容、智能优化，成为高性能的中间件。我们致力于开发高性能数据库中间而努力。永不收费，永不闭源，持续推动开源社区的发展。

Mycat吸引和聚集了一大批业内大数据和云计算方面的资深工程师，Mycat的发展壮大基于开源社区志愿者的持续努力，感谢社区志愿者的努力让Mycat更加强大，同时我们也欢迎社区更多的志愿者，特别是公司能够参与进来，参与Mycat的开发，一起推动社区的发展，为社区提供更好的开源中间件。

Mycat还不够强大，Mycat还有很多不足，欢迎社区志愿者的持续优化改进。

## [1.2关键特性](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_12关键特性)

支持SQL92标准

遵守Mysql原生协议，跨语言，跨平台，跨数据库的通用中间件代理。

基于心跳的自动故障切换，支持读写分离，支持MySQL主从，以及galera cluster集群。

支持Galera for MySQL集群，Percona Cluster或者MariaDB cluster

基于Nio实现，有效管理线程，高并发问题。

支持数据的多片自动路由与聚合，支持sum,count,max等常用的聚合函数。

支持单库内部任意join，支持跨库2表join，甚至基于caltlet的多表join。

支持通过全局表，ER关系的分片策略，实现了高效的多表join查询。

支持多租户方案。

支持分布式事务（弱xa）。

支持全局序列号，解决分布式下的主键生成问题。

分片规则丰富，插件化开发，易于扩展。

强大的web，命令行监控。

支持前端作为mysq通用代理，后端JDBC方式支持Oracle、DB2、SQL Server 、 mongodb 、巨杉。

支持密码加密

支持服务降级

支持IP白名单

支持SQL黑名单、sql注入攻击拦截

支持分表（1.6）

集群基于ZooKeeper管理，在线升级，扩容，智能优化，大数据处理（2.0开发版）。

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_142913.png)

## [1.3 Mycat官网](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_13-mycat官网)

http://www.mycat.org.cn/

## [1.4.Mycat 中的概念](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_14mycat-中的概念)

### [1.数据库中间件](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1数据库中间件)

前面讲了 Mycat 是一个开源的分布式数据库系统，但是由于真正的数据库需要存储引擎，而 Mycat 并没有

存储引擎，所以并不是完全意义的分布式数据库系统。

那么 Mycat 是什么？Mycat 是数据库中间件，就是介于数据库与应用之间，进行数据处理与交互的中间服务。

由于前面讲的对数据进行分片处理之后，从原有的一个库，被切分为多个分片数据库，所有的分片数据库集群构

成了整个完整的数据库存储。

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_150548.png)

如上图所表示，数据被分到多个分片数据库后，应用如果需要读取数据，就要需要处理多个数据源的数据。

如果没有数据库中间件，那么应用将直接面对分片集群，数据源切换、事务处理、数据聚合都需要应用直接处理，

原本该是专注于业务的应用，将会花大量的工作来处理分片后的问题，最重要的是每个应用处理将是完全的重复

造轮子。

所以有了数据库中间件，应用只需要集中与业务处理，大量的通用的数据聚合，事务，数据源切换都由中间

件来处理，中间件的性能与处理能力将直接决定应用的读写性能，所以一款好的数据库中间件至关重要。

### [2.逻辑库(schema)](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2逻辑库schema)

前面一节讲了数据库中间件，通常对实际应用来说，并不需要知道中间件的存在，业务开发人员只需要知道

数据库的概念，所以数据库中间件可以被看做是一个或多个数据库集群构成的逻辑库。

在云计算时代，数据库中间件可以以多租户的形式给一个或多个应用提供服务，每个应用访问的可能是一个

独立或者是共享的物理库，常见的如阿里云数据库服务器 RDS。

![img](https://jshand.gitee.io/imgs/mycat/2021-06-19_172151.png)

### [3.逻辑表（table）](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3逻辑表（table）)

> 逻辑表

既然有逻辑库，那么就会有逻辑表，分布式数据库中，对应用来说，读写数据的表就是逻辑表。逻辑表，可

以是数据切分后，分布在一个或多个分片库中，也可以不做数据切分，不分片，只有一个表构成。

> 分片表

分片表，是指那些原有的很大数据的表，需要切分到多个数据库的表，这样，每个分片都有一部分数据，所

有分片构成了完整的数据。

例如在 mycat 配置中的 t_node 就属于分片表，数据按照规则被分到 dn1,dn2 两个分片节点(dataNode)上。

```xml
<table name="t_node" primaryKey="vid" autoIncrement="true" dataNode="dn1,dn2" rule="rule1" />
```

> 非分片表

一个数据库中并不是所有的表都很大，某些表是可以不用进行切分的，非分片是相对分片表来说的，就是那

些不需要进行数据切分的表。

如下配置中 t_node，只存在于分片节点（dataNode）dn1 上。

```xml
<table name="t_node" primaryKey="vid" autoIncrement="true" dataNode="dn1" />
```

> ER 表

关系型数据库是基于实体关系模型（Entity-Relationship Model)之上，通过其描述了真实世界中事物与关系，

Mycat 中的 ER 表即是来源于此。根据这一思路，提出了基于 E-R 关系的数据分片策略，子表的记录与所关联的

父表记录存放在同一个数据分片上，即子表依赖于父表，通过表分组（Table Group）保证数据 Join 不会跨库操

作。

表分组（Table Group）是解决跨分片数据 join 的一种很好的思路，也是数据切分规划的重要一条规则。

> 全局表

一个真实的业务系统中，往往存在大量的类似字典表的表，这些表基本上很少变动，字典表具有以下几个特

性：

• 变动不频繁；

• 数据量总体变化不大；

• 数据规模不大，很少有超过数十万条记录。

对于这类的表，在分片的情况下，当业务表因为规模而进行分片以后，业务表与这些附属的字典表之间的关

联，就成了比较棘手的问题，所以 Mycat 中通过数据冗余来解决这类表的 join，即所有的分片都有一份数据的拷

贝，所有将字典表或者符合字典表特性的一些表定义为全局表。

数据冗余是解决跨分片数据 join 的一种很好的思路，也是数据切分规划的另外一条重要规则。

### [4.分片节点(dataNode)](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_4分片节点datanode)

数据切分后，一个大表被分到不同的分片数据库上面，每个表分片所在的数据库就是分片节点（dataNode）。

### [5.节点主机(dataHost)](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_5节点主机datahost)

数据切分后，每个分片节点（dataNode）不一定都会独占一台机器，同一机器上面可以有多个分片数据库，

这样一个或多个分片节点（dataNode）所在的机器就是节点主机（dataHost）,为了规避单节点主机并发数限制，

尽量将读写压力高的分片节点（dataNode）均衡的放在不同的节点主机（dataHost）。

### [6. 分片规则(rule)](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_6-分片规则rule)

前面讲了数据切分，一个大表被分成若干个分片表，就需要一定的规则，这样按照某种业务规则把数据分到

某个分片的规则就是分片规则，数据切分选择合适的分片规则非常重要，将极大的避免后续数据处理的难度。

### [7 全局序列号(sequence)](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_7-全局序列号sequence)

数据切分后，原有的关系数据库中的主键约束在分布式条件下将无法使用，因此需要引入外部机制保证数据

唯一性标识，这种保证全局性的数据唯一标识的机制就是全局序列号（sequence）。

### [8. 多租户](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_8-多租户)

多租户技术或称多重租赁技术，是一种软件架构技术，它是在探讨与实现如何于多用户的环境下共用相同的

系统或程序组件，并且仍可确保各用户间数据的隔离性。在云计算时代，多租户技术在共用的数据中心以单一系

统架构与服务提供多数客户端相同甚至可定制化的服务，并且仍然可以保障客户的数据隔离。目前各种各样的云

计算服务就是这类技术范畴，例如阿里云数据库服务（RDS）、阿里云服务器等等。

多租户在数据存储上存在三种主要的方案，分别是：

> 独立数据库

这是第一种方案，即一个租户一个数据库，这种方案的用户数据隔离级别最高，安全性最好，但成本也高。

**优点：**

为不同的租户提供独立的数据库，有助于简化数据模型的扩展设计，满足不同租户的独特需求；

如果出现故障，恢复数据比较简单。

**缺点：**

增大了数据库的安装数量，随之带来维护成本和购置成本的增加。

这种方案与传统的一个客户、一套数据、一套部署类似，差别只在于软件统一部署在运营商那里。如果面对

的是银行、医院等需要非常高数据隔离级别的租户，可以选择这种模式，提高租用的定价。如果定价较低，产品

走低价路线，这种方案一般对运营商来说是无法承受的。

> 共享数据库，隔离数据架构

这是第二种方案，即多个或所有租户共享 Database，但是每个租户一个 Schema。

**优点：**

为安全性要求较高的租户提供了一定程度的逻辑数据隔离，并不是完全隔离；每个数据库可以支持更多的租

户数量。

**缺点：**

如果出现故障，数据恢复比较困难，因为恢复数据库将牵扯到其他租户的数据；

38 如果需要跨租户统计数据，存在一定困难。

> 共享数据库，共享数据架构

这是第三种方案，即租户共享同一个 Database、同一个 Schema，但在表中通过 TenantID 区分租户的数据。

这是共享程度最高、隔离级别最低的模式。

**优点：**

三种方案比较，第三种方案的维护和购置成本最低，允许每个数据库支持的租户数量最多。

**缺点：**

隔离级别最低，安全性最低，需要在设计开发时加大对安全的开发量；

数据备份和恢复最困难，需要逐表逐条备份和还原；

如果希望以最少的服务器为最多的租户提供服务，并且租户接受以牺牲隔离级别换取降低成本，这种方案最

适合。

![img](https://jshand.gitee.io/imgs/mycat/2021-06-19_172655.png)

# [2.数据库中间件对比](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2数据库中间件对比)

## [2.1 COBAR:](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_21-cobar)

阿里巴巴B2B开发的关系型分布式系统，管理将近3000个MySQL实例。 在阿里经受住了考验，后面由于作者的走开的原因cobar没有人维护 了，阿里也开发了tddl替代cobar。

## [2.2 MYCAT:](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_22-mycat)

社区爱好者在阿里cobar基础上进行二次开发，解决了cobar当时存 在的一些问题，并且加入了许多新的功能在其中。目前MyCAT社区活 跃度很高，目前已经有一些公司在使用MyCAT。总体来说支持度比 较高，也会一直维护下去，

## [2.3 ONEPROXY:](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_23-oneproxy)

数据库界大牛，前支付宝数据库团队领导楼总开发，基于mysql官方 的proxy思想利用c进行开发的，OneProxy是一款商业收费的中间件， 楼总舍去了一些功能点，专注在性能和稳定性上。有朋友测试过说在 高并发下很稳定。

## [2.4 VITESS:](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_24-vitess)

这个中间件是Youtube生产在使用的，但是架构很复杂。 与以往中间件不同，使用Vitess应用改动比较大要 使用他提供语言的API接口，我们可以借鉴他其中的一些设计思想。

## [2.5 KINGSHARD:](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_25-kingshard)

Kingshard是前360Atlas中间件开发团队的陈菲利用业务时间 用go语言开发的，目前参与开发的人员有3个左右， 目前来看还不是成熟可以使用的产品，需要在不断完善。

## [2.6 ATLAS:](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_26-atlas)

360团队基于Mysql proxy 把lua用C改写。原有版本是支持分表， 目前已经放出了分库分表版本。在网上看到一些朋友经常说在高并 发下会经常挂掉，如果大家要使用需要提前做好测试。

## [2.7 MAXSCALE:](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_27-maxscale)

MaxScale是mariadb (MySQL原作者维护的一个版本)研发的，目前版本不支持分库分表。

## [2.8 MySQL Route](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_28-mysql-route)

MySQL Route是现在MySQL 官方Oracle公司发布出来的一个中间件。

# [3.Mycat作用](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3mycat作用)

最简单的Mycat应用架构

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_145431.png)

## [3.1 读写分离](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_31-读写分离)

- 需要主从复制

读写分离，基本的原理是让主数据库处理事务性增、改、删操作（INSERT、UPDATE、DELETE），而从数据库处理SELECT查询操作。数据库复制被用来把事务性操作导致的变更同步到集群中的从数据库。

## [3.2 数据分片](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_32-数据分片)

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_150548.png)

- 垂直拆分--分库

  - 指的是将一个包含了很多表的数据库,根据表的功能的不同,拆分为多个小的数据库,每个库中包含部分表。

    比如：电商系统采用的库为db_eshop,根据用户功能和产品功能,可以拆分为用户库db_user和产品库db_product。

- 水平拆分--分表

  - 相对于垂直拆分，水平拆分不是将表做分类，而是按照某个字段的某种规则来分散到多个库之中，

    每个表中 包含一部分数据。

    简单来说，我们可以将数据的水平切分理解为是按照数据行的切分，就

    是将表中的某些行切分 到一个数据库，而另外的某些行又切分到其他的数据库中

## [3.3 多数据源整合](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_33-多数据源整合)

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_145004.png)

# [4.Mycat原理](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_4mycat原理)

Mycat的原理中最重要的一个动词是“拦截”，它拦截了用户发送过来的SQL语句，首先对SQL语句做了一些特定的分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此SQL发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_151450.png)

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_143006.png)

# [5.数据库准备](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_5数据库准备)

https://www.cnblogs.com/gl-developer/p/6170423.html

docker 安装两个数据库并设置主从备份

## [1.创建数据库配置文件](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1创建数据库配置文件)

因为实验室机房限制无法准备多个机器，此处使用docker创建数据库模拟多个机器，可以在宿主机上创建配置文件目录，本次采用如下两个s目录用于存放配置文件

- Master：/root/db1/my.cnf
- Slave： /root/db2/my.cnf

> Master配置文件如下：

```conf
[mysqld]
## 同一局域网内注意要唯一
server-id=100  
## 开启二进制日志功能，可以随便取（关键）
log-bin=mysql-bin
```

> Slave配置文件如下：

和配置Master(主)一样，在Slave配置文件my.cnf中添加如下配置：

```cnf
[mysqld]
## 设置server_id,注意要唯一
server-id=101  

## 开启二进制日志功能，以备Slave作为其它Slave的Master时使用
log-bin=mysql-slave-bin

## relay_log配置中继日志
relay_log=edu-mysql-relay-bin  
```

## [2 拉取镜像并创建数据库](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2-拉取镜像并创建数据库)

- docker pull mysql:5.7
- docker run --name db1 -p 3316:3306 -v /root/db1/my.cnf:/etc/mysql/my.cnf -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7
- docker run --name db2 -p 3326:3306 -v /root/db2/my.cnf:/etc/mysql/my.cnf -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7

```bash
[root@mycat ~]# docker pull mysql:5.7
5.7: Pulling from library/mysql

69692152171a: Pull complete 
1651b0be3df3: Pull complete 
951da7386bc8: Pull complete 
0f86c95aa242: Pull complete 
37ba2d8bd4fe: Pull complete 
6d278bb05e94: Pull complete 
497efbd93a3e: Pull complete 
a023ae82eef5: Pull complete 
e76c35f20ee7: Pull complete 
e887524d2ef9: Pull complete 
ccb65627e1c3: Pull complete 
Digest: sha256:a682e3c78fc5bd941e9db080b4796c75f69a28a8cad65677c23f7a9f18ba21fa
Status: Downloaded newer image for mysql:5.7
docker.io/library/mysql:5.7

[root@mycat db1]# docker run --name db1 -p 3316:3306 -v /root/db1/my.cnf:/etc/mysql/my.cnf -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7
9eb8623c5497eb8abb16494e1820095043fb00ac69a8ec15646176e88372ba3d
[root@mycat db1]# docker run --name db2 -p 3326:3306 -v /root/db2/my.cnf:/etc/mysql/my.cnf -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7
81acbc129d8317d152dcceeed1140c6948d40c25c7c8cacfaf30788e0239a63f
[root@mycat db1]# docker ps
CONTAINER ID   IMAGE       COMMAND                  CREATED          STATUS          PORTS                                                  NAMES
81acbc129d83   mysql:5.7   "docker-entrypoint.s…"   5 seconds ago    Up 2 seconds    33060/tcp, 0.0.0.0:3326->3306/tcp, :::3326->3306/tcp   db2
9eb8623c5497   mysql:5.7   "docker-entrypoint.s…"   19 seconds ago   Up 17 seconds   33060/tcp, 0.0.0.0:3316->3306/tcp, :::3316->3306/tcp   db1
```

Master对外映射的端口是3316，Slave对外映射的端口是3326。因为docker容器是相互独立的，每个容器有其独立的ip，所以不同容器使用相同的端口并不会冲突。

## [3 使用客户端工具测试](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3-使用客户端工具测试)

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_161005.png)

## [4.MySQL主从复制原理](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_4mysql主从复制原理)

### [**1、为什么需要主从复制？**](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1、为什么需要主从复制？)

1、在业务复杂的系统中，有这么一个情景，有一句sql语句需要锁表，导致暂时不能使用读的服务，那么就很影响运行中的业务，使用主从复制，让主库负责写，从库负责读，这样，即使主库出现了锁表的情景，通过读从库也可以保证业务的正常运作。

2、做数据的热备

3、架构的扩展。业务量越来越大，I/O访问频率过高，单机无法满足，此时做多库的存储，降低磁盘I/O访问的频率，提高单个机器的I/O性能。

### [2、什么是mysql的主从复制？](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2、什么是mysql的主从复制？)

MySQL 主从复制是指数据可以从一个MySQL数据库服务器主节点复制到一个或多个从节点。MySQL 默认采用异步复制方式，这样从节点不用一直访问主服务器来更新自己的数据，数据的更新可以在远程连接上进行，从节点可以复制主数据库中的所有数据库或者特定的数据库，或者特定的表。

### [**3、mysql复制原理**](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3、mysql复制原理)

**原理：**

（1）master服务器将数据的改变记录二进制binlog日志，当master上的数据发生改变时，则将其改变写入二进制日志中；

（2）slave服务器会在一定时间间隔内对master二进制日志进行探测其是否发生改变，如果发生改变，则开始一个I/OThread请求master二进制事件

（3）同时主节点为每个I/O线程启动一个dump线程，用于向其发送二进制事件，并保存至从节点本地的中继日志中，从节点将启动SQL线程从中继日志中读取二进制日志，在本地重放，使得其数据和主节点的保持一致，最后I/OThread和SQLThread将进入睡眠状态，等待下一次被唤醒。

**也就是说：**

- 从库会生成两个线程,一个I/O线程,一个SQL线程;
- I/O线程会去请求主库的binlog,并将得到的binlog写到本地的relay-log(中继日志)文件中;
- 主库会生成一个log dump线程,用来给从库I/O线程传binlog;
- SQL线程,会读取relay log文件中的日志,并解析成sql语句逐一执行;

**注意：**

1--master将操作语句记录到binlog日志中，然后授予slave远程连接的权限（master一定要开启binlog二进制日志功能；通常为了数据安全考虑，slave也开启binlog功能）。

2--slave开启两个线程：IO线程和SQL线程。其中：IO线程负责读取master的binlog内容到中继日志relay log里；SQL线程负责从relay log日志里读出binlog内容，并更新到slave的数据库里，这样就能保证slave数据和master数据保持一致了。

3--Mysql复制至少需要两个Mysql的服务，当然Mysql服务可以分布在不同的服务器上，也可以在一台服务器上启动多个服务。

4--Mysql复制最好确保master和slave服务器上的Mysql版本相同（如果不能满足版本一致，那么要保证master主节点的版本低于slave从节点的版本）

5--master和slave两节点间时间需同步

### [4、延时问题](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_4、延时问题)

mysql的主从复制都是单线程的操作，主库对所有DDL和DML产生的日志写进binlog，由于binlog是顺序写，所以效率很高，slave的sql thread线程将主库的DDL和DML操作事件在slave中重放。DML和DDL的IO操作是随机的，不是顺序，所以成本要高很多，另一方面，由于sql thread也是单线程的，当主库的并发较高时，产生的DML数量超过slave的SQL thread所能处理的速度，或者当slave中有大型query语句产生了锁等待，那么延时就产生了。

> 解决方案：

1.业务的持久化层的实现采用分库架构，mysql服务可平行扩展，分散压力。

2.单个库读写分离，一主多从，主写从读，分散压力。这样从库压力比主库高，保护主库。

3.服务的基础架构在业务和mysql之间加入memcache或者redis的cache层。降低mysql的读压力。

4.不同业务的mysql物理上放在不同机器，分散压力。

5.使用比主库更好的硬件设备作为slave，mysql压力小，延迟自然会变小。

6.使用更加强劲的硬件设备

![img](https://jshand.gitee.io/imgs/mycat/master-slave.jpg)

![img](https://jshand.gitee.io/course/internet_arch/)

## [5 配置主从复制](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_5-配置主从复制)

在Master数据库创建数据同步用户，授予用户 slave REPLICATION SLAVE权限和REPLICATION CLIENT权限，用于在主从库之间同步数据。

通过`docker exec -it db1 /bin/bash`命令进入到Master容器内部执行mysql客户端执行如下脚本。

```sql
CREATE USER 'slave'@'%' IDENTIFIED BY '123456';
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'slave'@'%';
```

在Master进入mysql，执行`show master status;`

```bash
mysql> show master status  ;
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000003 |      617 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
1 row in set (0.01 sec)
```

File和Position字段的值后面将会用到，在后面的操作完成之前，需要保证Master库不能做任何操作，否则将会引起状态变化，File和Position字段的值变化。

退出master数据库，回到宿主机执行docker命令查看两个容器的ip

```bash
mysql> exit
Bye
root@9eb8623c5497:/# exit
exit

[root@mycat ~]# docker inspect --format '{{ .NetworkSettings.IPAddress }}'  db1 
172.17.0.2

[root@mycat ~]# docker inspect --format '{{ .NetworkSettings.IPAddress }}'  db2
172.17.0.3
[root@mycat ~]# 
```

在Slave 中进入 mysql，执行`change master to master_host='172.17.0.2',  master_user='slave', master_password='123456', master_port=3306,  master_log_file='mysql-bin.000001', master_log_pos= 2830,  master_connect_retry=30;`

**命令说明：**

**master_host** ：Master机器的地址，此处指的是容器的独立ip(**生产上应该是Master机器的ip**),可以通过如下命令查询容器的ip

```bash
docker inspect --format='{{.NetworkSettings.IPAddress}}' 容器名称|容器id
```

**master_port**：Master的端口号，指的是容器的端口号

**master_user**：用于数据同步的用户

**master_password**：用于同步的用户的密码

**master_log_file**：指定 Slave 从哪个日志文件开始复制数据，即上文中提到的 File 字段的值

**master_log_pos**：从哪个 Position 开始读，即上文中提到的 Position 字段的值

**master_connect_retry**：如果连接失败，重试的时间间隔，单位是秒，默认是60秒

在Slave 中的mysql终端执行`show slave status \G;`用于查看主从同步状态。

```bash
[root@mycat ~]# docker exec -it db2 /bin/bash
root@81acbc129d83:/# mysql -u root -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 6
Server version: 5.7.34-log MySQL Community Server (GPL)

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> change master to master_host='172.17.0.2', master_user='slave', master_password='123456', master_port=3306, master_log_file='mysql-bin.000003', master_log_pos= 617, master_connect_retry=30;
Query OK, 0 rows affected, 2 warnings (0.02 sec)

mysql> show slave status \G;
*************************** 1. row ***************************
               Slave_IO_State: 
                  Master_Host: 172.17.0.2
                  Master_User: slave
                  Master_Port: 3306
                Connect_Retry: 30
              Master_Log_File: mysql-bin.000003
          Read_Master_Log_Pos: 617
               Relay_Log_File: edu-mysql-relay-bin.000001
                Relay_Log_Pos: 4
        Relay_Master_Log_File: mysql-bin.000003
             Slave_IO_Running: No
            Slave_SQL_Running: No
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 617
              Relay_Log_Space: 154
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: NULL
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 0
                  Master_UUID: 
             Master_Info_File: /var/lib/mysql/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: 
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)

ERROR: 
No query specified

mysql> 
```

正常情况下，SlaveIORunning 和 SlaveSQLRunning 都是No，因为我们还没有开启主从复制过程。使用`start slave`开启主从复制过程，然后再次查询主从同步状态`show slave status \G;`。

```bash
mysql> start slave ;
Query OK, 0 rows affected (0.00 sec)

mysql> show slave status \G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 172.17.0.2
                  Master_User: slave
                  Master_Port: 3306
                Connect_Retry: 30
              Master_Log_File: mysql-bin.000003
          Read_Master_Log_Pos: 617
               Relay_Log_File: edu-mysql-relay-bin.000002
                Relay_Log_Pos: 320
        Relay_Master_Log_File: mysql-bin.000003
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 617
              Relay_Log_Space: 531
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 100
                  Master_UUID: 0be39b8d-ccec-11eb-9573-0242ac110002
             Master_Info_File: /var/lib/mysql/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)

ERROR: 
No query specified

mysql> 
```

SlaveIORunning 和 SlaveSQLRunning 都是Yes，说明主从复制已经开启。此时可以测试数据同步是否成功。

使用`start slave`开启主从复制过程后，如果SlaveIORunning一直是Connecting，则说明主从复制一直处于连接状态，这种情况一般是下面几种原因造成的，我们可以根据 Last_IO_Error提示予以排除。

1. 网络不通

   检查ip,端口

2. 密码不对

   检查是否创建用于同步的用户和用户密码是否正确

3. pos不对

   检查Master的 Position

## [6.测试主从复制](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_6测试主从复制)

测试主从复制方式就十分多了，最简单的是在Master创建一个数据库，然后检查Slave是否存在此数据库。

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_165741.png)

## [7.安装在宿主机上安装mysql客户端，测试连通性](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_7安装在宿主机上安装mysql客户端，测试连通性)

- yum install -y mysql
- mysql -uroot -p123456 -h 172.17.0.2 -P 3306
- mysql -uroot -p123456 -h 172.17.0.3 -P 3306

```bash
[root@mycat bin]# yum install mysql
已加载插件：fastestmirror, langpacks
Loading mirror speeds from cached hostfile
 * epel: mirrors.neusoft.edu.cn
base                                                                                                                                                                    | 3.6 kB  00:00:00     
docker-ce-stable                                                                                                                                                        | 3.5 kB  00:00:00     
extras                                                                                                                                                                  | 2.9 kB  00:00:00     
updates                                                                                                                                                                 | 2.9 kB  00:00:00     
(1/2): extras/7/x86_64/primary_db                                                                                                                                       | 242 kB  00:00:00     
(2/2): updates/7/x86_64/primary_db                                                                                                                                      | 8.8 MB  00:00:01     
正在解决依赖关系
There are unfinished transactions remaining. You might consider running yum-complete-transaction, or "yum-complete-transaction --cleanup-only" and "yum history redo last", first to finish them. If those don't work you'll have to try removing/installing packages by hand (maybe package-cleanup can help).
--> 正在检查事务
---> 软件包 mariadb.x86_64.1.5.5.68-1.el7 将被 安装
--> 解决依赖关系完成

依赖关系解决

===============================================================================================================================================================================================
 Package                                      架构                                        版本                                                 源                                         大小
===============================================================================================================================================================================================
正在安装:
 mariadb                                      x86_64                                      1:5.5.68-1.el7                                       base                                      8.8 M

事务概要
===============================================================================================================================================================================================
安装  1 软件包

总下载量：8.8 M
安装大小：49 M
Is this ok [y/d/N]: y
Downloading packages:
mariadb-5.5.68-1.el7.x86_64.rpm                                                                                                                                         | 8.8 MB  00:00:01     
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  正在安装    : 1:mariadb-5.5.68-1.el7.x86_64                                                                                                                                              1/1 
  验证中      : 1:mariadb-5.5.68-1.el7.x86_64                                                                                                                                              1/1 

已安装:
  mariadb.x86_64 1:5.5.68-1.el7                                                                                                                                                                

完毕！
[root@mycat bin]# mysql -uroot -p123456 -h 172.17.0.2 -P 3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 11
Server version: 5.7.34-log MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| testdb             |
+--------------------+
5 rows in set (0.00 sec)

MySQL [(none)]> exit
Bye
[root@mycat bin]# mysql -uroot -p123456 -h 172.17.0.3 -P 3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 14
Server version: 5.7.34-log MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| testdb             |
+--------------------+
5 rows in set (0.00 sec)

MySQL [(none)]> 
```

# [6.Mycat安装启动](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_6mycat安装启动)

Mycat使用Java编写，所以需要优先安装jdk，此处略过,本文使用版本如下：

- jdk 1.8
- MyCat Mycat-server-1.6-RELEASE-20161028204710-linux

> 如果未安装jdk，请提前下载：

https://www.oracle.com/cn/java/technologies/javase/javase8-archive-downloads.html

## [6.1下载解压](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_61下载解压)

官网下载地址：http://dl.mycat.org.cn/

官网中选择对应平台及版本的压缩包：

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_215156.png)

切换到/opt目录，使用wget 下载压缩包

```bash
[root@mycat ~]# cd /opt/

[root@mycat opt]# wget http://dl.mycat.org.cn/1.6-RELEASE/Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz
--2021-06-14 21:54:21--  http://dl.mycat.org.cn/1.6-RELEASE/Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz
正在解析主机 dl.mycat.org.cn (dl.mycat.org.cn)... 210.51.26.184
正在连接 dl.mycat.org.cn (dl.mycat.org.cn)|210.51.26.184|:80... 已连接。
已发出 HTTP 请求，正在等待回应... 200 OK
长度：15662280 (15M) [application/octet-stream]
正在保存至: “Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz”

100%[=====================================================================================================================================================>] 15,662,280  4.18MB/s 用时 4.5s   

2021-06-14 21:54:26 (3.32 MB/s) - 已保存 “Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz” [15662280/15662280])

[root@mycat opt]# ll |grep My
-rw-r--r--. 1 root root  15662280 10月 28 2016 Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz
[root@mycat opt]# tar -zxvf Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz 
mycat/bin/wrapper-linux-ppc-64
mycat/bin/wrapper-linux-x86-64
mycat/bin/wrapper-linux-x86-32
mycat/bin/mycat
mycat/lib/zookeeper-3.4.6.jar
mycat/lib/jline-0.9.94.jar
mycat/lib/ehcache-core-2.6.11.jar
mycat/lib/log4j-1.2.17.jar
mycat/lib/fastjson-1.2.12.jar
mycat/lib/curator-client-2.11.0.jar
mycat/lib/joda-time-2.9.3.jar
mycat/lib/log4j-slf4j-impl-2.5.jar
mycat/lib/libwrapper-linux-x86-32.so
mycat/lib/netty-3.7.0.Final.jar
mycat/lib/druid-1.0.26.jar
mycat/lib/log4j-api-2.5.jar
mycat/lib/mapdb-1.0.7.jar
mycat/lib/slf4j-api-1.6.1.jar
mycat/lib/univocity-parsers-2.2.1.jar
mycat/lib/hamcrest-core-1.3.jar
mycat/lib/Mycat-server-1.6-RELEASE.jar
mycat/lib/objenesis-1.2.jar
mycat/lib/leveldb-api-0.7.jar
mycat/lib/hamcrest-library-1.3.jar
mycat/lib/wrapper.jar
mycat/lib/commons-lang-2.6.jar
mycat/lib/reflectasm-1.03.jar
mycat/lib/mongo-java-driver-2.11.4.jar
mycat/lib/guava-19.0.jar
mycat/lib/curator-recipes-2.11.0.jar
mycat/lib/curator-framework-2.11.0.jar
mycat/lib/libwrapper-linux-ppc-64.so
mycat/lib/log4j-core-2.5.jar
mycat/lib/leveldb-0.7.jar
mycat/lib/sequoiadb-driver-1.12.jar
mycat/lib/mysql-binlog-connector-java-0.4.1.jar
mycat/lib/kryo-2.10.jar
mycat/lib/jsr305-2.0.3.jar
mycat/lib/commons-collections-3.2.1.jar
mycat/lib/disruptor-3.3.4.jar
mycat/lib/log4j-1.2-api-2.5.jar
mycat/lib/velocity-1.7.jar
mycat/lib/libwrapper-linux-x86-64.so
mycat/lib/dom4j-1.6.1.jar
mycat/lib/minlog-1.2.jar
mycat/lib/asm-4.0.jar
mycat/conf/wrapper.conf
mycat/conf/
mycat/conf/zkconf/
mycat/conf/zkdownload/
mycat/conf/sequence_time_conf.properties
mycat/conf/sharding-by-enum.txt
mycat/conf/migrateTables.properties
mycat/conf/zkconf/sequence_time_conf.properties
mycat/conf/zkconf/sharding-by-enum.txt
mycat/conf/zkconf/ehcache.xml
mycat/conf/zkconf/index_to_charset.properties
mycat/conf/zkconf/partition-range-mod.txt
mycat/conf/zkconf/sequence_db_conf.properties
mycat/conf/zkconf/sequence_time_conf-mycat_fz_01.properties
mycat/conf/zkconf/cacheservice.properties
mycat/conf/zkconf/partition-hash-int.txt
mycat/conf/zkconf/autopartition-long.txt
mycat/conf/zkconf/server-mycat_fz_01.xml
mycat/conf/zkconf/auto-sharding-long.txt
mycat/conf/zkconf/rule.xml
mycat/conf/zkconf/auto-sharding-rang-mod.txt
mycat/conf/zkconf/sequence_distributed_conf.properties
mycat/conf/zkconf/sequence_distributed_conf-mycat_fz_01.properties
mycat/conf/zkconf/sequence_conf.properties
mycat/conf/zkconf/schema.xml
mycat/conf/zkconf/server.xml
mycat/conf/ehcache.xml
mycat/conf/index_to_charset.properties
mycat/conf/partition-range-mod.txt
mycat/conf/sequence_db_conf.properties
mycat/conf/cacheservice.properties
mycat/conf/partition-hash-int.txt
mycat/conf/autopartition-long.txt
mycat/conf/auto-sharding-long.txt
mycat/conf/rule.xml
mycat/conf/auto-sharding-rang-mod.txt
mycat/conf/sequence_distributed_conf.properties
mycat/conf/sequence_conf.properties
mycat/conf/myid.properties
mycat/conf/schema.xml
mycat/conf/zkdownload/auto-sharding-long.txt
mycat/conf/server.xml
mycat/version.txt
mycat/conf/log4j2.xml
mycat/bin/init_zk_data.sh
mycat/bin/startup_nowrap.sh
mycat/bin/dataMigrate.sh
mycat/bin/rehash.sh
mycat/logs/
mycat/catlet/

[root@mycat opt]# ll
总用量 30352
drwx--x--x. 4 root  root        28 6月   6 10:02 containerd
drwxr-xr-x. 5 10143 10143      129 4月   8 03:26 jdk1.8.0_291
-rw-r--r--. 1 root  root   2641920 5月  26 09:19 jdk-8u291-linux-x64.tar.gz
drwxr-xr-x. 7 root  root        85 6月  14 17:04 mycat
-rw-r--r--. 1 root  root  26030477 3月   3 08:54 Mycat-server-1.6.7.6-release-20210303094759-linux.tar.gz
-rwxrwxrwx. 2 root  root    397618 5月  26 13:40 nmon_x86_64_centos7
drwxrwxr-x. 6 root  root      4096 3月   2 14:11 redis-5.0.12
-rw-r--r--. 1 root  root   1995069 3月   2 14:22 redis-5.0.12.tar.gz
drwxr-xr-x. 2 root  root         6 10月 31 2018 rh
[root@mycat opt]# 
```

## [6.2 文件复制](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_62-文件复制)

> 将解压后的目录copy到 /usr/local目录中

```bash
[root@mycat opt]# cp -r mycat/ /usr/local/

[root@mycat opt]# ls /usr/local/
bin  etc  games  include  lib  lib64  libexec  mycat  sbin  share  src
[root@mycat opt]# 
```

> 查看mycat目录及mycat的配置文件目录

```bash
[root@mycat opt]# cd /usr/local/mycat/
[root@mycat mycat]# ls
bin  catlet  conf  lib  logs  version.txt
[root@mycat mycat]# cd conf/
[root@mycat conf]# ls
autopartition-long.txt       rule.xml
auto-sharding-long.txt       schema.xml
auto-sharding-rang-mod.txt   schema.xml.bak
cacheservice.properties      sequence_conf.properties
dbseq.sql                    sequence_db_conf.properties
dbseq - utf8mb4.sql          sequence_distributed_conf.properties
dnindex.properties           sequence_http_conf.properties
ehcache.xml                  sequence_time_conf.properties
index_to_charset.properties  server.xml
log4j2.xml                   server.xml.bak
migrateTables.properties     sharding-by-enum.txt
myid.properties              wrapper.conf
partition-hash-int.txt       zkconf
partition-range-mod.txt      zkdownload
[root@mycat conf]# 
```

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_170936.png)

其中主要的几个配置文件如下：

- **server.xml**：是Mycat服务器参数调整和用户授权的配置文件。
- **schema.xml**：是逻辑库定义和表以及分片定义的配置文件。
- **rule.xml**： 是分片规则的配置文件，分片规则的具体一些参数信息单独存放为文件，也在这个目录下，配置文件修改需要重启MyCAT。
- log4j.xml： 日志存放在logs/log中，每天一个文件，日志的配置是在conf/log4j.xml中，根据自己的需要可以调整输出级别为debug
  - debug级别下，会输出更多的信息，方便排查问题。
- autopartition-long.txt,partition-hash-int.txt,sequence_conf.properties， sequence_db_conf.properties 分片相关的id分片规则配置文件
- lib MyCAT自身的jar包或依赖的jar包的存放目录。
- logs MyCAT日志的存放目录。日志存放在logs/log中，每天一个文件

## [6.3 配置](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_63-配置)

需要安装jdk，修改jdk环境，即编辑 /usr/local/mycat/conf/wrapper.conf

```bash
 vi /usr/local/mycat/conf/wrapper.conf 
```

配合java命令绝对路径

```bash
wrapper.java.command=/opt/jdk1.8.0_291/bin/java
```

> 配置mycat 和mysql数据库连接等信息

### [1.修改server.xml](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1修改serverxml)

修改user用户信息

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_174246.png)

完整的配置文件如下：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!-- - - Licensed under the Apache License, Version 2.0 (the "License"); 
    - you may not use this file except in compliance with the License. - You 
    may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0 
    - - Unless required by applicable law or agreed to in writing, software - 
    distributed under the License is distributed on an "AS IS" BASIS, - WITHOUT 
    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the 
    License for the specific language governing permissions and - limitations 
    under the License. -->
<!DOCTYPE mycat:server SYSTEM "server.dtd">
<mycat:server xmlns:mycat="http://io.mycat/">
    <system>
    <property name="useSqlStat">0</property>  <!-- 1为开启实时统计、0为关闭 -->
    <property name="useGlobleTableCheck">0</property>  <!-- 1为开启全加班一致性检测、0为关闭 -->

        <property name="sequnceHandlerType">2</property>
      <!--  <property name="useCompression">1</property>--> <!--1为开启mysql压缩协议-->
        <!--  <property name="fakeMySQLVersion">5.6.20</property>--> <!--设置模拟的MySQL版本号-->
    <!-- <property name="processorBufferChunk">40960</property> -->
    <!-- 
    <property name="processors">1</property> 
    <property name="processorExecutor">32</property> 
     -->
        <!--默认为type 0: DirectByteBufferPool | type 1 ByteBufferArena-->
        <property name="processorBufferPoolType">0</property>
        <!--默认是65535 64K 用于sql解析时最大文本长度 -->
        <!--<property name="maxStringLiteralLength">65535</property>-->
        <!--<property name="sequnceHandlerType">0</property>-->
        <!--<property name="backSocketNoDelay">1</property>-->
        <!--<property name="frontSocketNoDelay">1</property>-->
        <!--<property name="processorExecutor">16</property>-->
        <!--
            <property name="serverPort">8066</property> <property name="managerPort">9066</property> 
            <property name="idleTimeout">300000</property> <property name="bindIp">0.0.0.0</property> 
            <property name="frontWriteQueueSize">4096</property> <property name="processors">32</property> -->
        <!--分布式事务开关，0为不过滤分布式事务，1为过滤分布式事务（如果分布式事务内只涉及全局表，则不过滤），2为不过滤分布式事务,但是记录分布式事务日志-->
        <property name="handleDistributedTransactions">0</property>

            <!--
            off heap for merge/order/group/limit      1开启   0关闭
        -->
        <property name="useOffHeapForMerge">1</property>

        <!--
            单位为m
        -->
        <property name="memoryPageSize">1m</property>

        <!--
            单位为k
        -->
        <property name="spillsFileBufferSize">1k</property>

        <property name="useStreamOutput">0</property>

        <!--
            单位为m
        -->
        <property name="systemReserveMemorySize">384m</property>


        <!--是否采用zookeeper协调切换  -->
        <property name="useZKSwitch">true</property>


    </system>

    <!-- 全局SQL防火墙设置 -->
    <!-- 
    <firewall> 
       <whitehost>
          <host host="127.0.0.1" user="mycat"/>
          <host host="127.0.0.2" user="mycat"/>
       </whitehost>
       <blacklist check="false">
       </blacklist>
    </firewall>
    -->

    <user name="mycat">
        <property name="password">123456</property>
        <property name="schemas">TESTDB</property>

        <!-- 表级 DML 权限设置 -->
        <!--         
        <privileges check="false">
            <schema name="TESTDB" dml="0110" >
                <table name="tb01" dml="0000"></table>
                <table name="tb02" dml="1111"></table>
            </schema>
        </privileges>        
         -->
    </user>

    <user name="user">
        <property name="password">user</property>
        <property name="schemas">TESTDB</property>
        <property name="readOnly">true</property>
    </user>

</mycat:server>
```

### [2.修改schema.xml](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2修改schemaxml)

修改dataNode、dataHost

```xml
<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">

    <schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1">
    </schema>

    <dataNode name="dn1" dataHost="host1" database="testdb" />


    <dataHost name="host1" maxCon="1000" minCon="10" balance="2"
              writeType="0" dbType="mysql" dbDriver="native" switchType="1"  slaveThreshold="100">
        <heartbeat>select user()</heartbeat>

        <!--can have multi write hosts -->
        <writeHost host="hostM1" url="172.17.0.2:3306" user="root"   password="123456">
            <!-- can have multi read hosts -->
            <readHost host="hostS1" url="172.17.0.3:3306" user="root" password="123456" />
        </writeHost>
    </dataHost>


</mycat:schema>
```

## [6.4 启动](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_64-启动)

到mycat/bin目录执行shell脚本

- 控制台启动 ./mycat console
- 后台启动 ./mycat start

如果启动报如下错误原因是没有配置jdk

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_180341.png)

需要修改 /usr/local/mycat/conf/wrapper.conf中的java命令所在的位置

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_180543.png)

完整的启动过程如下

```bash
[root@mycat bin]# pwd
/usr/local/mycat/bin
[root@mycat bin]# ls
dataMigrate.sh  init_zk_data.sh  mycat  rehash.sh  startup_nowrap.sh  wrapper-linux-ppc-64  wrapper-linux-x86-32  wrapper-linux-x86-64
[root@mycat bin]# ./mycat 
Usage: ./mycat { console | start | stop | restart | status | dump }
[root@mycat bin]# ./mycat console
Running Mycat-server...
wrapper  | --> Wrapper Started as Console
wrapper  | Launching a JVM...
jvm 1    | Java HotSpot(TM) 64-Bit Server VM warning: ignoring option MaxPermSize=64M; support was removed in 8.0
jvm 1    | Wrapper (Version 3.2.3) http://wrapper.tanukisoftware.org
jvm 1    |   Copyright 1999-2006 Tanuki Software, Inc.  All Rights Reserved.
jvm 1    | 
jvm 1    | 2021-06-14 21:44:34,395 [INFO ][WrapperSimpleAppMain] total resouces of dataHost host1 is :2  (io.mycat.backend.datasource.PhysicalDBPool:PhysicalDBPool.java:100) 
jvm 1    | 2021-06-14 21:44:34,417 [INFO ][WrapperSimpleAppMain] create layer cache pool TableID2DataNodeCache of type encache ,default cache size 10000 ,default expire seconds18000  (io.mycat.cache.CacheService:CacheService.java:125) 
jvm 1    | 2021-06-14 21:44:34,419 [INFO ][WrapperSimpleAppMain] create child Cache: TESTDB_ORDERS for layered cache TableID2DataNodeCache, size 50000, expire seconds 18000  (io.mycat.cache.DefaultLayedCachePool:DefaultLayedCachePool.java:80) 
jvm 1    | 2021-06-14 21:44:40,604 [INFO ][WrapperSimpleAppMain] dyna class load from ./catlet,and auto check for class file modified every 60 seconds  (io.mycat.config.classloader.DynaClassLoader:DynaClassLoader.java:34) 
jvm 1    | 2021-06-14 21:44:40,605 [INFO ][WrapperSimpleAppMain] ===============================================  (io.mycat.MycatServer:MycatServer.java:266) 
jvm 1    | 2021-06-14 21:44:40,605 [INFO ][WrapperSimpleAppMain] MyCat is ready to startup ...  (io.mycat.MycatServer:MycatServer.java:267) 
jvm 1    | 2021-06-14 21:44:40,606 [INFO ][WrapperSimpleAppMain] Startup processors ...,total processors:4,aio thread pool size:8    
jvm 1    |  each process allocated socket buffer pool  bytes ,a page size:2097152  a page's chunk number(PageSize/ChunkSize) is:512  buffer page's number is:80  (io.mycat.MycatServer:MycatServer.java:279) 
jvm 1    | 2021-06-14 21:44:40,606 [INFO ][WrapperSimpleAppMain] sysconfig params:SystemConfig [processorBufferLocalPercent=100, frontSocketSoRcvbuf=1048576, frontSocketSoSndbuf=4194304, backSocketSoRcvbuf=4194304, backSocketSoSndbuf=1048576, frontSocketNoDelay=1, backSocketNoDelay=1, maxStringLiteralLength=65535, frontWriteQueueSize=2048, bindIp=0.0.0.0, serverPort=8066, managerPort=9066, charset=utf8, processors=4, processorExecutor=8, timerExecutor=2, managerExecutor=2, idleTimeout=1800000, catletClassCheckSeconds=60, sqlExecuteTimeout=300, processorCheckPeriod=1000, dataNodeIdleCheckPeriod=300000, dataNodeHeartbeatPeriod=10000, clusterHeartbeatUser=_HEARTBEAT_USER_, clusterHeartbeatPass=_HEARTBEAT_PASS_, clusterHeartbeatPeriod=5000, clusterHeartbeatTimeout=10000, clusterHeartbeatRetry=10, txIsolation=3, parserCommentVersion=50148, sqlRecordCount=10, bufferPoolPageSize=2097152, bufferPoolChunkSize=4096, bufferPoolPageNumber=80, maxResultSet=524288, bigResultSizeSqlCount=10, bufferUsagePercent=80, flowControlRejectStrategy=0, clearBigSqLResultSetMapMs=600000, defaultMaxLimit=100, sequnceHandlerType=2, sqlInterceptor=io.mycat.server.interceptor.impl.DefaultSqlInterceptor, sqlInterceptorType=select, sqlInterceptorFile=/usr/local/mycat/logs/sql.txt, mutiNodeLimitType=0, mutiNodePatchSize=100, defaultSqlParser=druidparser, usingAIO=0, packetHeaderSize=4, maxPacketSize=16777216, mycatNodeId=1]  (io.mycat.MycatServer:MycatServer.java:280) 
jvm 1    | log4j:WARN No appenders could be found for logger (io.mycat.memory.MyCatMemory).
jvm 1    | log4j:WARN Please initialize the log4j system properly.
jvm 1    | log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html#noconfig for more info.
jvm 1    | 2021-06-14 21:44:41,495 [INFO ][WrapperSimpleAppMain] using nio network handler   (io.mycat.MycatServer:MycatServer.java:381) 
jvm 1    | 2021-06-14 21:44:41,541 [INFO ][WrapperSimpleAppMain] $_MyCatManager is started and listening on 9066  (io.mycat.MycatServer:MycatServer.java:397) 
jvm 1    | 2021-06-14 21:44:41,543 [INFO ][WrapperSimpleAppMain] $_MyCatServer is started and listening on 8066  (io.mycat.MycatServer:MycatServer.java:401) 
jvm 1    | 2021-06-14 21:44:41,544 [INFO ][WrapperSimpleAppMain] ===============================================  (io.mycat.MycatServer:MycatServer.java:403) 
jvm 1    | 2021-06-14 21:44:41,544 [INFO ][WrapperSimpleAppMain] Initialize dataHost ...  (io.mycat.MycatServer:MycatServer.java:407) 
jvm 1    | 2021-06-14 21:44:41,544 [INFO ][WrapperSimpleAppMain] init backend myqsl source ,create connections total 10 for hostM1 index :0  (io.mycat.backend.datasource.PhysicalDBPool:PhysicalDBPool.java:294) 
jvm 1    | 2021-06-14 21:44:41,551 [INFO ][WrapperSimpleAppMain] no ilde connection in pool,create new connection for hostM1 of schema testdb  (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:413) 
jvm 1    | 2021-06-14 21:44:41,555 [INFO ][WrapperSimpleAppMain] no ilde connection in pool,create new connection for hostM1 of schema testdb  (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:413) 
jvm 1    | 2021-06-14 21:44:41,560 [INFO ][WrapperSimpleAppMain] no ilde connection in pool,create new connection for hostM1 of schema testdb  (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:413) 
jvm 1    | 2021-06-14 21:44:41,564 [INFO ][WrapperSimpleAppMain] no ilde connection in pool,create new connection for hostM1 of schema testdb  (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:413) 
jvm 1    | 2021-06-14 21:44:41,633 [INFO ][WrapperSimpleAppMain] no ilde connection in pool,create new connection for hostM1 of schema testdb  (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:413) 
jvm 1    | 2021-06-14 21:44:41,650 [INFO ][WrapperSimpleAppMain] no ilde connection in pool,create new connection for hostM1 of schema testdb  (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:413) 
jvm 1    | 2021-06-14 21:44:41,653 [INFO ][WrapperSimpleAppMain] no ilde connection in pool,create new connection for hostM1 of schema testdb  (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:413) 
jvm 1    | 2021-06-14 21:44:41,677 [INFO ][WrapperSimpleAppMain] no ilde connection in pool,create new connection for hostM1 of schema testdb  (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:413) 
jvm 1    | 2021-06-14 21:44:41,680 [INFO ][WrapperSimpleAppMain] no ilde connection in pool,create new connection for hostM1 of schema testdb  (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:413) 
jvm 1    | 2021-06-14 21:44:41,681 [INFO ][WrapperSimpleAppMain] no ilde connection in pool,create new connection for hostM1 of schema testdb  (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:413) 
jvm 1    | 2021-06-14 21:44:41,905 [INFO ][$_NIOREACTOR-3-RW] connected successfuly MySQLConnection [id=3, lastTime=1623678281905, user=root, schema=testdb, old shema=testdb, borrowed=true, fromSlaveDB=false, threadId=12, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.2, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.GetConnectionHandler:GetConnectionHandler.java:67) 
jvm 1    | 2021-06-14 21:44:41,905 [INFO ][$_NIOREACTOR-1-RW] connected successfuly MySQLConnection [id=1, lastTime=1623678281904, user=root, schema=testdb, old shema=testdb, borrowed=true, fromSlaveDB=false, threadId=21, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.2, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.GetConnectionHandler:GetConnectionHandler.java:67) 
jvm 1    | 2021-06-14 21:44:41,905 [INFO ][$_NIOREACTOR-2-RW] connected successfuly MySQLConnection [id=6, lastTime=1623678281905, user=root, schema=testdb, old shema=testdb, borrowed=true, fromSlaveDB=false, threadId=20, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.2, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.GetConnectionHandler:GetConnectionHandler.java:67) 
jvm 1    | 2021-06-14 21:44:41,906 [INFO ][$_NIOREACTOR-3-RW] connected successfuly MySQLConnection [id=7, lastTime=1623678281905, user=root, schema=testdb, old shema=testdb, borrowed=true, fromSlaveDB=false, threadId=17, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.2, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.GetConnectionHandler:GetConnectionHandler.java:67) 
jvm 1    | 2021-06-14 21:44:41,906 [INFO ][$_NIOREACTOR-0-RW] connected successfuly MySQLConnection [id=4, lastTime=1623678281905, user=root, schema=testdb, old shema=testdb, borrowed=true, fromSlaveDB=false, threadId=15, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.2, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.GetConnectionHandler:GetConnectionHandler.java:67) 
jvm 1    | 2021-06-14 21:44:41,906 [INFO ][$_NIOREACTOR-2-RW] connected successfuly MySQLConnection [id=2, lastTime=1623678281906, user=root, schema=testdb, old shema=testdb, borrowed=true, fromSlaveDB=false, threadId=14, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.2, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.GetConnectionHandler:GetConnectionHandler.java:67) 
jvm 1    | 2021-06-14 21:44:41,906 [INFO ][$_NIOREACTOR-1-RW] connected successfuly MySQLConnection [id=9, lastTime=1623678281906, user=root, schema=testdb, old shema=testdb, borrowed=true, fromSlaveDB=false, threadId=13, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.2, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.GetConnectionHandler:GetConnectionHandler.java:67) 
jvm 1    | 2021-06-14 21:44:41,906 [INFO ][$_NIOREACTOR-1-RW] connected successfuly MySQLConnection [id=5, lastTime=1623678281906, user=root, schema=testdb, old shema=testdb, borrowed=true, fromSlaveDB=false, threadId=19, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.2, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.GetConnectionHandler:GetConnectionHandler.java:67) 
jvm 1    | 2021-06-14 21:44:41,907 [INFO ][$_NIOREACTOR-0-RW] connected successfuly MySQLConnection [id=8, lastTime=1623678281907, user=root, schema=testdb, old shema=testdb, borrowed=true, fromSlaveDB=false, threadId=18, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.2, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.GetConnectionHandler:GetConnectionHandler.java:67) 
jvm 1    | 2021-06-14 21:44:41,909 [INFO ][$_NIOREACTOR-2-RW] connected successfuly MySQLConnection [id=10, lastTime=1623678281909, user=root, schema=testdb, old shema=testdb, borrowed=true, fromSlaveDB=false, threadId=16, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.2, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.GetConnectionHandler:GetConnectionHandler.java:67) 
jvm 1    | 2021-06-14 21:44:41,985 [INFO ][WrapperSimpleAppMain] init result :finished 10 success 10 target count:10  (io.mycat.backend.datasource.PhysicalDBPool:PhysicalDBPool.java:319) 
jvm 1    | 2021-06-14 21:44:41,986 [INFO ][WrapperSimpleAppMain] host1 index:0 init success  (io.mycat.backend.datasource.PhysicalDBPool:PhysicalDBPool.java:265) 
jvm 1    | 2021-06-14 21:44:41,986 [INFO ][WrapperSimpleAppMain] save DataHost index  host1 cur index 0  (io.mycat.MycatServer:MycatServer.java:604) 
jvm 1    | 2021-06-14 21:44:42,056 [INFO ][Timer0] create connections ,because idle connection not enough ,cur is 0, minCon is 10 for hostS1  (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:299) 
jvm 1    | 2021-06-14 21:44:42,127 [INFO ][$_NIOREACTOR-3-RW] connectionAcquired MySQLConnection [id=11, lastTime=1623678282126, user=root, schema=testdb, old shema=testdb, borrowed=false, fromSlaveDB=true, threadId=15, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.3, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.NewConnectionRespHandler:NewConnectionRespHandler.java:45) 
jvm 1    | 2021-06-14 21:44:42,149 [INFO ][$_NIOREACTOR-0-RW] connectionAcquired MySQLConnection [id=12, lastTime=1623678282149, user=root, schema=testdb, old shema=testdb, borrowed=false, fromSlaveDB=true, threadId=16, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.3, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.NewConnectionRespHandler:NewConnectionRespHandler.java:45) 
jvm 1    | 2021-06-14 21:44:42,149 [INFO ][$_NIOREACTOR-1-RW] connectionAcquired MySQLConnection [id=13, lastTime=1623678282149, user=root, schema=testdb, old shema=testdb, borrowed=false, fromSlaveDB=true, threadId=17, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.3, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.NewConnectionRespHandler:NewConnectionRespHandler.java:45) 
jvm 1    | MyCAT Server startup successfully. see logs in logs/mycat.log
jvm 1    | 2021-06-14 21:49:42,022 [INFO ][Timer1] create connections ,because idle connection not enough ,cur is 3, minCon is 10 for hostS1  (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:299) 
jvm 1    | 2021-06-14 21:49:42,040 [INFO ][$_NIOREACTOR-3-RW] connectionAcquired MySQLConnection [id=15, lastTime=1623678582039, user=root, schema=testdb, old shema=testdb, borrowed=false, fromSlaveDB=true, threadId=18, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.3, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.NewConnectionRespHandler:NewConnectionRespHandler.java:45) 
jvm 1    | 2021-06-14 21:49:42,040 [INFO ][$_NIOREACTOR-2-RW] connectionAcquired MySQLConnection [id=14, lastTime=1623678582039, user=root, schema=testdb, old shema=testdb, borrowed=false, fromSlaveDB=true, threadId=19, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.3, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.NewConnectionRespHandler:NewConnectionRespHandler.java:45) 
jvm 1    | 2021-06-14 21:49:52,518 [INFO ][$_NIOREACTOR-0-RW] [thread=$_NIOREACTOR-0-RW,class=ManagerConnection,id=1,host=127.0.0.1,port=9066,schema=null]'mycat' login success  (io.mycat.net.handler.FrontendAuthenticator:FrontendAuthenticator.java:194) 
jvm 1    | 2021-06-14 21:52:56,495 [INFO ][$_NIOREACTOR-0-RW] close connection,reason:quit cmd ,[thread=$_NIOREACTOR-0-RW,class=ManagerConnection,id=1,host=127.0.0.1,port=9066,schema=null]  (io.mycat.net.AbstractConnection:AbstractConnection.java:508) 
jvm 1    | 2021-06-14 21:54:42,022 [INFO ][Timer1] create connections ,because idle connection not enough ,cur is 5, minCon is 10 for hostS1  (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:299) 
jvm 1    | 2021-06-14 21:54:42,049 [INFO ][$_NIOREACTOR-1-RW] connectionAcquired MySQLConnection [id=16, lastTime=1623678882039, user=root, schema=testdb, old shema=testdb, borrowed=false, fromSlaveDB=true, threadId=20, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=172.17.0.3, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false]  (io.mycat.backend.mysql.nio.handler.NewConnectionRespHandler:NewConnectionRespHandler.java:45) 
```

# [7.Mycat登录](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_7mycat登录)

## [7.1 登录后台管理窗口](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_71-登录后台管理窗口)

使用`9066`端口登录后台管理窗口，此登录方式用于管理维护Mycat

```bash
[root@mycat opt]# mysql -umycat -p123456 -h 127.0.0.1 -P 9066
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (monitor)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> 
```

常用的命令

```bash
MySQL [(none)]> show @@help;
+------------------------------------------+--------------------------------------------+
| STATEMENT                                | DESCRIPTION                                |
+------------------------------------------+--------------------------------------------+
| show @@time.current                      | Report current timestamp                   |
| show @@time.startup                      | Report startup timestamp                   |
| show @@version                           | Report Mycat Server version                |
| show @@server                            | Report server status                       |
| show @@threadpool                        | Report threadPool status                   |
| show @@database                          | Report databases                           |
| show @@datanode                          | Report dataNodes                           |
| show @@datanode where schema = ?         | Report dataNodes                           |
| show @@datasource                        | Report dataSources                         |
| show @@datasource where dataNode = ?     | Report dataSources                         |
| show @@datasource.synstatus              | Report datasource data synchronous         |
| show @@datasource.syndetail where name=? | Report datasource data synchronous detail  |
| show @@datasource.cluster                | Report datasource galary cluster variables |
| show @@processor                         | Report processor status                    |
| show @@command                           | Report commands status                     |
| show @@connection                        | Report connection status                   |
| show @@cache                             | Report system cache usage                  |
| show @@backend                           | Report backend connection status           |
| show @@session                           | Report front session details               |
| show @@connection.sql                    | Report connection sql                      |
| show @@sql.execute                       | Report execute status                      |
| show @@sql.detail where id = ?           | Report execute detail status               |
| show @@sql                               | Report SQL list                            |
| show @@sql.high                          | Report Hight Frequency SQL                 |
| show @@sql.slow                          | Report slow SQL                            |
| show @@sql.resultset                     | Report BIG RESULTSET SQL                   |
| show @@sql.sum                           | Report  User RW Stat                       |
| show @@sql.sum.user                      | Report  User RW Stat                       |
| show @@sql.sum.table                     | Report  Table RW Stat                      |
| show @@parser                            | Report parser status                       |
| show @@router                            | Report router status                       |
| show @@heartbeat                         | Report heartbeat status                    |
| show @@heartbeat.detail where name=?     | Report heartbeat current detail            |
| show @@slow where schema = ?             | Report schema slow sql                     |
| show @@slow where datanode = ?           | Report datanode slow sql                   |
| show @@sysparam                          | Report system param                        |
| show @@syslog limit=?                    | Report system mycat.log                    |
| show @@white                             | show mycat white host                      |
| show @@white.set=?,?                     | set mycat white host,[ip,user]             |
| show @@directmemory=1 or 2               | show mycat direct memory usage             |
| switch @@datasource name:index           | Switch dataSource                          |
| kill @@connection id1,id2,...            | Kill the specified connections             |
| stop @@heartbeat name:time               | Pause dataNode heartbeat                   |
| reload @@config                          | Reload basic config from file              |
| reload @@config_all                      | Reload all config from file                |
| reload @@route                           | Reload route config from file              |
| reload @@user                            | Reload user config from file               |
| reload @@sqlslow=                        | Set Slow SQL Time(ms)                      |
| reload @@user_stat                       | Reset show @@sql  @@sql.sum @@sql.slow     |
| rollback @@config                        | Rollback all config from memory            |
| rollback @@route                         | Rollback route config from memory          |
| rollback @@user                          | Rollback user config from memory           |
| reload @@sqlstat=open                    | Open real-time sql stat analyzer           |
| reload @@sqlstat=close                   | Close real-time sql stat analyzer          |
| offline                                  | Change MyCat status to OFF                 |
| online                                   | Change MyCat status to ON                  |
| clear @@slow where schema = ?            | Clear slow sql by schema                   |
| clear @@slow where datanode = ?          | Clear slow sql by datanode                 |
+------------------------------------------+--------------------------------------------+
58 rows in set (0.00 sec)
```

## [7.2 登录数据访问窗口](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_72-登录数据访问窗口)

使用8066端口访问数据。

```bash
MySQL [(none)]> show databases;
+----------+
| DATABASE |
+----------+
| TESTDB   |
+----------+
1 row in set (0.01 sec)

MySQL [(none)]> use TESTDB;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MySQL [TESTDB]> show tables;
+------------------+
| Tables_in_testdb |
+------------------+
| test_table       |
+------------------+
1 row in set (0.00 sec)

MySQL [TESTDB]> 
```

## [7.3使用客户端工具连接](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_73使用客户端工具连接)

使用客户单工具如Navicat、SqlYog等工具连接同普通MySQL连接相似，

- ip：192.168.0.102
- username：mycat
- password：123456
- port：8066

> 注意
>
> 如果提示 10060错误，大部分是由于防火墙的原因，可以关闭下防火墙,Centos7命令如下：

`systemctl status firewalld` 查看防火墙状态

`systemctl stop firewalld` 停止防火墙

```bash
[root@mycat opt]# systemctl status firewalld
● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)
   Active: active (running) since 一 2021-06-14 15:45:28 CST; 6h ago
     Docs: man:firewalld(1)
 Main PID: 836 (firewalld)
    Tasks: 2
   Memory: 424.0K
   CGroup: /system.slice/firewalld.service
           └─836 /usr/bin/python2 -Es /usr/sbin/firewalld --nofork --nopid

6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -F DOCKER' failed: iptables: No chain/target/match by that name.
6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -X DOCKER' failed: iptables: No chain/target/match by that name.
6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -F DOCKER-ISOLATION-STAGE-1' failed: iptables: No chain/target/match by that name.
6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -X DOCKER-ISOLATION-STAGE-1' failed: iptables: No chain/target/match by that name.
6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -F DOCKER-ISOLATION-STAGE-2' failed: iptables: No chain/target/match by that name.
6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -X DOCKER-ISOLATION-STAGE-2' failed: iptables: No chain/target/match by that name.
6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -F DOCKER-ISOLATION' failed: iptables: No chain/target/match by that name.
6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -X DOCKER-ISOLATION' failed: iptables: No chain/target/match by that name.
6月 14 15:48:11 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -D FORWARD -i docker0 -o docker0 -j DROP' failed: iptables: Bad rule (does a matching ...that chain?).
6月 14 15:48:12 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -D FORWARD -i docker0 -o docker0 -j DROP' failed: iptables: Bad rule (does a matching ...that chain?).
Hint: Some lines were ellipsized, use -l to show in full.
[root@mycat opt]# systemctl stop firewalld
[root@mycat opt]# systemctl status firewalld
● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)
   Active: inactive (dead) since 一 2021-06-14 22:31:07 CST; 2s ago
     Docs: man:firewalld(1)
  Process: 836 ExecStart=/usr/sbin/firewalld --nofork --nopid $FIREWALLD_ARGS (code=exited, status=0/SUCCESS)
 Main PID: 836 (code=exited, status=0/SUCCESS)

6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -F DOCKER-ISOLATION-STAGE-1' failed: iptables: No chain/target/match by that name.
6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -X DOCKER-ISOLATION-STAGE-1' failed: iptables: No chain/target/match by that name.
6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -F DOCKER-ISOLATION-STAGE-2' failed: iptables: No chain/target/match by that name.
6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -X DOCKER-ISOLATION-STAGE-2' failed: iptables: No chain/target/match by that name.
6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -F DOCKER-ISOLATION' failed: iptables: No chain/target/match by that name.
6月 14 15:48:10 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -t filter -X DOCKER-ISOLATION' failed: iptables: No chain/target/match by that name.
6月 14 15:48:11 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -D FORWARD -i docker0 -o docker0 -j DROP' failed: iptables: Bad rule (does a matching ...that chain?).
6月 14 15:48:12 mycat firewalld[836]: WARNING: COMMAND_FAILED: '/usr/sbin/iptables -w10 -D FORWARD -i docker0 -o docker0 -j DROP' failed: iptables: Bad rule (does a matching ...that chain?).
6月 14 22:31:04 mycat systemd[1]: Stopping firewalld - dynamic firewall daemon...
6月 14 22:31:07 mycat systemd[1]: Stopped firewalld - dynamic firewall daemon.
Hint: Some lines were ellipsized, use -l to show in full.
[root@mycat opt]# 
```

![img](https://jshand.gitee.io/imgs/mycat/2021-06-14_223532.png)

# [8.主从读写分离](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_8主从读写分离)

分别向主数据库 和从数据库 插入不一样的数据

在mycat客户端查询数据，发现都是写数据库的内容

修改Mycat的配置文件schema.xml的`<dataHost>`节点的balance属性

1. 当balance=0 时，不开启读写分离，所有读操作都发生在当前的writeHost上
2. 当balance=1 ，所有读操作都随机发送到当前的writeHost对应的readHost和备用的writeHos都参与select语句的负载均衡，简单的说当双主双从模式（M1->S1 ,M2-S2 M2和M2互为主备）
3. 当balance=2，所有的读操作都随机发送到所有的writeHost,readHost上
4. 当balance=3 ，所有的读操作都只发送到writeHost(db1)的readHost(db2)上

> 生产当中应该使用 1或者3，此处为了演示切换的效果设置balance="2"

```bash
<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">

    <schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1">
    </schema>

    <dataNode name="dn1" dataHost="host1" database="testdb" />



    <dataHost name="host1" maxCon="1000" minCon="10" balance="2"
              writeType="0" dbType="mysql" dbDriver="native" switchType="1"  slaveThreshold="100">
        <heartbeat>select user()</heartbeat>

        <!--can have multi write hosts -->
        <writeHost host="hostM1" url="172.17.0.2:3306" user="root"   password="123456">
            <!-- can have multi read hosts -->
            <readHost host="hostS1" url="172.17.0.3:3306" user="root" password="123456" />
        </writeHost>
    </dataHost>






</mycat:schema>
```

使用客户端连接mycat查询数据

```bash
[root@mycat ~]# mysql -umycat -p123456 -h 127.0.0.1 -P 8066
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 4
Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (OpenCloundDB)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> use TESTDB
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MySQL [TESTDB]> select * from test_table;
+----+--------------+
| id | name         |
+----+--------------+
|  1 | 订单信息     |
|  2 | 读机器       |
+----+--------------+
2 rows in set (0.01 sec)

MySQL [TESTDB]> select * from test_table;
+----+--------------+
| id | name         |
+----+--------------+
|  1 | 订单信息     |
|  2 | 读机器       |
+----+--------------+
2 rows in set (0.01 sec)

MySQL [TESTDB]> select * from test_table;
+----+--------------+
| id | name         |
+----+--------------+
|  1 | 订单信息     |
|  2 | 读机器       |
+----+--------------+
2 rows in set (0.00 sec)

MySQL [TESTDB]> select * from test_table;
+----+--------------+
| id | name         |
+----+--------------+
|  1 | 订单信息     |
|  2 | 读机器       |
+----+--------------+
2 rows in set (0.00 sec)
```

# [9.双主双从读写分离](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_9双主双从读写分离)

## [9.1原理](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_91原理)

一个主机ml用于处理所有写请求，它的从机s1和另一台主机m2还有它的从机s2负责所有读请

求。当m1主机宕机后，m2主机负责写请求，ml、m2互为备机。架构图如下。

![img](https://jshand.gitee.io/imgs/mycat/2021-06-17_111454.png)

## [9.2 配置数据库](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_92-配置数据库)

此处重新准备数据库,使用docker安装如下四个mysql容器(可以删除db1、db2两个容器以释放虚拟机压力)

| 序号 | 角色    | 容器名 | ip地址     | server-id(my.cnf) |
| ---- | ------- | ------ | ---------- | ----------------- |
| 1    | Master1 | m1     | 172.17.0.2 | 1                 |
| 2    | Slave1  | s1     | 172.17.0.3 | 2                 |
| 3    | Master2 | m2     | 172.17.0.4 | 3                 |
| 4    | Slave   | s2     | 172.17.0.5 | 4                 |

### [1.删除上述db1、db2释放压力](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1删除上述db1、db2释放压力)

> 停止并删除容器

```bash
[root@mycat ~]# docker stop db1  && docker rm db1 && docker stop db2  && docker rm db2
db1
db1
db2
db2
[root@mycat ~]# 
```

### [2.创建四个配置文件](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2创建四个配置文件)

> 创建配置文件目

```bash
#创建配置文件
[root@mycat ~]# mkdir -p /root/dbcnf

#创建四个配置文件
[root@mycat ~]# touch /root/dbcnf/master1.cnf
[root@mycat ~]# touch /root/dbcnf/master2.cnf
[root@mycat ~]# touch /root/dbcnf/slave1.cnf
[root@mycat ~]# touch /root/dbcnf/slave2.cnf
[root@mycat ~]# 
```

### [3.配置Master1(M1)](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3配置master1m1)

修改/root/dbcnf/master1.cnf配置文件添加如下配置

```bash
[mysqld]
#主服务器唯一ID
server-id=1
#启用二进制日志
log-bin=mysql-bin
# 设置不要复制的数据库(可设置多个)
binlog-ignore-db=mysql
binlog-ignore-db=information_schema
#设置需要复制的数据库
binlog-do-db=testdb
#设置logbin格式
binlog_format=STATEMENT
# 在作为从数据库的时候，有写入操作也要更新二进制日志文件
log-slave-updates
#表示自增长字段每次递增的量，指自增字段的起始值，其默认值是1，取值范围是1 .. 65535
auto-increment-increment=2
# 表示自增长字段从哪个数开始，指字段一次递增多少，他的取值范围是1 .. 65535
auto-increment-offset=1
```

使用上述文件创建容器

```bash
[root@mycat ~]# docker run --name m1 -p 3316:3306 -v /root/dbcnf/master1.cnf:/etc/mysql/my.cnf -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7
ace8d2729df2f7084c277fba06d18c17725d21a08c5eed6c676c7f890075523f
[root@mycat ~]# docker ps
CONTAINER ID   IMAGE       COMMAND                  CREATED         STATUS         PORTS                                                  NAMES
ace8d2729df2   mysql:5.7   "docker-entrypoint.s…"   5 seconds ago   Up 4 seconds   33060/tcp, 0.0.0.0:3316->3306/tcp, :::3316->3306/tcp   m1
[root@mycat ~]# docker inspect --format '{{ .NetworkSettings.IPAddress }}'  m1
172.17.0.2
[root@mycat ~]# 
```

通过docker命令查看到m1容器的ip地址为`172.17.0.2`,填入上述准备的表格中

关于mysql中部分配置的说明

此部分说明可以不看，继续往下操作

> 关于log-slave-updates()

从库开启log-bin参数，如果直接往从库写数据，是可以记录log-bin日志的，但是从库通过I0线程读取主库二进制日志文件，然后通过SQL线程写入的数据，是不会记录binlog日志的。也就是说从库从主库上复制的数据，是不写入从库的binlog日志的。所以从库做为其他从库的主库时需要在配置文件中添加log-slave-updates参数。

> 关于binlog-format

mysql复制主要有三种方式：

- 基于SQL语句的复制(statement-based replication, SBR)，
- 基于行的复制(row-based replication, RBR)，
- 混合模式复制(mixed-based replication, MBR)。对应的，

binlog的格式也有三种：STATEMENT，ROW，MIXED。

**① STATEMENT模式（SBR）**

每一条会修改数据的sql语句会记录到binlog中。优点是并不需要记录每一条sql语句和每一行的数据变化，减少了binlog日志量，节约IO，提高性能。缺点是在某些情况下会导致master-slave中的数据不一致(如sleep()函数， last_insert_id()，以及user-defined functions(udf)等会出现问题)

**② ROW模式（RBR）**

不记录每条sql语句的上下文信息，仅需记录哪条数据被修改了，修改成什么样了。而且不会出现某些特定情况下的存储过程、或function、或trigger的调用和触发无法被正确复制的问题。缺点是会产生大量的日志，尤其是alter table的时候会让日志暴涨。

**③ MIXED模式（MBR）**

以上两种模式的混合使用，一般的复制使用STATEMENT模式保存binlog，对于STATEMENT模式无法复制的操作使用ROW模式保存binlog，MySQL会根据执行的SQL语句选择日志保存方式。

### [4.配置Slave1(S1)](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_4配置slave1s1)

保持原配置/root/dbcnf/slave1.cnf不动即可

```bash
[mysqld]

#从服务器唯一ID
server-id=2
#启用中继日志
relay-log=mysql-relay
```

使用上述文件创建容器并查看ip

```bash
[root@mycat ~]# vi /root/dbcnf/slave1.cnf 

[root@mycat ~]# docker run --name s1 -p 3326:3306 -v /root/dbcnf/slave1.cnf:/etc/mysql/my.cnf -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7
78f1f8ce6c8b1d6d4216ac2de432a95b39fee99c3bd689d1326bb9399a255d8c

[root@mycat ~]# docker ps
CONTAINER ID   IMAGE       COMMAND                  CREATED          STATUS          PORTS                                                  NAMES
78f1f8ce6c8b   mysql:5.7   "docker-entrypoint.s…"   5 seconds ago    Up 3 seconds    33060/tcp, 0.0.0.0:3326->3306/tcp, :::3326->3306/tcp   s1
ace8d2729df2   mysql:5.7   "docker-entrypoint.s…"   12 minutes ago   Up 12 minutes   33060/tcp, 0.0.0.0:3316->3306/tcp, :::3316->3306/tcp   m1

[root@mycat ~]# docker inspect --format '{{ .NetworkSettings.IPAddress }}'  s1
172.17.0.3
[root@mycat ~]# 
```

### [5.创建Master2(M2)配置文件并创建数据库](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_5创建master2m2配置文件并创建数据库)

创建`/root/dbcnf/master2.cnf`配置文件并添加如下配置

同Master1相似,需要修改`server-id`(为3)、和`auto_increment_offset`配置

```bash
[mysqld]
#主服务器唯一ID
server-id=3 
#启用二进制日志
log-bin=mysql-bin
# 设置不要复制的数据库(可设置多个)
binlog-ignore-db=mysql
binlog-ignore-db=information_schema
#设置需要复制的数据库
binlog-do-db=testdb
#设置logbin格式
binlog_format=STATEMENT
# 在作为从数据库的时候，有写入操作也要更新二进制日志文件
log-slave-updates 
#表示自增长字段每次递增的量，指自增字段的起始值，其默认值是1，取值范围是1 .. 65535
auto-increment-increment=2 
# 表示自增长字段从哪个数开始，指字段一次递增多少，他的取值范围是1 .. 65535
auto-increment-offset=2
```

使用上述文件创建容器并查看ip

```bash
[root@mycat ~]# vi /root/dbcnf/master2.cnf

[root@mycat ~]# docker run --name m2 -p 3336:3306 -v /root/dbcnf/master2.cnf:/etc/mysql/my.cnf -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7
d567f78b546e63eecf172b36d648f31868632b632fbad230b570d812078459f8

[root@mycat ~]# docker ps
CONTAINER ID   IMAGE       COMMAND                  CREATED          STATUS          PORTS                                                  NAMES
d567f78b546e   mysql:5.7   "docker-entrypoint.s…"   9 seconds ago    Up 4 seconds    33060/tcp, 0.0.0.0:3336->3306/tcp, :::3336->3306/tcp   m2
78f1f8ce6c8b   mysql:5.7   "docker-entrypoint.s…"   4 minutes ago    Up 3 minutes    33060/tcp, 0.0.0.0:3326->3306/tcp, :::3326->3306/tcp   s1
ace8d2729df2   mysql:5.7   "docker-entrypoint.s…"   16 minutes ago   Up 16 minutes   33060/tcp, 0.0.0.0:3316->3306/tcp, :::3316->3306/tcp   m1

[root@mycat ~]# docker inspect --format '{{ .NetworkSettings.IPAddress }}'  m2
172.17.0.4

[root@mycat ~]# 
```

### [6创建Slave2(S2)配置文件并创建数据库](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_6创建slave2s2配置文件并创建数据库)

创建`/root/dbcnf/slave2.cnf`配置文件并添加如下配置(同Slave1一样即可),修改`server-id`

```bash
[mysqld]

#从服务器唯一ID
server-id=4
#启用中继日志
relay-log=mysql-relay
```

使用上述文件创建容器并查看ip

```bash
[root@mycat ~]# vim /root/dbcnf/slave2.cnf 

[root@mycat ~]# docker run --name s2 -p 3346:3306 -v /root/dbcnf/slave2.cnf:/etc/mysql/my.cnf -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7
f2706a827e15c2443e4056793a9b58370e528148d279546edc677a833a6611fb

[root@mycat ~]# docker ps
CONTAINER ID   IMAGE       COMMAND                  CREATED          STATUS          PORTS                                                  NAMES
f2706a827e15   mysql:5.7   "docker-entrypoint.s…"   5 seconds ago    Up 2 seconds    33060/tcp, 0.0.0.0:3346->3306/tcp, :::3346->3306/tcp   s2
d567f78b546e   mysql:5.7   "docker-entrypoint.s…"   8 minutes ago    Up 8 minutes    33060/tcp, 0.0.0.0:3336->3306/tcp, :::3336->3306/tcp   m2
78f1f8ce6c8b   mysql:5.7   "docker-entrypoint.s…"   12 minutes ago   Up 12 minutes   33060/tcp, 0.0.0.0:3326->3306/tcp, :::3326->3306/tcp   s1
ace8d2729df2   mysql:5.7   "docker-entrypoint.s…"   24 minutes ago   Up 24 minutes   33060/tcp, 0.0.0.0:3316->3306/tcp, :::3316->3306/tcp   m1

[root@mycat ~]# docker inspect --format '{{ .NetworkSettings.IPAddress }}'  s2
172.17.0.5
[root@mycat ~]# 
```

至此，四台mysql机器（实际是容器）的环境信息如下：

| 序号 | 角色    | 容器名 | 容器id       | ip地址     | server-id(my.cnf) | 启用二进制日志 | 启用中继日志 |
| ---- | ------- | ------ | ------------ | ---------- | ----------------- | -------------- | ------------ |
| 1    | Master1 | m1     | ace8d2729df2 | 172.17.0.2 | 1                 | 是             |              |
| 2    | Slave1  | s1     | 78f1f8ce6c8b | 172.17.0.3 | 2                 |                | 是           |
| 3    | Master2 | m2     | 6b3868d2f49d | 172.17.0.4 | 3                 | 是             |              |
| 4    | Slave   | s2     | d99c2936a62d | 172.17.0.5 | 4                 |                | 是           |

### [7.在两台主机上建立主从复制账户](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_7在两台主机上建立主从复制账户)

在两个mysql主机上（M1、M2）建立帐户并授权。`CREATE USER 'slave'@'%' IDENTIFIED BY '123456'; GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'slave'@'%';`

具体操作如下

> mysql客户端登录连接m1(IP:172.17.0.2)创建slave用户,并查询master状态

```bash
[root@mycat ~]# mysql -uroot -p123456 -h 172.17.0.2 -P3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.34-log MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> CREATE USER 'slave'@'%' IDENTIFIED BY '123456';
Query OK, 0 rows affected (0.00 sec)

MySQL [(none)]> GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'slave'@'%';
Query OK, 0 rows affected (0.01 sec)

MySQL [(none)]> show master status;
+------------------+----------+--------------+--------------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB         | Executed_Gtid_Set |
+------------------+----------+--------------+--------------------------+-------------------+
| mysql-bin.000003 |      619 | testdb       | mysql,information_schema |                   |
+------------------+----------+--------------+--------------------------+-------------------+
1 row in set (0.00 sec)

MySQL [(none)]> 
```

> mysql客户端登录连接m2(ip:172.17.0.4)创建slave用户,并查询master状态

```bash
[root@mycat ~]# mysql -uroot -p123456 -h 172.17.0.4 -P3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.34-log MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> CREATE USER 'slave'@'%' IDENTIFIED BY '123456';
Query OK, 0 rows affected (0.06 sec)

MySQL [(none)]> GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'slave'@'%';
Query OK, 0 rows affected (0.01 sec)

MySQL [(none)]> show master status;
+------------------+----------+--------------+--------------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB         | Executed_Gtid_Set |
+------------------+----------+--------------+--------------------------+-------------------+
| mysql-bin.000003 |      619 | testdb       | mysql,information_schema |                   |
+------------------+----------+--------------+--------------------------+-------------------+
1 row in set (0.00 sec)

MySQL [(none)]> 
```

配置完两个Master后通过查询可以知道Log_File和Log_POS的值为下述内容。

| 序号 | 角色    | 容器名 | 容器id       | ip地址     | server-id(my.cnf) | 启用二进制日志 | 启用中继日志 | MASTER_LOG_FILE  | MASTER_LOG_POS |
| ---- | ------- | ------ | ------------ | ---------- | ----------------- | -------------- | ------------ | ---------------- | -------------- |
| 1    | Master1 | m1     | ace8d2729df2 | 172.17.0.2 | 1                 | 是             | 是           | mysql-bin.000003 | 619            |
| 2    | Slave1  | s1     | 78f1f8ce6c8b | 172.17.0.3 | 2                 |                | 是           |                  |                |
| 3    | Master2 | m2     | 6b3868d2f49d | 172.17.0.4 | 3                 | 是             |              | mysql-bin.000003 | 619            |
| 4    | Slave   | s2     | d99c2936a62d | 172.17.0.5 | 4                 |                | 是           |                  |                |

分别记录下File和Position的值后,**执行完此步骤后不要再操作主服务器MySQL，防止主服务器状态值变化**

### [8.在从机上配置需要复制的主机](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_8在从机上配置需要复制的主机)

Slave1(s1) 复制 Master1(m1)，Slave2(s2) 复制 Master2(m2)

```
CHANGE MASTER TO MASTER_HOST='主机的IP地址', MASTER_USER='slave', MASTER_PASSWORD='123123', MASTER_LOG_FILE='mysql-bin.具体数字',MASTER_LOG_POS=具体值;
```

> 进入Slave1(s1)执行 复制主机的命令,并启动从机的slave功能

```
CHANGE MASTER TO MASTER_HOST='172.17.0.2', MASTER_USER='slave', MASTER_PASSWORD='123456', MASTER_LOG_FILE='mysql-bin.000003',MASTER_LOG_POS=619;
[root@mycat ~]# mysql -uroot -p123456 -h172.17.0.3 -P3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.34 MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> CHANGE MASTER TO MASTER_HOST='172.17.0.2',
    -> MASTER_USER='slave',
    -> MASTER_PASSWORD='123456',
    -> MASTER_LOG_FILE='mysql-bin.000003',MASTER_LOG_POS=619;
Query OK, 0 rows affected, 2 warnings (0.04 sec)

MySQL [(none)]> start slave;
Query OK, 0 rows affected (0.00 sec)


MySQL [(none)]> show slave status\G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 172.17.0.2
                  Master_User: slave
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000003
          Read_Master_Log_Pos: 619
               Relay_Log_File: mysql-relay.000002
                Relay_Log_Pos: 320
        Relay_Master_Log_File: mysql-bin.000003
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 619
              Relay_Log_Space: 523
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 1
                  Master_UUID: 306d7a6c-cf33-11eb-8ea3-0242ac110002
             Master_Info_File: /var/lib/mysql/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)

ERROR: No query specified

MySQL [(none)]> 
```

> 进入Slave2(s2)执行 复制主机的命令,并启动从机的slave功能

复制的是M2（IP：172.17.0.4）

```
CHANGE MASTER TO MASTER_HOST='172.17.0.4', MASTER_USER='slave', MASTER_PASSWORD='123456', MASTER_LOG_FILE='mysql-bin.000003',MASTER_LOG_POS=619;
[root@mycat ~]# mysql -uroot -p123456 -h172.17.0.5 -P3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.34 MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> CHANGE MASTER TO MASTER_HOST='172.17.0.4',
    -> MASTER_USER='slave',
    -> MASTER_PASSWORD='123456',
    -> MASTER_LOG_FILE='mysql-bin.000003',MASTER_LOG_POS=619;
Query OK, 0 rows affected, 2 warnings (0.05 sec)



MySQL [(none)]> start slave;
Query OK, 0 rows affected (0.00 sec)

MySQL [(none)]> show slave status\G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 172.17.0.4
                  Master_User: slave
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000003
          Read_Master_Log_Pos: 619
               Relay_Log_File: mysql-relay.000002
                Relay_Log_Pos: 320
        Relay_Master_Log_File: mysql-bin.000003
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 619
              Relay_Log_Space: 523
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 3
                  Master_UUID: 687b8bda-cf38-11eb-956e-0242ac110004
             Master_Info_File: /var/lib/mysql/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)

ERROR: No query specified

MySQL [(none)]> 
```

`Slave_IO_Running`、`Slave_SQL_Running`两个参数都是Yes，则说明主从配置成功！

### [10.配置两个主机相互备份](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_10配置两个主机相互备份)

Master2(db3) 复制 Master1(db1)，Master1(db1) 复制 Master2(db3) 步骤如下：

1. 在Master1中配置配置复制命令
2. 启动Master1的主从复制功能
3. 查看Master1的slave状态
4. 在Master2中配置配置复制命令
5. 启动Master2的主从复制功能
6. 查看Master2的slave状态

具体执行过程如下：

在Master1（IP：172.17.0.2）中配置配置复制命令,复制Master2（IP：172.17.0.4）

```bash
[root@mycat ~]# mysql -uroot -p123456 -h172.17.0.2 -P3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 4
Server version: 5.7.34-log MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> CHANGE MASTER TO MASTER_HOST='172.17.0.4',
    -> MASTER_USER='slave',
    -> MASTER_PASSWORD='123456',
    -> MASTER_LOG_FILE='mysql-bin.000003',MASTER_LOG_POS=619;
Query OK, 0 rows affected, 2 warnings (0.04 sec)

MySQL [(none)]> start slave;
Query OK, 0 rows affected (0.00 sec)

MySQL [(none)]> show slave status\G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 172.17.0.4
                  Master_User: slave
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000003
          Read_Master_Log_Pos: 619
               Relay_Log_File: ace8d2729df2-relay-bin.000002
                Relay_Log_Pos: 320
        Relay_Master_Log_File: mysql-bin.000003
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 619
              Relay_Log_Space: 534
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 3
                  Master_UUID: 687b8bda-cf38-11eb-956e-0242ac110004
             Master_Info_File: /var/lib/mysql/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)

ERROR: No query specified
```

在Master2（IP：172.17.0.4）中配置配置复制命令,复制Master1（IP：172.17.0.2）

```bash
[root@mycat ~]# mysql -uroot -p123456 -h172.17.0.4 -P3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 5
Server version: 5.7.34-log MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> CHANGE MASTER TO MASTER_HOST='172.17.0.2',
    -> MASTER_USER='slave',
    -> MASTER_PASSWORD='123456',
    -> MASTER_LOG_FILE='mysql-bin.000003',MASTER_LOG_POS=619;
Query OK, 0 rows affected, 2 warnings (0.03 sec)

MySQL [(none)]> start slave;
Query OK, 0 rows affected (0.00 sec)

MySQL [(none)]> show slave status\G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 172.17.0.2
                  Master_User: slave
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000003
          Read_Master_Log_Pos: 619
               Relay_Log_File: 6b3868d2f49d-relay-bin.000002
                Relay_Log_Pos: 320
        Relay_Master_Log_File: mysql-bin.000003
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 619
              Relay_Log_Space: 534
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 1
                  Master_UUID: 306d7a6c-cf33-11eb-8ea3-0242ac110002
             Master_Info_File: /var/lib/mysql/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)

ERROR: No query specified

MySQL [(none)]> 
```

## [9.3验证mysql主从复制](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_93验证mysql主从复制)

使用mysql客户端分别连接m1、s1、m2、s2，在M1中创建数据库`create database testdb`,在s1、m2、s2中查询数据库是否正常同步。

![img](https://jshand.gitee.io/imgs/mycat/%E5%8F%8C%E4%B8%BB%E5%8F%8C%E4%BB%8E.png)

## [9.4 配置mycat读写分离](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_94-配置mycat读写分离)

修改`<dataHost>`的`balance`属性，通过此属性配置读写分离的类型

修改 Mycat 的配置文件schema.xml,在原有基础上增加writeHost以及对应的readHost

```xml
<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">

    <schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1">
    </schema>
    <dataNode name="dn1" dataHost="host1" database="testdb" />

       <dataHost name="host1" maxCon="1000" minCon="10" balance="1" writeType="0" dbType="mysql" dbDriver="native" switchType="1"  slaveThreshold="100" >
      <heartbeat>select 1</heartbeat>

     <!-- can have multi write hosts -->
     <writeHost host="hostM1" url="172.17.0.2:3306" user="root" password="123456">
         <!-- can have multi read hosts -->
         <readHost host="hostS1" url="172.17.0.3:3306" user="root"  password="123456" />
     </writeHost>


    <writeHost host="hostM2" url="172.17.0.4:3306" user="root" password="123456">
         <!-- can have multi read hosts -->
         <readHost host="hostS2" url="172.17.0.5:3306" user="root"  password="123456" />
     </writeHost>
 </dataHost>

</mycat:schema>
```

- **balance="1"**: 全部的readHost与stand by writeHost参与select语句的负载均衡。
- **writeType="0"**: 所有写操作发送到配置的第一个writeHost，第一个挂了切到还生存的第二个
- writeType="1"，所有写操作都随机的发送到配置的 writeHost，1.5 以后废弃不推荐
- writeHost，重新启动后以切换后的为准，切换记录在配置文件中:dnindex.properties 。
- switchType="1"
  - 1默认值，自动切换。
  - -1 表示不自动切换
  - 2 基于 MySQL 主从同步的状态决定是否切换。

> 操作1
>
> 登录mycat创建数据库，成功后登录m1、s1、m2、s2查看表`use testdb;`,`show tables;`
>
> 可以看到四个数据库都出现了表结构,说明在mycat下主从复制可以用

![img](https://jshand.gitee.io/imgs/mycat/2021-06-17_164339.png)

通过`docker ps` 或 `docker ps|awk '{print $1,"  ",$13}'` 命令可以查看到四个容器对应的容器id（容器内部的主机名即为容器id）

![img](https://jshand.gitee.io/imgs/mycat/2021-06-17_170259.png)

> 操作2
>
> 在mycat中插入能区分的数据，比如插入时带着主机名字的变量,然后查询数据,发现数据库中主机名字在M2、S1、S2之间切换,说明读写分离生效

```
[root@mycat ~]# mysql -umycat -p123456 -h127.0.0.1 -P8066
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 4
Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (OpenCloundDB)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> use TESTDB
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MySQL [TESTDB]> INSERT INTO user_info(NAME) VALUES(@@hostname);
Query OK, 1 row affected, 1 warning (0.01 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | 78f1f8ce6c8b |
+----+--------------+
1 row in set (0.00 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | 6b3868d2f49d |
+----+--------------+
1 row in set (0.00 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | 78f1f8ce6c8b |
+----+--------------+
1 row in set (0.00 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | 78f1f8ce6c8b |
+----+--------------+
1 row in set (0.01 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | d99c2936a62d |
+----+--------------+
1 row in set (0.01 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | 78f1f8ce6c8b |
+----+--------------+
1 row in set (0.01 sec)


MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | 78f1f8ce6c8b |
+----+--------------+
1 row in set (0.00 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | 78f1f8ce6c8b |
+----+--------------+
1 row in set (0.00 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | 6b3868d2f49d |
+----+--------------+
1 row in set (0.00 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | d99c2936a62d |
+----+--------------+
1 row in set (0.00 sec)
```

## [9.5.验证双主切换](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_95验证双主切换)

模拟Master1（M1）异常（此处可以停止mysql服务或者停止容器）,测试mycat能否自动切换到Master2正常插入。实现高可用性。

![img](https://jshand.gitee.io/imgs/mycat/2021-06-17_175241.png)

停止m1容器，

```bash
root@mycat ~]# docker ps
CONTAINER ID   IMAGE       COMMAND                  CREATED       STATUS       PORTS                                                  NAMES
d99c2936a62d   mysql:5.7   "docker-entrypoint.s…"   3 hours ago   Up 3 hours   33060/tcp, 0.0.0.0:3346->3306/tcp, :::3346->3306/tcp   s2
6b3868d2f49d   mysql:5.7   "docker-entrypoint.s…"   3 hours ago   Up 3 hours   33060/tcp, 0.0.0.0:3336->3306/tcp, :::3336->3306/tcp   m2
78f1f8ce6c8b   mysql:5.7   "docker-entrypoint.s…"   3 hours ago   Up 3 hours   33060/tcp, 0.0.0.0:3326->3306/tcp, :::3326->3306/tcp   s1
ace8d2729df2   mysql:5.7   "docker-entrypoint.s…"   4 hours ago   Up 4 hours   33060/tcp, 0.0.0.0:3316->3306/tcp, :::3316->3306/tcp   m1
[root@mycat ~]# docker stop m1
m1
[root@mycat ~]# docker ps
CONTAINER ID   IMAGE       COMMAND                  CREATED       STATUS       PORTS                                                  NAMES
d99c2936a62d   mysql:5.7   "docker-entrypoint.s…"   3 hours ago   Up 3 hours   33060/tcp, 0.0.0.0:3346->3306/tcp, :::3346->3306/tcp   s2
6b3868d2f49d   mysql:5.7   "docker-entrypoint.s…"   3 hours ago   Up 3 hours   33060/tcp, 0.0.0.0:3336->3306/tcp, :::3336->3306/tcp   m2
78f1f8ce6c8b   mysql:5.7   "docker-entrypoint.s…"   3 hours ago   Up 3 hours   33060/tcp, 0.0.0.0:3326->3306/tcp, :::3326->3306/tcp   s1
[root@mycat ~]# 
```

插入数据,并查询

```bash
[root@mycat ~]# mysql -umycat -p123456 -h127.0.0.1 -P8066
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 6
Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (OpenCloundDB)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> use TESTDB
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MySQL [TESTDB]> INSERT INTO user_info(NAME) VALUES(concat('valid-switch--',@@hostname));
Query OK, 1 row affected, 1 warning (0.01 sec)

MySQL [TESTDB]> select * from user_info;
+----+----------------------------+
| id | name                       |
+----+----------------------------+
| 11 | d99c2936a62d               |
| 12 | valid-switch--d99c2936a62d |
+----+----------------------------+
2 rows in set (0.01 sec)

MySQL [TESTDB]> select * from user_info;
+----+----------------------------+
| id | name                       |
+----+----------------------------+
| 11 | d99c2936a62d               |
| 12 | valid-switch--d99c2936a62d |
+----+----------------------------+
2 rows in set (0.00 sec)

MySQL [TESTDB]> select * from user_info;
+----+----------------------------+
| id | name                       |
+----+----------------------------+
| 11 | d99c2936a62d               |
| 12 | valid-switch--d99c2936a62d |
+----+----------------------------+
2 rows in set (0.00 sec)
```

通过实验发现插入操作成功，且查询时能访问到M2对应的`S2`的机器(如上图所示)

此时重新启动`M1`后登录Mycat查询数据，发现查询的内容是Master1、Salve1、Salve2其中Master1变为备份主机了。

```bash
[root@mycat ~]# mysql -umycat -p123456 -h127.0.0.1 -P8066
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 7
Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (OpenCloundDB)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> use TESTDB
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MySQL [TESTDB]> select * from user_info;
+----+----------------------------+
| id | name                       |
+----+----------------------------+
| 11 | d99c2936a62d               |
| 12 | valid-switch--d99c2936a62d |
+----+----------------------------+
2 rows in set (0.00 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | 78f1f8ce6c8b |
+----+--------------+
1 row in set (0.01 sec)

MySQL [TESTDB]> select * from user_info;
+----+----------------------------+
| id | name                       |
+----+----------------------------+
| 11 | d99c2936a62d               |
| 12 | valid-switch--d99c2936a62d |
+----+----------------------------+
2 rows in set (0.01 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | 78f1f8ce6c8b |
+----+--------------+
1 row in set (0.00 sec)

MySQL [TESTDB]> select * from user_info;
+----+----------------------------+
| id | name                       |
+----+----------------------------+
| 11 | d99c2936a62d               |
| 12 | valid-switch--d99c2936a62d |
+----+----------------------------+
2 rows in set (0.00 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | 78f1f8ce6c8b |
+----+--------------+
1 row in set (0.01 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | 78f1f8ce6c8b |
+----+--------------+
1 row in set (0.00 sec)

MySQL [TESTDB]> select * from user_info;
+----+----------------------------+
| id | name                       |
+----+----------------------------+
| 11 | ace8d2729df2               |
| 12 | valid-switch--ace8d2729df2 |
+----+----------------------------+
2 rows in set (0.01 sec)

MySQL [TESTDB]> select * from user_info;
+----+--------------+
| id | name         |
+----+--------------+
| 11 | 78f1f8ce6c8b |
+----+--------------+
1 row in set (0.00 sec)

MySQL [TESTDB]> select * from user_info;
+----+----------------------------+
| id | name                       |
+----+----------------------------+
| 11 | ace8d2729df2               |
| 12 | valid-switch--ace8d2729df2 |
+----+----------------------------+
2 rows in set (0.01 sec)

MySQL [TESTDB]> select * from user_info;
+----+----------------------------+
| id | name                       |
+----+----------------------------+
| 11 | d99c2936a62d               |
| 12 | valid-switch--d99c2936a62d |
+----+----------------------------+
2 rows in set (0.00 sec)

MySQL [TESTDB]> select * from user_info;
+----+----------------------------+
| id | name                       |
+----+----------------------------+
| 11 | ace8d2729df2               |
| 12 | valid-switch--ace8d2729df2 |
+----+----------------------------+
2 rows in set (0.00 sec)

MySQL [TESTDB]> 
```

通过上述查询发现查询时可以落到M1、S1、S2上。双主切换成功。

# [10.为什么分库分表](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_10为什么分库分表)

## [1 什么是分库分表？](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1-什么是分库分表？)

其实就是字面意思，很好理解：

- 分库：从单个数据库拆分成多个数据库的过程，将数据散落在多个数据库中。
- 分表：从单张表拆分成多张表的过程，将数据散落在多张表内。

## [2 为什么要分库分表？](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2-为什么要分库分表？)

关键字：提升性能、增加可用性。

### [1) 从性能上看](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1-从性能上看)

随着单库中的数据量越来越大、数据库的查询QPS越来越高，相应的，对数据库的读写所需要的时间也越来越多。数据库的读写性能可能会成为业务发展的瓶颈。对应的，就需要做数据库性能方面的优化。本文中我们只讨论数据库层面的优化，不讨论缓存等应用层优化的手段。

如果数据库的查询QPS过高，就需要考虑拆库，通过分库来分担单个数据库的连接压力。比如，如果查询QPS为3500，假设单库可以支撑1000个连接数的话，那么就可以考虑拆分成多个个库，来分散查询连接压力。

如果单表数据量过大，当数据量超过一定量级后，无论是对于数据查询还是数据更新，在经过索引优化等纯数据库层面的传统优化手段之后，还是可能存在性能问题。这是量变产生了质变，这时候就需要去换个思路来解决问题，比如：从数据生产源头、数据处理源头来解决问题，既然数据量很大，那我们就来个分而治之，化整为零。这就产生了分表，把数据按照一定的规则拆分成多张表，来解决单表环境下无法解决的存取性能问题。

### [2) 从可用性上看](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2-从可用性上看)

单个数据库如果发生意外，很可能会丢失所有数据。尤其是云时代，很多数据库都跑在虚拟机上，如果虚拟机/宿主机发生意外，则可能造成无法挽回的损失。因此，除了传统的 Master-Slave、Master-Master 等部署层面解决可靠性问题外，我们也可以考虑从数据拆分层面解决此问题。

此处我们以数据库宕机为例：

- 单库部署情况下，如果数据库宕机，那么故障影响就是100%，而且恢复可能耗时很长。
- 如果我们拆分成2个库，分别部署在不同的机器上，此时其中1个库宕机，那么故障影响就是50%，还有50%的数据可以继续服务。
- 如果我们拆分成4个库，分别部署在不同的机器上，此时其中1个库宕机，那么故障影响就是25%，还有75%的数据可以继续服务，恢复耗时也会很短。

当然，我们也不能无限制的拆库，这也是牺牲存储资源来提升性能、可用性的方式，毕竟资源总是有限的。

## [3. 如何分库分表](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3-如何分库分表)

### [1) 分库？分表？还是既分库又分表？](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1-分库？分表？还是既分库又分表？)

从第一部分了解到的信息来看，分库分表方案可以分为下面3种：

| 切分方案     | 解决的问题                              |
| ------------ | --------------------------------------- |
| 只分库部分表 | 数据库读/写QPS过高，数据库连接不足      |
| 只分表部分库 | 单表数据量过大，存储性能遇到瓶颈        |
| 即分库又分表 | 连接数不足+数据量过大引起的存储性能瓶颈 |

### [2) 如何选择我们自己的切分方案？](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2-如何选择我们自己的切分方案？)

**如果需要分表，那么分多少张表合适？**

由于所有的技术都是为业务服务的，那么，我们就先从数据方面回顾下业务背景。

比如，我们这个业务系统是为了解决会员的咨询诉求，通过我们的XSpace客服平台系统来服务会员，目前主要以同步的离线工单数据作为我们的数据源来构建自己的数据。

假设，每一笔离线工单都会产生对应一笔会员的咨询问题（我们简称：问题单），如果：

- 在线渠道：每天产生 3w 笔聊天会话，假设，其中50%的会话会生成一笔离线工单，那么每天可生成 3w * 50% = 1.5w 笔工单；
- 热线渠道：每天产生 2.5w 通电话，假设，其中80%的电话都会产生一笔工单，那么每天可生成 2.5w * 80% = 2w 笔/天；
- 离线渠道：假设离线渠道每天直接生成 3w 笔；

合计共 1.5w + 2w + 3w = 6.5w 笔/天

考虑到以后可能要继续覆盖的新的业务场景，需要提前预留部分扩展空间，这里我们假设为每天产生 8w 笔问题单。

除问题单外，还有另外2张常用的业务表：用户操作日志表、用户提交的表单数据表。

其中，每笔问题单都会产生多条用户操作日志，根据历史统计数据来可以看到，平均每个问题单大约会产生8条操作日志，我们预留一部分空间，假设每个问题单平均产生约10条用户操作日志。

如果系统设计使用年限5年，那么问题单数据量大约 = 5年 *365天/年* 8w/天 = 1.46亿，那么估算出的表数量如下：

- 问题单需要：1.46亿/500w = 29.2 张表，我们就按 32 张表来切分；
- 操作日志需要 ：32 *10 = 320 张表，我们就按 32* 16 = 512 张表来切分。

### [3)如果需要分库，那么分多少库合适？](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3如果需要分库，那么分多少库合适？)

分库的时候除了要考虑平时的业务峰值读写QPS外，还要考虑到诸如双11大促期间可能达到的峰值，需要提前做好预估。

根据我们的实际业务场景，问题单的数据查询来源主要来自于阿里客服小蜜首页。因此，可以根据历史QPS、RT等数据评估，假设我们只需要3500数据库连接数，如果单库可以承担最高1000个数据库连接，那么我们就可以拆分成4个库。

### [4) 如何对数据进行切分？](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_4-如何对数据进行切分？)

根据行业惯例，通常按照 水平切分、垂直切分 两种方式进行切分，当然，有些复杂业务场景也可能选择两者结合的方式。

（1）水平切分

这是一种横向按业务维度切分的方式，比如常见的按会员维度切分，根据一定的规则把不同的会员相关的数据散落在不同的库表中。由于我们的业务场景决定都是从会员视角进行数据读写，所以，我们就选择按照水平方式进行数据库切分。

（2）垂直切分

垂直切分可以简单理解为，把一张表的不同字段拆分到不同的表中。

比如：假设有个小型电商业务，把一个订单相关的商品信息、买卖家信息、支付信息都放在一张大表里。可以考虑通过垂直切分的方式，把商品信息、买家信息、卖家信息、支付信息都单独拆分成独立的表，并通过订单号跟订单基本信息关联起来。

也有一种情况，如果一张表有10个字段，其中只有3个字段需要频繁修改，那么就可以考虑把这3个字段拆分到子表。避免在修改这3个数据时，影响到其余7个字段的查询行锁定。

# [11.分库](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_11分库)

## [11.1数据库准备](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_111数据库准备)

此处模拟东软云医院管理系统当数据库连接压力过大时进行数据库的拆分，计划拆分成两个数据库。

数据库设计关系如下：

![img](https://jshand.gitee.io/imgs/mycat/2021-06-17_204708.png)

根据上述业务表关联关系科室、用户表、挂号信息表三个表之间是有关联关系的所以应该放到一个数据节点上，另外两张表为了测试放到另外一个数据节点上，表示成如下形式：

![img](https://jshand.gitee.io/imgs/mycat/2021-06-17_211329.png)

### [1 停止之前的数据库](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1-停止之前的数据库)

分库一定要在新的数据库上准备，此处抛弃上述数据库重新创建干净的数据库

删除掉原来的数据库(容器),可以仅停止不删除容器用于测试之前的逻辑

```bash
[root@mycat ~]# docker stop m1 && docker stop m2 && docker stop s1 && docker stop s2
m1
m2
s1
s2
[root@mycat ~]# docker rm m1 && docker rm m2 && docker rm  s1 && docker rm s2
m1
m2
s1
s2
[root@mycat ~]# 
```

### [2 安装两个数据库服务（容器）](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2-安装两个数据库服务（容器）)

创建两个数据库,此处暂时不配置主从数据库复制(Master-Slave模式)所以不需要在docker宿主机上单独映射配置文件，执行如下命令直接创建2个MySQL数据库容器

```
docker run --name dn1 -p 3316:3306   -e MYSQL_ROOT_PASSWORD=root -d mysql:5.7 &&\
docker run --name dn2 -p 3326:3306   -e MYSQL_ROOT_PASSWORD=root -d mysql:5.7
```

具体执行过程如下：

```bash
[root@mycat ~]# docker run --name dn1 -p 3316:3306   -e MYSQL_ROOT_PASSWORD=root -d mysql:5.7 &&\
> docker run --name dn2 -p 3326:3306   -e MYSQL_ROOT_PASSWORD=root -d mysql:5.7
b9b3297b30ae82cd25889414e76e16c0fa20c186535a1c6b0d2d15469163b40e
e61487a76ef284927f031897ac38d7c6d00c88c191265f946fcf6bb237f04f54
[root@mycat ~]#
```

查看两个数据库机器（容器）的ip

```bash
[root@mycat ~]# docker ps
CONTAINER ID   IMAGE       COMMAND                  CREATED         STATUS         PORTS                                                  NAMES
fd2bea0b1f01   mysql:5.7   "docker-entrypoint.s…"   5 seconds ago   Up 3 seconds   33060/tcp, 0.0.0.0:3326->3306/tcp, :::3326->3306/tcp   dn2
6ae712c5f59c   mysql:5.7   "docker-entrypoint.s…"   6 seconds ago   Up 5 seconds   33060/tcp, 0.0.0.0:3316->3306/tcp, :::3316->3306/tcp   dn1


[root@mycat ~]# docker inspect --format '{{ .NetworkSettings.IPAddress }}'  dn1  &&\
> docker inspect --format '{{ .NetworkSettings.IPAddress }}'  dn2
172.17.0.2
172.17.0.3
[root@mycat ~]# 
```

ip地址分别是：

| 容器 | IP         |
| ---- | ---------- |
| dn1  | 172.17.0.2 |
| dn2  | 172.17.0.3 |

### [3.创建数据库](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3创建数据库)

在两个空白数据库机器（容器）上创建数据库语句如下：

```
CREATE DATABASE his_mycat DEFAULT CHARACTER SET utf8mb4;
```

> 在dn1上创建数据库

```bash
[root@mycat ~]# mysql -u root -proot -h 172.17.0.2 -P3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 5
Server version: 5.7.34 MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> CREATE DATABASE his_mycat DEFAULT CHARACTER SET utf8mb4;
Query OK, 1 row affected (0.01 sec)

MySQL [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| his_mycat          |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.00 sec)

MySQL [(none)]> exit
Bye
[root@mycat ~]# 
```

> 在dn2上创建数据库

```bash
[root@mycat ~]# mysql -u root -proot -h 172.17.0.3 -P3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.34 MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> CREATE DATABASE his_mycat DEFAULT CHARACTER SET utf8mb4;
Query OK, 1 row affected (0.00 sec)

MySQL [(none)]> 
MySQL [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| his_mycat          |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.00 sec)

MySQL [(none)]> exit
Bye
[root@mycat ~]# 
```

## [11.2配置mycat](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_112配置mycat)

分库规则：

- dn1：department部门表、user用户表、register患者挂号表
- dn2：drugs 药品表、disease 疾病表

修改mycat的schema.xml重新配置分库规则

```
<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">
    <schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1">
        <table name="drugs" dataNode="dn2"></table>
        <table name="disease" dataNode="dn2"></table>
    </schema>

    <dataNode name="dn1" dataHost="host1" database="his_mycat"/>
    <dataNode name="dn2" dataHost="host2" database="his_mycat"/>

    <dataHost name="host1" maxCon="1000" minCon="10" balance="0"
              writeType="0" dbType="mysql" dbDriver="native" switchType="1"
              slaveThreshold="100">
        <heartbeat>select user()</heartbeat>
        <!-- can have multi write hosts -->
        <writeHost host="hostM1" url="172.17.0.2:3306" user="root" password="root">
        </writeHost>
    </dataHost>
    <dataHost name="host2" maxCon="1000" minCon="10" balance="0"
              writeType="0" dbType="mysql" dbDriver="native" switchType="1"
              slaveThreshold="100">
        <heartbeat>select user()</heartbeat>
        <!-- can have multi write hosts -->
        <writeHost host="hostM2" url="172.17.0.3:3306" user="root"  password="root">
        </writeHost>
    </dataHost>

</mycat:schema>
```

## [11.3 启动mycat](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_113-启动mycat)

在mycat/bin目录中执行

```bash
./mycat console
```

## [11.4 登录mycat创建表结构](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_114-登录mycat创建表结构)

```sql
/****dn1****/


CREATE TABLE `department` (
  `id` int(9) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `DeptCode` varchar(64) NOT NULL COMMENT '科室编码',
  `DeptName` varchar(64) NOT NULL COMMENT '科室名称',
  `DeptCategory` varchar(64) DEFAULT NULL COMMENT '科室分类',
  `DeptTypeID` int(9) NOT NULL COMMENT '科室类型',
  `DelMark` int(1) DEFAULT NULL COMMENT '删除标记',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;



CREATE TABLE `user` (
  `id` int(9) NOT NULL COMMENT 'id',
  `UserName` varchar(64) NOT NULL COMMENT '登录名',
  `Password` varchar(64) DEFAULT NULL COMMENT '密码',
  `RealName` varchar(64) NOT NULL COMMENT '真实姓名',
  `UserTypeID` int(9) DEFAULT NULL COMMENT '1 - 挂号人员  2 - 门诊医生  3 - 医技医生 4 - 药房人员   5 - 财务人员  6 - 行政人员 ',
  `DocTitleID` int(9) DEFAULT NULL COMMENT '医生职称',
  `IsScheduling` int(9) DEFAULT NULL COMMENT '是否排班',
  `DeptId` int(9) NOT NULL COMMENT '所在科室ID',
  `RegistId` int(9) DEFAULT NULL COMMENT '挂号级别ID',
  `DelMark` int(1) DEFAULT NULL COMMENT '删除标记',
  PRIMARY KEY (`id`),
  KEY `FK_科室id` (`DeptId`),
  CONSTRAINT `FK_科室id` FOREIGN KEY (`DeptId`) REFERENCES `department` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


CREATE TABLE `register` (
  `id` int(9) NOT NULL COMMENT 'id',
  `RealName` varchar(64) DEFAULT NULL COMMENT '真实姓名',
  `Gender` int(9) DEFAULT NULL COMMENT '性别',
  `IDnumber` varchar(18) DEFAULT NULL COMMENT '身份证号',
  `BirthDate` date DEFAULT NULL COMMENT '出生日期',
  `Age` int(3) DEFAULT NULL COMMENT '年龄',
  `AgeType` int(9) DEFAULT NULL COMMENT '年龄类型',
  `HomeAddress` varchar(64) DEFAULT NULL COMMENT '家庭住址',
  `CaseNumber` varchar(64) DEFAULT NULL COMMENT '一名患者在同一医院看诊多次，根据患者是否使用同一个病历本，确定该患者的“病历号码”是否相同。',
  `VisitDate` date NOT NULL COMMENT '本次看诊日期',
  `Noon` int(9) NOT NULL COMMENT '午别',
  `DeptId` int(9) DEFAULT NULL COMMENT '本次挂号科室ID',
  `UserId` int(9) DEFAULT NULL COMMENT '本次挂号医生id',
  `IsBook` int(1) NOT NULL COMMENT '病历本要否',
  `RegisterTime` datetime DEFAULT NULL COMMENT '挂号时间',
  `RegisterID` int(9) NOT NULL COMMENT '挂号员ID',
  `VisitState` int(9) DEFAULT NULL COMMENT '本次看诊状态',
  PRIMARY KEY (`id`),
  KEY `FK_医生id` (`UserId`),
  CONSTRAINT `FK_医生id` FOREIGN KEY (`UserId`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


/****dn2****/
CREATE TABLE `disease` (
  `id` int(9) NOT NULL COMMENT 'id',
  `DiseaseCode` varchar(64) DEFAULT NULL COMMENT '疾病助记编码',
  `DiseaseName` varchar(255) DEFAULT NULL COMMENT '疾病名称',
  `DiseaseICD` varchar(64) DEFAULT NULL COMMENT '国际ICD编码',
  `DiseaseType` varchar(64) DEFAULT NULL COMMENT '疾病所属分类',
  `DelMark` int(1) DEFAULT NULL COMMENT '删除标记',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


CREATE TABLE `drugs` (
  `id` int(9) NOT NULL COMMENT 'id',
  `Drugs_Code` char(14) DEFAULT NULL COMMENT '药品编码',
  `Drugs_Name` varchar(64) DEFAULT NULL COMMENT '药品名称',
  `Drugs_Format` varchar(64) DEFAULT NULL COMMENT '药品规格',
  `Drugs_Unit` varchar(64) DEFAULT NULL COMMENT '包装单位',
  `Manufacturer` varchar(512) DEFAULT NULL COMMENT '生产厂家',
  `Drugs_Dosage` varchar(64) DEFAULT NULL COMMENT '药品剂型',
  `Drugs_Type` varchar(64) DEFAULT NULL COMMENT '药品类型',
  `Drugs_Price` decimal(8,2) DEFAULT NULL COMMENT '药品单价',
  `Mnemonic_Code` varchar(64) DEFAULT NULL COMMENT '拼音助记码',
  `Creation_Date` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '创建时间',
  `DelMark` int(1) DEFAULT NULL COMMENT '有效性标记',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

## [11.5验证](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_115验证)

创建完成后分别在mycat客户端、dn1节点、dn2节点查看表存储情况

![img](https://jshand.gitee.io/imgs/mycat/2021-06-17_214128.png)

### [1.Mycat客户端验证](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1mycat客户端验证)

执行过程如下：

```bash
[root@mycat ~]# mysql -umycat -p123456 -h 127.0.0.1 -P8066
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 1
Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (OpenCloundDB)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> use TESTDB
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed


MySQL [TESTDB]> CREATE TABLE `department` (
    ->   `id` int(9) NOT NULL AUTO_INCREMENT COMMENT 'id',
    ->   `DeptCode` varchar(64) NOT NULL COMMENT '科室编码',
    ->   `DeptName` varchar(64) NOT NULL COMMENT '科室名称',
    ->   `DeptCategory` varchar(64) DEFAULT NULL COMMENT '科室分类',
    ->   `DeptTypeID` int(9) NOT NULL COMMENT '科室类型',
    ->   `DelMark` int(1) DEFAULT NULL COMMENT ' 删除标记',
    ->   PRIMARY KEY (`id`)
    -> ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
Query OK, 0 rows affected (0.02 sec)


MySQL [TESTDB]> 
MySQL [TESTDB]> CREATE TABLE `user` (
    ->   `id` int(9) NOT NULL COMMENT 'id',
    ->   `UserName` varchar(64) NOT NULL COMMENT '登录名',
    ->   `Password` varchar(64) DEFAULT NULL COMMENT '密码',
    ->   `RealName` varchar(64) NOT NULL COMMENT '真实姓名',
    ->   `UserTypeID` int(9) DEFAULT NULL COMMENT '1 - 挂号人员  2 - 门诊医生  3 - 医技医生 4 - 药房人员   5 - 财务人员  6 - 行政人员 ',
    ->   `DocTitleID` int(9) DEFAULT NULL COMMENT '医生职称',
    ->   `IsScheduling` int(9) DEFAULT NULL COMMENT '是否排班',
    ->   `DeptId` int(9) NOT NULL COMMENT '所在科室ID',
    ->   `RegistId` int(9) DEFAULT NULL COMMENT '挂号级别ID',
    ->   `DelMark` int(1) DEFAULT NULL COMMENT ' 删除标记',
    ->   PRIMARY KEY (`id`),
    ->   KEY `FK_科室id` (`DeptId`),
    ->   CONSTRAINT `FK_科室id` FOREIGN KEY (`DeptId`) REFERENCES `department` (`id`)
    -> ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
Query OK, 0 rows affected (0.06 sec)

MySQL [TESTDB]> 
MySQL [TESTDB]> 
MySQL [TESTDB]> CREATE TABLE `register` (
    ->   `id` int(9) NOT NULL COMMENT 'id',
    ->   `RealName` varchar(64) DEFAULT NULL COMMENT '真实姓名',
    ->   `Gender` int(9) DEFAULT NULL COMMENT '性别',
    ->   `IDnumber` varchar(18) DEFAULT NULL COMMENT '身份证号',
    ->   `BirthDate` date DEFAULT NULL COMMENT ' 出生日期',
    ->   `Age` int(3) DEFAULT NULL COMMENT '年龄',
    ->   `AgeType` int(9) DEFAULT NULL COMMENT ' 年龄类型',
    ->   `HomeAddress` varchar(64) DEFAULT NULL COMMENT '家庭住址',
    ->   `CaseNumber` varchar(64) DEFAULT NULL COMMENT '一名患者在同一医院看诊多次，根据患者是否使用同一个病历本，确定该患者的“病历号码”是否相同。',
    ->   `VisitDate` date NOT NULL COMMENT '本次 看诊日期',
    ->   `Noon` int(9) NOT NULL COMMENT '午别',
    ->   `DeptId` int(9) DEFAULT NULL COMMENT '本次挂号科室ID',
    ->   `UserId` int(9) DEFAULT NULL COMMENT '本次挂号医生id',
    ->   `IsBook` int(1) NOT NULL COMMENT '病历本要否',
    ->   `RegisterTime` datetime DEFAULT NULL COMMENT '挂号时间',
    ->   `RegisterID` int(9) NOT NULL COMMENT '挂号员ID',
    ->   `VisitState` int(9) DEFAULT NULL COMMENT '本次看诊状态',
    ->   PRIMARY KEY (`id`),
    ->   KEY `FK_医生id` (`UserId`),
    ->   CONSTRAINT `FK_医生id` FOREIGN KEY (`UserId`) REFERENCES `user` (`id`)
    -> ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
Query OK, 0 rows affected (0.03 sec)

MySQL [TESTDB]> 
MySQL [TESTDB]> 
MySQL [TESTDB]> /****dn2****/
MySQL [TESTDB]> CREATE TABLE `disease` (
    ->   `id` int(9) NOT NULL COMMENT 'id',
    ->   `DiseaseCode` varchar(64) DEFAULT NULL COMMENT '疾病助记编码',
    ->   `DiseaseName` varchar(255) DEFAULT NULL COMMENT '疾病名称',
    ->   `DiseaseICD` varchar(64) DEFAULT NULL COMMENT '国际ICD编码',
    ->   `DiseaseType` varchar(64) DEFAULT NULL COMMENT '疾病所属分类',
    ->   `DelMark` int(1) DEFAULT NULL COMMENT ' 删除标记',
    ->   PRIMARY KEY (`id`)
    -> ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
Query OK, 0 rows affected (0.03 sec)

MySQL [TESTDB]> 
MySQL [TESTDB]> 
MySQL [TESTDB]> CREATE TABLE `drugs` (
    ->   `id` int(9) NOT NULL COMMENT 'id',
    ->   `Drugs_Code` char(14) DEFAULT NULL COMMENT '药品编码',
    ->   `Drugs_Name` varchar(64) DEFAULT NULL COMMENT '药品名称',
    ->   `Drugs_Format` varchar(64) DEFAULT NULL COMMENT '药品规格',
    ->   `Drugs_Unit` varchar(64) DEFAULT NULL COMMENT '包装单位',
    ->   `Manufacturer` varchar(512) DEFAULT NULL COMMENT '生产厂家',
    ->   `Drugs_Dosage` varchar(64) DEFAULT NULL COMMENT '药品剂型',
    ->   `Drugs_Type` varchar(64) DEFAULT NULL COMMENT '药品类型',
    ->   `Drugs_Price` decimal(8,2) DEFAULT NULL COMMENT '药品单价',
    ->   `Mnemonic_Code` varchar(64) DEFAULT NULL COMMENT '拼音助记码',
    ->   `Creation_Date` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '创建时间',
    ->   `DelMark` int(1) DEFAULT NULL COMMENT ' 有效性标记',
    ->   PRIMARY KEY (`id`)
    -> ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
Query OK, 0 rows affected (0.03 sec)

MySQL [TESTDB]> show tables;
+---------------------+
| Tables_in_his_mycat |
+---------------------+
| disease             |
| drugs               |
| department          |
| register            |
| user                |
+---------------------+
5 rows in set (0.01 sec)

MySQL [TESTDB]> 
```

### [2.dn1节点验证](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2dn1节点验证)

```bash
[root@mycat bin]# mysql -uroot -proot -h 172.17.0.2 -P 3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 17
Server version: 5.7.34 MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> use his_mycat
Database changed
MySQL [his_mycat]> show tables;
+---------------------+
| Tables_in_his_mycat |
+---------------------+
| department          |
| register            |
| user                |
+---------------------+
3 rows in set (0.00 sec)

MySQL [his_mycat]> 
```

### [3.dn2节点验证](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3dn2节点验证)

```bash
[root@mycat ~]# mysql -uroot -proot -h 172.17.0.3 -P 3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 13
Server version: 5.7.34 MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> use his_mycat
Database changed
MySQL [his_mycat]> show tables;
+---------------------+
| Tables_in_his_mycat |
+---------------------+
| disease             |
| drugs               |
+---------------------+
2 rows in set (0.00 sec)

MySQL [his_mycat]> 
```

# [12.分表](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_12分表)

相对于垂直拆分，水平拆分不是将表做分类，而是按照某个字段的某种规则来分散到多个库之中，每个表中 包含一部分数据。简单来说，我们可以将数据的水平切分理解为是按照数据行的切分，就是将表中的某些行切分 到一个数据库，而另外的某些行又切分到其他的数据库中。

## [12.1.需求](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_121需求)

在电信行业有电信计费系统([BOSS系统](https://baike.baidu.com/item/BOSS系统/7387466?fr=aladdin))，假设其中存储如下信息：

- 客户手机账户（手机号）信息
- 手机通话记录信息
- 字典表（如存储常用的码表信息，例如 通话类型，01：呼出，02：呼入等）

简单ER图如下：

![img](https://jshand.gitee.io/imgs/mycat/2021-06-19_142559.png)

MySQL 单表存储数据条数是有瓶颈的，单表达到 1000 万条数据就达到了瓶颈，会影响查询效率，

需要进行水平拆分（分表）进行优化。BOSS系统预测5年内客户手机账户表5000万条以上。解决方案是将`手机号`表进行水平拆分。

表结构sql语句如下：

```sql
/* 创建数据库 */
CREATE DATABASE boss;

USE boss;

/* 客户手机号表 */
CREATE TABLE customer (
  id bigint(20) NOT NULL COMMENT '主键',
  cid bigint(20) DEFAULT NULL COMMENT '客户id',
  name varchar(500) DEFAULT NULL COMMENT '客户名称',
  phone varchar(500) DEFAULT NULL COMMENT '电话号',
  provice varchar(500) DEFAULT NULL COMMENT '所属省份',
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='电信客户信息（手机号）';


/* 手机号通话记录 */
CREATE TABLE calllog (
  id bigint(20) NOT NULL COMMENT 'id',
  phone_id bigint(20) DEFAULT NULL COMMENT '主键',
  type varchar(10) DEFAULT NULL COMMENT '通话类型',
  duration bigint(20) DEFAULT NULL COMMENT '通话时长（秒）',
  othernum varchar(20) DEFAULT NULL COMMENT '对方电话号',
  PRIMARY KEY (id),
  KEY FK_Reference_1 (phone_id),
  CONSTRAINT FK_Reference_1 FOREIGN KEY (phone_id) REFERENCES customer (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通话记录';


/* 字典表 */
CREATE TABLE dict (
  id bigint(20) NOT NULL COMMENT 'id',
  caption varchar(100) DEFAULT NULL COMMENT '代码类型名称',
  code varchar(10) DEFAULT NULL COMMENT '代码',
  name varchar(10) DEFAULT NULL COMMENT '名称',
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='字典表';
```

## [12.2分表实现(取模)](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_122分表实现取模)

此规则为对分片字段求摸运算

```xml
<tableRule name="mod-long">
    <rule>
        <columns>user_id</columns>
        <algorithm>mod-long</algorithm>
    </rule>
</tableRule>

<function name="mod-long" class="io.mycat.route.function.PartitionByMod">
    <!-- how many data nodes -->
    <property name="count">3</property>
</function>
```

上面 columns 标识将要分片的表字段，algorithm 分片函数，

此种配置非常明确即根据 id 进行十进制求模预算，相比固定分片 hash，此种在批量插入时可能存在批量插入单

事务插入多数据分片，增大事务一致性难度（**因此种方式实现最简单所以优先说明**）。

### [1.原则](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1原则)

以客户表（customer）为例可以采用不同字段进行分表：

| 序号 | 分表字段                      | 说明                                                         |
| ---- | ----------------------------- | ------------------------------------------------------------ |
| 1    | id（主键、或创建时间）        | 从业务上来看同一个客户的不同手机号分布在不同的数据节点上，可能造成查询效率降低 |
| 2    | cid（客户 id）、provice(省份) | 根据客户 id 去分，两个节点访问平均，一个客户所有的手机号都在同一个数据节点上。 |

### [2.安装数据库](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2安装数据库)

此处同上述过程一样采用docker容器模拟不同的数据节点。此处为测试方便创建两个MySQL数据库容器。

```bash
docker run --name spt1 -p 3416:3306   -e MYSQL_ROOT_PASSWORD=root -d mysql:5.7 &&\

docker run --name spt2 -p 3426:3306   -e MYSQL_ROOT_PASSWORD=root -d mysql:5.7
```

执行过程如下：

```bash
[root@mycat ~]# docker run --name spt1 -p 3416:3306   -e MYSQL_ROOT_PASSWORD=root -d mysql:5.7 && docker run --name spt2 -p 3426:3306   -e MYSQL_ROOT_PASSWORD=root -d mysql:5.7
c9273c38f676aaf09321c6b117cf9445d5a15a632694480daf02db8cc9352bf6
5b19f22dbefbd00a65aaa6185a0c493518b4d71a5ff10b63f0bef6404efbb9bc
[root@mycat ~]# docker ps
CONTAINER ID   IMAGE       COMMAND                  CREATED         STATUS         PORTS                                                  NAMES
5b19f22dbefb   mysql:5.7   "docker-entrypoint.s…"   4 seconds ago   Up 2 seconds   33060/tcp, 0.0.0.0:3426->3306/tcp, :::3426->3306/tcp   spt2
c9273c38f676   mysql:5.7   "docker-entrypoint.s…"   6 seconds ago   Up 4 seconds   33060/tcp, 0.0.0.0:3416->3306/tcp, :::3416->3306/tcp   spt1
[root@mycat ~]# 
```

### [3.创建数据库、表](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3创建数据库、表)

分别连接两个容器，并执行上述sql脚本用于创建数据库、数据库表。

- 查询两个容器的ip地址

```bash
[root@mycat ~]# docker inspect --format '{{ .NetworkSettings.IPAddress }}'  spt1 | awk '{print "spt1:",$1}' && docker inspect --format '{{ .NetworkSettings.IPAddress }}'  spt2 | awk '{print "spt2:",$1}'

spt1: 172.17.0.2
spt2: 172.17.0.3
[root@mycat ~]# 
```

- 连接容器spt1，执行数据库脚本

```bash
[root@mycat ~]# mysql -uroot -proot -h172.17.0.2 -P 3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.34 MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> /* 创建数据库 */
MySQL [(none)]> CREATE DATABASE boss;
Query OK, 1 row affected (0.00 sec)

MySQL [(none)]> 
MySQL [(none)]> USE boss;
 phone varchar(500) DEFAULT NULL COMMENT '电话号',
  provice varchar(500) DEFAULT NULL COMMENT '所属省份',
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='电信客户信息（手机号）';


/* 手机号通话记录 */
CREATE TABLE calllog (
  id bigint(20) NOT NULL COMMENT 'id',
  phone_id bigint(20) DEFAULT NULL COMMENT '客户手机号外键',
  type varchar(10) DEFAULT NULL COMMENT '通话类型',
  duration bigint(20) DEFAULT NULL COMMENT '通话时长（秒）',
  othernum varchar(20) DEFAULT NULL COMMENT '对方电话号',
  PRIMARY KEY (id),
  KEY FK_Reference_1 (phone_id),
  CONSTRAINT FK_Reference_1 FOREIGN KEY (phone_id) REFERENCES customer (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通话记录';


/* 字典表 */
CREATE TABLE dict (
  id bigint(20) NOT NULL COMMENT 'id',
  caption varchar(100) DEFAULT NULL COMMENT '代码类型名称',
  code varchar(10) DEFAULT NULL COMMENT '代码',
  name varchar(10) DEFAULT NULL COMMENT '名称',
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFDatabase changed
MySQL [boss]> 
MySQL [boss]> /* 客户手机号表 */
MySQL [boss]> CREATE TABLE customer (
    ->   id bigint(20) NOT NULL COMMENT '主键',
    ->   cid bigint(20) DEFAULT NULL COMMENT '客户id',
    ->   name varchar(500) DEFAULT NULL COMMENT '客户名称',
    ->   phone varchar(500) DEFAULT NULL COMMENT '电话号',
    ->   provice varchar(500) DEFAULT NULL COMMENT '所属省份',
    ->   PRIMARY KEY (id)
    -> ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='电信客户信息（手机号）';
AULT CHARSET=utf8mb4 COMMENT='字典表';Query OK, 0 rows affected (0.04 sec)

MySQL [boss]> 
MySQL [boss]> 
MySQL [boss]> /* 手机号通话记录 */
MySQL [boss]> CREATE TABLE calllog (
    ->   id bigint(20) NOT NULL COMMENT 'id',
    ->   phone_id bigint(20) DEFAULT NULL COMMENT '主键',
    ->   type varchar(10) DEFAULT NULL COMMENT '通话类型',
    ->   duration bigint(20) DEFAULT NULL COMMENT '通话时长（秒）',
    ->   othernum varchar(20) DEFAULT NULL COMMENT '对方电话号',
    ->   PRIMARY KEY (id),
    ->   KEY FK_Reference_1 (phone_id),
    ->   CONSTRAINT FK_Reference_1 FOREIGN KEY (phone_id) REFERENCES customer (id)
    -> ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通话记录';
Query OK, 0 rows affected (0.03 sec)

MySQL [boss]> 
MySQL [boss]> 
MySQL [boss]> /* 字典表 */
MySQL [boss]> CREATE TABLE dict (
    ->   id bigint(20) NOT NULL COMMENT 'id',
    ->   caption varchar(100) DEFAULT NULL COMMENT '代码类型名称',
    ->   code varchar(10) DEFAULT NULL COMMENT '代码',
    ->   name varchar(10) DEFAULT NULL COMMENT '名称',
    ->   PRIMARY KEY (id)
    -> ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='字典表';
Query OK, 0 rows affected (0.02 sec)

MySQL [boss]> show tables;
+----------------+
| Tables_in_boss |
+----------------+
| calllog        |
| customer       |
| dict           |
+----------------+
3 rows in set (0.00 sec)

MySQL [boss]> 
```

- 连接容器spt1，执行数据库脚本

```bash
[root@mycat ~]# mysql -uroot -proot -h172.17.0.3 -P 3306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.34 MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> /* 创建数据库 */
MySQL [(none)]> CREATE DATABASE boss;
Query OK, 1 row affected (0.00 sec)

MySQL [(none)]> 
MySQL [(none)]> USE boss;
 phone varchar(500) DEFAULT NULL COMMENT '电话号',
  provice varchar(500) DEFAULT NULL COMMENT '所属省份',
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='电信客户信息（手机号）';


/* 手机号通话记录 */
CREATE TABLE calllog (
  id bigint(20) NOT NULL COMMENT 'id',
  phone_id bigint(20) DEFAULT NULL COMMENT '主键',
  type varchar(10) DEFAULT NULL COMMENT '通话类型',
  duration bigint(20) DEFAULT NULL COMMENT '通话时长（秒）',
  othernum varchar(20) DEFAULT NULL COMMENT '对方电话号',
  PRIMARY KEY (id),
  KEY FK_Reference_1 (phone_id),
  CONSTRAINT FK_Reference_1 FOREIGN KEY (phone_id) REFERENCES customer (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通话记录';


/* 字典表 */
CREATE TABLE dict (
  id bigint(20) NOT NULL COMMENT 'id',
  caption varchar(100) DEFAULT NULL COMMENT '代码类型名称',
  code varchar(10) DEFAULT NULL COMMENT '代码',
  name varchar(10) DEFAULT NULL COMMENT '名称',
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFDatabase changed
MySQL [boss]> 
MySQL [boss]> /* 客户手机号表 */
MySQL [boss]> CREATE TABLE customer (
    ->   id bigint(20) NOT NULL COMMENT '主键',
    ->   cid bigint(20) DEFAULT NULL COMMENT '客户id',
    ->   name varchar(500) DEFAULT NULL COMMENT '客户名称',
    ->   phone varchar(500) DEFAULT NULL COMMENT '电话号',
    ->   provice varchar(500) DEFAULT NULL COMMENT '所属省份',
    ->   PRIMARY KEY (id)
    -> ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='电信客户信息（手机号）';
AULT CHARSET=utf8mb4 COMMENT='字典表';Query OK, 0 rows affected (0.04 sec)

MySQL [boss]> 
MySQL [boss]> 
MySQL [boss]> /* 手机号通话记录 */
MySQL [boss]> CREATE TABLE calllog (
    ->   id bigint(20) NOT NULL COMMENT 'id',
    ->   phone_id bigint(20) DEFAULT NULL COMMENT '主键',
    ->   type varchar(10) DEFAULT NULL COMMENT '通话类型',
    ->   duration bigint(20) DEFAULT NULL COMMENT '通话时长（秒）',
    ->   othernum varchar(20) DEFAULT NULL COMMENT '对方电话号',
    ->   PRIMARY KEY (id),
    ->   KEY FK_Reference_1 (phone_id),
    ->   CONSTRAINT FK_Reference_1 FOREIGN KEY (phone_id) REFERENCES customer (id)
    -> ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通话记录';
Query OK, 0 rows affected (0.03 sec)

MySQL [boss]> 
MySQL [boss]> 
MySQL [boss]> /* 字典表 */
MySQL [boss]> CREATE TABLE dict (
    ->   id bigint(20) NOT NULL COMMENT 'id',
    ->   caption varchar(100) DEFAULT NULL COMMENT '代码类型名称',
    ->   code varchar(10) DEFAULT NULL COMMENT '代码',
    ->   name varchar(10) DEFAULT NULL COMMENT '名称',
    ->   PRIMARY KEY (id)
    -> ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='字典表';
Query OK, 0 rows affected (0.02 sec)

MySQL [boss]> show tables;
+----------------+
| Tables_in_boss |
+----------------+
| calllog        |
| customer       |
| dict           |
+----------------+
3 rows in set (0.00 sec)

MySQL [boss]> 
```

### [4.mycat实现分表](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_4mycat实现分表)

根据需求此处需要将customer 进行水平拆分，并分布到两个数据节点spt1、spt2上。需要做如下修改

- 修改schema.xml

```xml
<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">

    <schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="spt1">
        <!-- 
            rule="customer_rule"  使用的 分片规则，需要在rule.xml中配置
        -->
        <table name="customer" dataNode="spt1,spt2" rule="customer_rule" ></table>
    </schema>

    <dataNode name="spt1" dataHost="host1" database="boss"/>
    <dataNode name="spt2" dataHost="host2" database="boss"/>

    <dataHost name="host1" maxCon="1000" minCon="10" balance="0"
              writeType="0" dbType="mysql" dbDriver="native" switchType="1"
              slaveThreshold="100">
        <heartbeat>select user()</heartbeat>
        <!-- can have multi write hosts -->
        <writeHost host="hostM1" url="172.17.0.2:3306" user="root" password="root">
        </writeHost>
    </dataHost>

    <dataHost name="host2" maxCon="1000" minCon="10" balance="0"
              writeType="0" dbType="mysql" dbDriver="native" switchType="1"
              slaveThreshold="100">
        <heartbeat>select user()</heartbeat>
        <!-- can have multi write hosts -->
        <writeHost host="hostM2" url="172.17.0.3:3306" user="root"  password="root">
        </writeHost>
    </dataHost>

</mycat:schema>
```

- 修改rule.xml配置customer_rule规则

在 rule 配置文件里新增分片规则 customer_rule，并指定规则适用字段为cid，

```xml
<tableRule name="customer_rule">
    <rule>
        <!-- 分片字段-->
         <columns>cid</columns>
        <!-- 分片算法名 -->
         <algorithm>mod-long</algorithm>
    </rule>
 </tableRule>
```

还有选择分片算法 mod-long（对字段求模运算），cid对两个节点求模，根据结果分片

配置算法 mod-long 参数 count 为 2，两个节点

```xml
    <function name="mod-long" class="io.mycat.route.function.PartitionByMod">
        <!-- how many data nodes -->
        <property name="count">2</property>
    </function>
```

配置完的完整的rule.xml如下

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!-- - - Licensed under the Apache License, Version 2.0 (the "License"); 
    - you may not use this file except in compliance with the License. - You 
    may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0 
    - - Unless required by applicable law or agreed to in writing, software - 
    distributed under the License is distributed on an "AS IS" BASIS, - WITHOUT 
    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the 
    License for the specific language governing permissions and - limitations 
    under the License. -->
<!DOCTYPE mycat:rule SYSTEM "rule.dtd">
<mycat:rule xmlns:mycat="http://io.mycat/">
    <tableRule name="customer_rule">
                <rule>
                        <columns>cid</columns>
                        <algorithm>mod-long</algorithm>
                </rule>
        </tableRule>
    <tableRule name="rule1">
        <rule>
            <columns>id</columns>
            <algorithm>func1</algorithm>
        </rule>
    </tableRule>

    <tableRule name="rule2">
        <rule>
            <columns>user_id</columns>
            <algorithm>func1</algorithm>
        </rule>
    </tableRule>

    <tableRule name="sharding-by-intfile">
        <rule>
            <columns>sharding_id</columns>
            <algorithm>hash-int</algorithm>
        </rule>
    </tableRule>
    <tableRule name="auto-sharding-long">
        <rule>
            <columns>id</columns>
            <algorithm>rang-long</algorithm>
        </rule>
    </tableRule>
    <tableRule name="mod-long">
        <rule>
            <columns>id</columns>
            <algorithm>mod-long</algorithm>
        </rule>
    </tableRule>
    <tableRule name="sharding-by-murmur">
        <rule>
            <columns>id</columns>
            <algorithm>murmur</algorithm>
        </rule>
    </tableRule>
    <tableRule name="crc32slot">
        <rule>
            <columns>id</columns>
            <algorithm>crc32slot</algorithm>
        </rule>
    </tableRule>
    <tableRule name="sharding-by-month">
        <rule>
            <columns>create_time</columns>
            <algorithm>partbymonth</algorithm>
        </rule>
    </tableRule>
    <tableRule name="latest-month-calldate">
        <rule>
            <columns>calldate</columns>
            <algorithm>latestMonth</algorithm>
        </rule>
    </tableRule>

    <tableRule name="auto-sharding-rang-mod">
        <rule>
            <columns>id</columns>
            <algorithm>rang-mod</algorithm>
        </rule>
    </tableRule>

    <tableRule name="jch">
        <rule>
            <columns>id</columns>
            <algorithm>jump-consistent-hash</algorithm>
        </rule>
    </tableRule>

    <function name="murmur"
        class="io.mycat.route.function.PartitionByMurmurHash">
        <property name="seed">0</property><!-- 默认是0 -->
        <property name="count">2</property><!-- 要分片的数据库节点数量，必须指定，否则没法分片 -->
        <property name="virtualBucketTimes">160</property><!-- 一个实际的数据库节点被映射为这么多虚拟节点，默认是160倍，也就是虚拟节点数是物理节点数的160倍 -->
        <!-- <property name="weightMapFile">weightMapFile</property> 节点的权重，没有指定权重的节点默认是1。以properties文件的格式填写，以从0开始到count-1的整数值也就是节点索引为key，以节点权重值为值。所有权重值必须是正整数，否则以1代替 -->
        <!-- <property name="bucketMapPath">/etc/mycat/bucketMapPath</property> 
            用于测试时观察各物理节点与虚拟节点的分布情况，如果指定了这个属性，会把虚拟节点的murmur hash值与物理节点的映射按行输出到这个文件，没有默认值，如果不指定，就不会输出任何东西 -->
    </function>

    <function name="crc32slot"
              class="io.mycat.route.function.PartitionByCRC32PreSlot">
        <property name="count">2</property><!-- 要分片的数据库节点数量，必须指定，否则没法分片 -->
    </function>
    <function name="hash-int"
        class="io.mycat.route.function.PartitionByFileMap">
        <property name="mapFile">partition-hash-int.txt</property>
    </function>
    <function name="rang-long"
        class="io.mycat.route.function.AutoPartitionByLong">
        <property name="mapFile">autopartition-long.txt</property>
    </function>
    <function name="mod-long" class="io.mycat.route.function.PartitionByMod">
        <!-- how many data nodes -->
        <property name="count">2</property>
    </function>

    <function name="func1" class="io.mycat.route.function.PartitionByLong">
        <property name="partitionCount">8</property>
        <property name="partitionLength">128</property>
    </function>
    <function name="latestMonth"
        class="io.mycat.route.function.LatestMonthPartion">
        <property name="splitOneDay">24</property>
    </function>
    <function name="partbymonth"
        class="io.mycat.route.function.PartitionByMonth">
        <property name="dateFormat">yyyy-MM-dd</property>
        <property name="sBeginDate">2015-01-01</property>
    </function>

    <function name="rang-mod" class="io.mycat.route.function.PartitionByRangeMod">
            <property name="mapFile">partition-range-mod.txt</property>
    </function>

    <function name="jump-consistent-hash" class="io.mycat.route.function.PartitionByJumpConsistentHash">
        <property name="totalBuckets">3</property>
    </function>
</mycat:rule>
```

> 启动Mycat，登录Mycat插入数据进行验证

```sql
insert into customer (id, cid, name, phone, provice) values('1','1','张飞','13800000001','燕人');
insert into customer (id, cid, name, phone, provice) values('2','2','赵云','13800000002','真定');
insert into customer (id, cid, name, phone, provice) values('3','3','诸葛亮','13800000003','沂南');
insert into customer (id, cid, name, phone, provice) values('4','4','关羽','13800000004','运城');
insert into customer (id, cid, name, phone, provice) values('5','5','刘玄德','13800000005','涿州');
insert into customer (id, cid, name, phone, provice) values('6','6','孙策','13800000006','东吴');
```

插入数据后在Mycat客户端、数据节点spt1、sp2上分别执行查询发现

- 数据节点spt1、spt2分别保存一部分数据
- mycat客户端可以查询出所有数据

![img](https://jshand.gitee.io/imgs/mycat/2021-06-19_155318.png)

需要注意的点，mycat插入时根据字段分片，需要提供字段枚举

> 正确的插入sql

```
insert into customer (id, cid, name, phone, provice) values('5','5','刘玄德','13800000005','涿州');
```

> 错误的sql

```
insert into customer  values('6','6','孙策','13800000006','东吴');
```

不提供列的枚举会报如下错误

```bash
MySQL [TESTDB]> insert into customer  values('6','6','孙策','13800000006','东吴');
ERROR 1064 (HY000): partition table, insert must provide ColumnList
```

## [12.3 Mycat 的分片 join](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_123-mycat-的分片-join)

Join 绝对是关系型数据库中最常用一个特性，然而在分布式环境中,跨分片的 join 确是最复杂的，最难解决一

个问题。

> Mycat性能建议

尽量避免使用 Left join 或 Right join,而用 Inner join

在使用 Left join 或 Right join 时，ON 会优先执行，where 条件在最后执行，所以在使用过程中，条件尽

可能的在 ON 语句中判断，减少 where 的执行

少用子查询，而用 join。

Mycat 目前版本支持跨分片的 join,主要实现的方式有四种。

全局表，ER 分片，catletT(人工智能)和 ShareJoin，ShareJoin 在开发版中支持，前面三种方式 1.3.0.1 支

持。

## [12.4 ER分片](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_124-er分片)

MyCAT 借鉴了 NewSQL 领域的新秀 Foundation DB 的设计思路，Foundation DB 创新性的提出了 Table

Group 的概念，其将子表的存储位置依赖于主表，并且物理上紧邻存放，因此彻底解决了 JION 的效率和性能问

题，根据这一思路，提出了基于 E-R 关系的数据分片策略，子表的记录与所关联的父表记录存放在同一个数据分

片上。

customer(客户手机账户表) 采用 按照客户id取模 这个分片策略，分片在 spt1,spt2 上，calllog（呼叫记录表） 依赖父表进行分片，两个

表的关联关系为 customer.id =calllog.phone_id。于是数据分片和存储的示意图如下：

![img](https://jshand.gitee.io/imgs/mycat/2021-06-19_163312.png)

这样一来，分片 spt1 上的的 customer 与 spt1 上的 calllog 就可以进行局部的 JOIN 联合，spt2(...sptn) 上也如此，再合并两个节点的数据即可完成整体的 JOIN，基于 E-R 映射的数据分片模式，基本上解决了 80%以上的企业应用所面临的问题。

> 实现

修改schema.xml文件，在上次配置基础上修改table标签，在customer 表下添加子标签

```
<childTable name="calllog" primaryKey="id" joinKey="id" parentKey="phone_id" />
```

完整的schema.xml文件如下：

```xml
<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">

    <schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="spt1">
        <!-- 
                         rule="customer_rule"  自定义的 分片规则，需要在rule.xml中配置
        -->
        <table name="customer" dataNode="spt1,spt2" rule="customer_rule" >
            <!-- 
                name="calllog"          子表（从表）名称
                primaryKey="id"         子表（从表）主键
                joinKey="phone_id"        从表中记录的外键（calllog.phone_id）
                parentKey="id"            主表主键（customer.id）
            -->
            <childTable name="calllog" primaryKey="id" joinKey="phone_id" parentKey="id" />
        </table>
    </schema>

    <dataNode name="spt1" dataHost="host1" database="boss"/>
    <dataNode name="spt2" dataHost="host2" database="boss"/>

    <dataHost name="host1" maxCon="1000" minCon="10" balance="0"
              writeType="0" dbType="mysql" dbDriver="native" switchType="1"
              slaveThreshold="100">
        <heartbeat>select user()</heartbeat>
        <!-- can have multi write hosts -->
        <writeHost host="hostM1" url="172.17.0.2:3306" user="root" password="root">
        </writeHost>
    </dataHost>

    <dataHost name="host2" maxCon="1000" minCon="10" balance="0"
              writeType="0" dbType="mysql" dbDriver="native" switchType="1"
              slaveThreshold="100">
        <heartbeat>select user()</heartbeat>
        <!-- can have multi write hosts -->
        <writeHost host="hostM2" url="172.17.0.3:3306" user="root"  password="root">
        </writeHost>
    </dataHost>

</mycat:schema>
```

重新启动mycat（加载配置），登录mycat插入数据

```xml
insert into calllog (id, phone_id, type, duration, othernum) values('1','1','01','77','15800000001');
insert into calllog (id, phone_id, type, duration, othernum) values('2','1','02','45','15800000002');
insert into calllog (id, phone_id, type, duration, othernum) values('3','2','01','38','15800000003');
insert into calllog (id, phone_id, type, duration, othernum) values('4','2','02','64','15800000004');
insert into calllog (id, phone_id, type, duration, othernum) values('5','3','01','57','15800000005');
insert into calllog (id, phone_id, type, duration, othernum) values('6','3','02','88','15800000006');
insert into calllog (id, phone_id, type, duration, othernum) values('7','4','01','88','15800000007');
insert into calllog (id, phone_id, type, duration, othernum) values('8','4','02','69','15800000008');
insert into calllog (id, phone_id, type, duration, othernum) values('9','5','01','23','15800000009');
insert into calllog (id, phone_id, type, duration, othernum) values('10','5','02','46','15800000010');
insert into calllog (id, phone_id, type, duration, othernum) values('11','6','01','45','15800000011');
insert into calllog (id, phone_id, type, duration, othernum) values('12','6','02','77','15800000012');
```

分别在mycat、数据节点spt1、spt2使用join查询

```sql
SELECT 
  cus.id,
  cus.name '客户名称',
  log.type '通话类型',
  log.othernum '对方电话号' 
FROM
  customer cus 
  INNER JOIN calllog log
    ON cus.id = log.phone_id 
ORDER BY cus.id ;
```

![img](https://jshand.gitee.io/imgs/mycat/2021-06-19_171022.png)

## [12.5 全局表](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_125-全局表)

### [1.介绍](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1介绍)

前几章节已经实现了表的的水平划分（分表）。上述表中还有一个dict(字典表)存储的是一些系统中常用的数据字典，如代表通话类型的代码（01：呼入，02：呼出），这张表如果单独在某一个数据节点（如：spt1）上，会导致另外数据节点（如：spt2）上的数据无法关联查询

一个真实的业务系统中，往往存在大量的类似字典表的表，这些表基本上很少变动，字典表具有以下几个特

性：

• 变动不频繁；

• 数据量总体变化不大；

• 数据规模不大，很少有超过数十万条记录。

对于这类的表，在分片的情况下，当业务表因为规模而进行分片以后，业务表与这些附属的字典表之间的关

联，就成了比较棘手的问题，所以 Mycat 中通过数据冗余来解决这类表的 join，即所有的分片都有一份数据的拷

贝，所有将字典表或者符合字典表特性的一些表定义为全局表。

数据冗余是解决跨分片数据 join 的一种很好的思路，也是数据切分规划的另外一条重要规则。

### [2.实现](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2实现)

修改 schema.xml 配置文件，添加table节点并设置为global类型

```xml
<table name="dict" dataNode="spt1,spt2" type="global" ></table>
```

全量配置文件如下：

```xml
<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">

    <schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="spt1">
        <!-- 
                         rule="customer_rule"  自定义的 分片规则，需要在rule.xml中配置
        -->
        <table name="customer" dataNode="spt1,spt2" rule="customer_rule" >
            <!-- 
                name="calllog"          子表（从表）名称
                primaryKey="id"         子表（从表）主键
                joinKey="phone_id"        从表中记录的外键（calllog.phone_id）
                parentKey="id"            主表主键（customer.id）
            -->
            <childTable name="calllog" primaryKey="id" joinKey="phone_id" parentKey="id" />
        </table>

        <!-- 
            设置 dict表为  global全局表，并在spt1、spt2两个数据节点冗余（内容重复）存在
        -->
        <table name="dict" dataNode="spt1,spt2" type="global" ></table>

    </schema>

    <dataNode name="spt1" dataHost="host1" database="boss"/>
    <dataNode name="spt2" dataHost="host2" database="boss"/>

    <dataHost name="host1" maxCon="1000" minCon="10" balance="0"
              writeType="0" dbType="mysql" dbDriver="native" switchType="1"
              slaveThreshold="100">
        <heartbeat>select user()</heartbeat>
        <!-- can have multi write hosts -->
        <writeHost host="hostM1" url="172.17.0.2:3306" user="root" password="root">
        </writeHost>
    </dataHost>

    <dataHost name="host2" maxCon="1000" minCon="10" balance="0"
              writeType="0" dbType="mysql" dbDriver="native" switchType="1"
              slaveThreshold="100">
        <heartbeat>select user()</heartbeat>
        <!-- can have multi write hosts -->
        <writeHost host="hostM2" url="172.17.0.3:3306" user="root"  password="root">
        </writeHost>
    </dataHost>

</mycat:schema>
```

### [3.验证全局表](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3验证全局表)

登录mycat插入字典表的数据

```sql
insert into dict (id, caption, code, name) values('1','ptype','01','呼出');
insert into dict (id, caption, code, name) values('2','ptype','02','呼入');
```

分别在mycat客户端、数据节点spt1、spt2中查询关联dict表的sql

```sql
SELECT 
  cus.id,
  cus.name '客户名称',
  dict.name '通话类型', 
  log.othernum '对方电话号' 
FROM
  customer cus 
  INNER JOIN calllog log
    ON cus.id = log.phone_id 
  INNER JOIN dict ON dict.caption='ptype' AND dict.code = log.type
ORDER BY cus.id ;
```

![img](https://jshand.gitee.io/imgs/mycat/2021-06-19_174144.png)

# [13. 其它分片规则](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_13-其它分片规则)

常用的数据库分片规则在mycat中有如下几种实现

```bash
PartitionByCRC32PreSlot.java
PartitionByDate.java
PartitionByFileMap.java
PartitionByHashMod.java
PartitionByHotDate.java
PartitionByJumpConsistentHash.java
PartitionByLong.java
PartitionByMod.java
PartitionByMonth.java
PartitionByMurmurHash.java
PartitionByPattern.java
PartitionByPrefixPattern.java
PartitionByRangeDateHash.java
PartitionByRangeMod.java
PartitionByString.java
PartitionDirectBySubString.java
```

> 数据库表结构

为了验证常用的几种分片规则，此处模拟挂号模块维护挂号患者信息创建如下表

ps：配置完规则后在mycat中执行即可，好处是可以不用登录多个数据节点挨个创建)

```sql
create table register
(
   id                   bigint not null comment '主键',
   name                 varchar(200) comment '姓名',
   age                  int comment '年龄',
   gender               varchar(10) comment '性别 01：男，02：女',
   birthday             date comment '出生日期',
   primary key (id)
);

alter table register comment '挂号患者';
```

## [1.取 模](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1取-模)

此规则为对分片字段求摸运算。上一大章节已经说明，此处不再赘述。

## [2.分片枚举](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2分片枚举)

通过在配置文件中配置可能的枚举 id，自己配置分片，本规则适用于特定的场景，比如有些业务需要按照省

份或区县来做保存，而全国省份区县固定的，这类业务使用本条规则

> 此处模拟挂号患者按照性别枚举，‘男’：存储到第一个数据节点，女存储到第二个数据节点

### [1.配置schema.xml](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1配置schemaxml)

在schema.xml中添加table标签`<table name="register" dataNode="spt1,spt2" rule="slice_by_enum"></table>`

### [2.修改rule.xml](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2修改rulexml)

添加`tableRule`标签

```xml
<tableRule name="slice_by_enum">
    <rule>
        <!-- 分片字段-->
         <columns>gender</columns>
        <!-- 分片算法名 -->
         <algorithm>hash-int</algorithm>
    </rule>
 </tableRule>
<!-- .......此处省略一部分代码 -->
<function name="hash-int"
                class="io.mycat.route.function.PartitionByFileMap">
                <!--分片字段和数据节点对应关系，在txt文档中以属性文件形式存在 -->
                <property name="mapFile">partition-hash-int.txt</property>

                <!--分片字段类型，0：数字（默认） 1（非零）：表示字符串 -->
                <property name="type">1</property>

                <!-- 默认数据节点，从0开始，如果不设置默认数据节点，当找分片字段的值不在定义规则范围内，则插入会报错-->
                <property name="defaultNode">0</property>
        </function>
```

上面 columns 标识将要分片的表字段，algorithm 分片函数，

其中分片函数配置中:

-  mapFile 标识配置文件名称，
- type 默认值为 0，0 表示 Integer，非零表示 String，

所有的节点配置都是从 0 开始，及 0 代表节点 1

```java
/**
* defaultNode 默认节点:小于 0 表示不设置默认节点，大于等于 0 表示设置默认节点
* 默认节点的作用：枚举分片时，如果碰到不识别的枚举值，就让它路由到默认节点
* 如果不配置默认节点（defaultNode 值小于 0 表示不配置默认节点），碰到
* 不识别的枚举值就会报错，
* like this：can’t find datanode for sharding column:column_nameval:ffffffff
*/
```

编辑`partition-hash-int.txt`

```properties
男=0
女=1
```

重启mycat

```bash
./mycat console
```

登录mycat创建表

```sql
create table register
(
   id                   bigint not null comment '主键',
   name                 varchar(200) comment '姓名',
   age                  int comment '年龄',
   gender               varchar(10) comment '性别 01：男，02：女',
   birthday             date comment '出生日期',
   primary key (id)
);

alter table register comment '挂号患者';
```

在mycat中插入数据库

```xml
insert into register (id, name, age, gender, birthday) values('1','aaaa','44','01','1906-06-19');
insert into register (id, name, age, gender, birthday) values('2','bbbb','45','01','1906-06-19');
insert into register (id, name, age, gender, birthday) values('3','cccc','46','02','1906-06-19');
insert into register (id, name, age, gender, birthday) values('4','dddd','47','02','1906-06-19');
```

分别在mycat中、数据节点spt1、spt2中查询数据

```
select * from register order by name;
```

![img](https://jshand.gitee.io/imgs/mycat/2021-06-19_235338.png)

## [3.范围约定](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3范围约定)

此分片适用于，提前规划好分片字段某个范围属于哪个分片，

start-end=dataNodeIndex，例如`0-100：0`,`101-200：1` 其中如果数量级比较大可以使用`K`、`M`等简写K=1000,M=10000。

```xml
<tableRule name="auto-sharding-long">
    <rule>
        <columns>user_id</columns>
        <algorithm>rang-long</algorithm>
    </rule>
</tableRule>
<function name="rang-long" class="io.mycat.route.function.AutoPartitionByLong">
    <property name="mapFile">autopartition-long.txt</property>
    <property name="defaultNode">0</property>
</function>
```

配置说明：

上面 columns 标识将要分片的表字段，algorithm 分片函数，

rang-long 函数中 mapFile 代表配置文件路径

defaultNode 超过范围后的默认节点。

所有的节点配置都是从 0 开始，及 0 代表节点 1，此配置非常简单，即预先制定可能的 id 范围到某个分片

0-500M=0

500M-1000M=1

1000M-1500M=2

或

0-10000000=0

10000001-20000000=1

### [1. 验证](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1-验证)

此处还是以患者表为例，其中按照年龄分段

- 0-45：使用数据节点0存储
- 46-150：使用数据节点1存储
- 超过范围的使用数据节点0存储

先删除register表中的数据

```
delete from register;
```

### [2.修改schema.xml](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2修改schemaxml-1)

重新定义register表的分片规则名"slice_by_range"

```xml
<table name="register" dataNode="spt1,spt2" rule="slice_by_range" ></table>
```

### [3.修改rule.xml](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3修改rulexml)

在rule中添加新的分片规则,名字为上述的“slice_by_range”。

```xml
<!-- name: 在schema中表使用的分片规则名称 -->
<tableRule name="slice_by_range">
    <rule>
        <columns>age</columns>
        <!-- 分片规则算法名称-->
        <algorithm>rang-long</algorithm>
    </rule>
</tableRule>
```

配置name为“rang-long”的function标签，添加`defaultNode`属性

```xml
<function name="rang-long" class="io.mycat.route.function.AutoPartitionByLong">
    <property name="mapFile">autopartition-long.txt</property>
    <!-- 默认数据节点，从0开始，如果不设置默认数据节点，当找分片字段的值不在定义规则范围内，则插入会报错-->
    <property name="defaultNode">0</property>
</function>
```

### [4.编辑autopartition-long.txt](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_4编辑autopartition-longtxt)

配置范围规则

- 0-45：使用数据节点0存储
- 46-150：使用数据节点1存储
- 超过范围的使用数据节点0存储

```properties
0-45=0
46-150=1
```

### [5.插入数据](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_5插入数据)

分别插入小于45的年龄，小于150的年龄以及大于150年龄的患者信息

```sql
insert into register (id, name, age, gender, birthday) values('1','aaaa',42,'01','1906-06-19');
insert into register (id, name, age, gender, birthday) values('2','bbbb',43,'01','1906-06-19');

insert into register (id, name, age, gender, birthday) values('3','cccc',60,'02','1906-06-19');
insert into register (id, name, age, gender, birthday) values('4','dddd',70,'02','1906-06-19');

insert into register (id, name, age, gender, birthday) values('5','eeee',160,'02','1906-06-19');
```

### [6.查询](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_6查询)

分别在mycat客户端，spt1、spt2上查询数据验证分片结果

```sql
select * from register order by age;
```

![img](https://jshand.gitee.io/imgs/mycat/2021-06-20_003448.png)

## [4.按日期（天、月）分片](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_4按日期（天、月）分片)

### [1.修改schema.xml](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1修改schemaxml)

```xml
<table name="register" dataNode="spt1,spt2" rule="slice_by_date" ></table>
```

### [2.修改rule.xml](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2修改rulexml-1)

添加规则名称为“slice_by_data”的算法

```xml
<!-- name: 在schema中表使用的分片规则名称 -->
<tableRule name="slice_by_date">
    <rule>
        <columns>birthday</columns>
        <!-- 分片规则算法名称-->
        <algorithm>sliceByDate</algorithm>
    </rule>
</tableRule>
```

编辑function

```xaml
<!-- 按照时间日期分片
        - columns：分片字段，algorithm：分片函数
        - dateFormat ：日期格式sBeginDate ：开始日期
        - sEndDate：结束日期,则代表数据达到了这个日期的分片后循环从开始分片插入
        - sPartionDay ：分区天数，即默认从开始日期算起，分隔 2 天一个分区
    -->
    <function name="sliceByDate" class="io.mycat.route.function.PartitionByDate">
        <property name="dateFormat">yyyy-MM-dd</property>
        <property name="sBeginDate">2021-06-21</property>
        <property name="sEndDate">2021-06-30</property>
        <property name="sPartionDay">2</property> 
    </function>
```

- columns：分片字段，algorithm：分片函数
- dateFormat ：日期格式sBeginDate ：开始日期
- sEndDate：结束日期,则代表数据达到了这个日期的分片后循环从开始分片插入
- sPartionDay ：分区天数，即默认从开始日期算起，分隔 2 天一个分区

### [3.重启mycat，插入数据测试](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3重启mycat，插入数据测试)

```sql
insert into register (id, name, age, gender, birthday) values('1','aaaa',42,'01','2021-06-21');
insert into register (id, name, age, gender, birthday) values('2','bbbb',43,'01','2021-06-22');
insert into register (id, name, age, gender, birthday) values('3','cccc',60,'02','2021-06-23');
insert into register (id, name, age, gender, birthday) values('4','dddd',70,'02','2021-06-24');
insert into register (id, name, age, gender, birthday) values('5','eeee',40,'02','2021-06-25');
```

数据节点1：

```bash
MySQL [boss]> select * from register;
+----+------+------+--------+------------+
| id | name | age  | gender | birthday   |
+----+------+------+--------+------------+
|  1 | aaaa |   42 | 01     | 2021-06-21 |
|  3 | cccc |   60 | 02     | 2021-06-23 |
|  5 | eeee |   40 | 02     | 2021-06-25 |
+----+------+------+--------+------------+
3 rows in set (0.01 sec)

MySQL [boss]> 
```

数据节点2：

```bash
MySQL [boss]> select * from register;
+----+------+------+--------+------------+
| id | name | age  | gender | birthday   |
+----+------+------+--------+------------+
|  2 | bbbb |   43 | 01     | 2021-06-22 |
|  4 | dddd |   70 | 02     | 2021-06-24 |
+----+------+------+--------+------------+
2 rows in set (0.00 sec)

MySQL [boss]> 
```

Mycat客户端

```bash
MySQL [TESTDB]> select * from register;
+----+------+------+--------+------------+
| id | name | age  | gender | birthday   |
+----+------+------+--------+------------+
|  2 | bbbb |   43 | 01     | 2021-06-22 |
|  4 | dddd |   70 | 02     | 2021-06-24 |
|  1 | aaaa |   42 | 01     | 2021-06-21 |
|  3 | cccc |   60 | 02     | 2021-06-23 |
|  5 | eeee |   40 | 02     | 2021-06-25 |
+----+------+------+--------+------------+
5 rows in set (0.09 sec)

MySQL [TESTDB]> 
```

## [5. 固定分片 hash 算法](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_5-固定分片-hash-算法)

本条规则类似于十进制的求模运算，区别在于是二进制的操作,是取 id 的二进制低 10 位，即 id 二进制

&1111111111。

此算法的优点在于如果按照 10 进制取模运算，在连续插入 1-10 时候 1-10 会被分到 1-10 个分片，增

大了插入的事务控制难度，而此算法根据二进制则可能会分到连续的分片，减少插入事务事务控制难度。

```xml
<tableRule name="rule1">
    <rule>
        <columns>user_id</columns>
        <algorithm>func1</algorithm>
</rule>
</tableRule>
<function name="func1" class="io.mycat.route.function.PartitionByLong">
    <property name="partitionCount">2,1</property>
    <property name="partitionLength">256,512</property>
</function>
```

配置说明：

上面 columns 标识将要分片的表字段，algorithm 分片函数，

partitionCount 分片个数列表，partitionLength 分片范围列表

分区长度:默认为最大 2^n=1024 ,即最大支持 1024 分区

约 束 :

count,length 两个数组的长度必须是一致的。

1024 = sum((count[i]*length[i])). count 和 length 两个向量的点积恒等于 1024

用法例子：

本例的分区策略：希望将数据水平分成 3 份，前两份各占 25%，第三份占 50%。（故本例非均匀分区）

// |<———————1024———————————>|

117 // |<—-256—>|<—-256—>|<———-512————->|

// | partition0 | partition1 | partition2 |

// | 共 2 份,故 count[0]=2 | 共 1 份，故 count[1]=1 |

int[] count = new int[] { 2, 1 };

int[] length = new int[] { 256, 512 };

PartitionUtil pu = new PartitionUtil(count, length);

```java
// 下面代码演示分别以 offerId 字段或 memberId 字段根据上述分区策略拆分的分配结果
int DEFAULT_STR_HEAD_LEN = 8; // cobar 默认会配置为此值
long offerId = 12345;
String memberId = "qiushuo";
// 若根据 offerId 分配，partNo1 将等于 0，即按照上述分区策略，offerId 为 12345 时将会被分配
到 partition0 中
int partNo1 = pu.partition(offerId);
// 若根据 memberId 分配，partNo2 将等于 2，即按照上述分区策略，memberId 为 qiushuo 时将会被
分到 partition2 中
int partNo2 = pu.partition(memberId, 0, DEFAULT_STR_HEAD_LEN);
```

如果需要平均分配设置：平均分为 4 分片，partitionCount*partitionLength=1024

```xml
<function name="func1" class="io.mycat.route.function.PartitionByLong">
    <property name="partitionCount">4</property>
    <property name="partitionLength">256</property>
</function>
```

## [6.取模范围约束](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_6取模范围约束)

此种规则是取模运算与范围约束的结合，主要为了后续数据迁移做准备，即可以自主决定取模后数据的节点

分布。

实现类：

> io.mycat.route.function.PartitionByPattern

## [7.截取数字做 hash 求模范围约束](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_7截取数字做-hash-求模范围约束)

此种规则类似于取模范围约束，此规则支持数据符号字母取模。

实现类：

> io.mycat.route.function.PartitionByPrefixPattern

## [8.应用指定](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_8应用指定)

此规则是在运行阶段有应用自主决定路由到那个分片。

实现类：

> io.mycat.route.function.PartitionDirectBySubString

## [9.截取数字 hash 解析](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_9截取数字-hash-解析)

此规则是截取字符串中的 int 数值 hash 分片。

实现类：

> io.mycat.route.function.PartitionByString

## [10.一致性 hash](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_10一致性-hash)

一致性 hash 预算有效解决了分布式数据的扩容问题。

实现类：

> io.mycat.route.function.PartitionByMurmurHash

## [11.按单月小时拆分](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_11按单月小时拆分)

此规则是单月内按照小时拆分，最小粒度是小时，可以一天最多 24 个分片，最少 1 个分片，一个月完后下月

从头开始循环。

每个月月尾，需要手工清理数据。

实现类：

> io.mycat.route.function.LatestMonthPartion

## [12.范围求模分片](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_12范围求模分片)

先进行范围分片计算出分片组，组内再求模

优点可以避免扩容时的数据迁移，又可以一定程度上避免范围分片的热点问题

综合了范围分片和求模分片的优点，分片组内使用求模可以保证组内数据比较均匀，分片组之间是范围分片可以

兼顾范围查询。

最好事先规划好分片的数量，数据扩容时按分片组扩容，则原有分片组的数据不需要迁移。由于分片组内数据比

较均匀，所以分片组内可以避免热点数据问题

实现类：

> io.mycat.route.function.PartitionByRangeMod

## [13. 日期范围 hash 分片](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_13-日期范围-hash-分片)

思想与范围求模一致，当由于日期在取模会有数据集中问题，所以改成 hash 方法。

先根据日期分组，再根据时间 hash 使得短期内数据分布的更均匀

优点可以避免扩容时的数据迁移，又可以一定程度上避免范围分片的热点问题

要求日期格式尽量精确些，不然达不到局部均匀的目的

实现类：

> io.mycat.route.function.PartitionByRangeDateHash

## [14.冷热数据分片](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_14冷热数据分片)

根据日期查询日志数据 冷热数据分布 ，最近 n 个月的到实时交易库查询，超过 n 个月的按照 m 天分片。

实现类：

> io.mycat.route.function.PartitionByHotDate

# [14.全局序列号](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_14全局序列号)

在实现分库分表的情况下，数据库自增主键已无法保证自增主键的全局唯一。为此，MyCat 提供了全局

sequence，并且提供了包含本地配置和数据库配置等多种实现方式。

## [1.本地文件方式](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1本地文件方式)

**原理：**此方式 MyCAT 将 sequence 配置到文件中，当使用到 sequence 中的配置后，MyCAT 会更下

classpath 中的 sequence_conf.properties 文件中 sequence 当前的值。

**配置方式：**

在 sequence_conf.properties 文件中做如下配置：

GLOBAL_SEQ.HISIDS=

GLOBAL_SEQ.MINID=1001

GLOBAL_SEQ.MAXID=1000000000

GLOBAL_SEQ.CURID=1000

其中 HISIDS 表示使用过的历史分段(一般无特殊需要可不配置)，MINID 表示最小 ID 值，MAXID 表示最大

ID 值，CURID 表示当前 ID 值。

**server.xml 中配置：**

```
<system><property name="sequnceHandlerType">0</property></system>
```

注：sequnceHandlerType 需要配置为 0，表示使用本地文件方式。

**使用示例：**

```
insert into table1(id,name) values(next value for MYCATSEQ_GLOBAL,‘test’);
```

**缺点**：当 MyCAT 重新发布后，配置文件中的 sequence 会恢复到初始值。

**优点**：本地加载，读取速度较快。

## [2. 数据库方式](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2-数据库方式)

### [原理](https://jshand.gitee.io/#/course/internet_arch/mycat?id=原理)

在数据库中建立一张表，存放 sequence 名称(name)，sequence 当前值(current_value)，步长(increment

int 类型每次读取多少个 sequence，假设为 K)等信息；

### [Sequence 获取步骤：](https://jshand.gitee.io/#/course/internet_arch/mycat?id=sequence-获取步骤：)

1).当初次使用该 sequence 时，根据传入的 sequence 名称，从数据库这张表中读取 current_value，和

increment 到 MyCat 中，并将数据库中的 current_value 设置为原 current_value 值+increment 值。

.MyCat 将读取到 current_value+increment 作为本次要使用的 sequence 值，下次使用时，自动加 1，当

使用 increment 次后，执行步骤 1)相同的操作。

MyCat 负责维护这张表，用到哪些 sequence，只需要在这张表中插入一条记录即可。若某次读取的

sequence 没有用完，系统就停掉了，则这次读取的 sequence 剩余值不会再使用。

配置方式：

server.xml 配置：

```
<system><property name="sequnceHandlerType">1</property></system>
```

注：sequnceHandlerType 需要配置为 1，表示使用数据库方式生成 sequence。

**数据库配置：**

#### [1) 创建 MYCAT_SEQUENCE 表](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1-创建-mycat_sequence-表)

– 创建存放 sequence 的表

DROP TABLE IF EXISTS MYCAT_SEQUENCE;

– name sequence 名称

– current_value 当前 value

– increment 增长步长! 可理解为 mycat 在数据库中一次读取多少个 sequence. 当这些用完后, 下次再从数

据库中读取。

```sql
CREATE TABLE MYCAT_SEQUENCE (
    name VARCHAR(50) NOT NULL,
    current_value INT NOT NULL,
    increment INT NOT NULL DEFAULT 100,
    PRIMARY KEY(name)
) ENGINE=InnoDB;
```

– 插入一条 sequence (全局)

```sql
INSERT INTO MYCAT_SEQUENCE(name,current_value,increment) VALUES ('GLOBAL', 100000,100);
```

#### [2) 创建相关 function](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2-创建相关-function)

获取当前 sequence 的值 (返回当前值,增量)

```sql
DELIMITER $$

CREATE FUNCTION mycat_seq_currval (seq_name VARCHAR (50)) RETURNS VARCHAR (64) DETERMINISTIC 
BEGIN
  DECLARE retval VARCHAR (64) ;
  SET retval = "-999999999,null" ;
  SELECT 
    CONCAT(
      CAST(current_value AS CHAR),
      ",",
      CAST(increment AS CHAR)
    ) INTO retval 
  FROM
    MYCAT_SEQUENCE 
  WHERE NAME = seq_name ;
  RETURN retval ;
END $$

DELIMITER ;
```

– 设置 sequence 值

```sql
DELIMITER $$

CREATE FUNCTION mycat_seq_setval (seq_name VARCHAR (50), VALUE INTEGER) RETURNS VARCHAR (64) DETERMINISTIC 
BEGIN
  UPDATE 
    MYCAT_SEQUENCE 
  SET
    current_value = VALUE 
  WHERE NAME = seq_name ;
  RETURN mycat_seq_currval (seq_name) ;
END $$

DELIMITER ;
```

– 获取下一个 sequence 值

```sql
DELIMITER $$

CREATE FUNCTION mycat_seq_nextval (seq_name VARCHAR (50)) RETURNS VARCHAR (64) DETERMINISTIC 
BEGIN
  UPDATE 
    MYCAT_SEQUENCE 
  SET
    current_value = current_value + increment 
  WHERE NAME = seq_name ;
  RETURN mycat_seq_currval (seq_name) ;
END $$

DELIMITER ;
```

#### [3) 设置序列初始值](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3-设置序列初始值)

```sql
INSERT INTO MYCAT_SEQUENCE(NAME,current_value,increment) VALUES ('REGISTER', 400000,
100);
```

#### [4) sequence_db_conf.properties](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_4-sequence_db_confproperties)

相关配置,指定 sequence 相关配置在哪个节点上：

例如：

```properties
#sequence stored in datanode
GLOBAL=dn1
REGISTER=dn1
```

注意：MYCAT_SEQUENCE 表和以上的 3 个 function，需要放在同一个节点上。function 请直接在具体节

点的数据库上执行，如果执行的时候报：

you might want to use the less safe log_bin_trust_function_creators variable

需要对数据库做如下设置：

windows 下 my.ini[mysqld]加上 log_bin_trust_function_creators=1

linux 下/etc/my.cnf 下 my.ini[mysqld]加上 log_bin_trust_function_creators=1

修改完后，即可在 mysql 数据库中执行上面的函数。

#### [5) 修改server.xml](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_5-修改serverxml)

> 修改sequnceHandlerType为1
>
> 全局序列类型：0-本地文件，1-数据库方式，2-时间戳方式。此处应该修改成1

```xml
<property name="sequnceHandlerType">1</property>
```

#### [6) 使用示例：](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_6-使用示例：)

在需要序列号的字段位置 使用` NEXT VALUE FOR MYCATSEQ_REGISTER`进行站位，其中`REGISTER`即为`MYCAT_SEQUENCE`序号表中的name

```sql
insert into table1(id,name) values(next value for MYCATSEQ_GLOBAL,‘test’)；
```

### [3.本地时间戳方式](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3本地时间戳方式)

ID= 64 位二进制 (42(毫秒)+5(机器 ID)+5(业务编码)+12(重复累加)

换算成十进制为 18 位数的 long 类型，每毫秒可以并发 12 位二进制的累加。

使用方式：

> a. 配 置 server.xml

```
<property name="sequnceHandlerType">2</property>
```

> b. 在 mycat 下配置：sequence_time_conf.properties

```properties
WORKID=0-31 任意整数

DATAACENTERID=0-31 任意整数
```

多个个 mycat 节点下每个 mycat 配置的 WORKID，DATAACENTERID 不同，组成唯一标识，总共支持

32*32=1024 种组合。

ID 示例：56763083475511

# [15.高可用](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_15高可用)

mycat可以实现mysql的高可用，那么mycat本身有时也需要提供高可用策略，可以采用HAProxy、keeplived等软件进行实现。

- HAProxy
- Keepalived

具体实现可以参考CSDN文章(基于Docker容器)：

https://blog.csdn.net/weixin_32822759/article/details/106590268

# [16.Mycat权限配置](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_16mycat权限配置)

server.xml 几乎保存了所有 mycat 需要的系统配置信息。其在代码内直接的映射类为 SystemConfig 类。

## [1. user标签权限控制](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1-user标签权限控制)

目前 Mycat 对于中间件的连接控制并没有做太复杂的控制，目前只做了中间件逻辑库级别的读

写权限控制。是通过 server.xml 的 user 标签进行配置。

```xml
<user name="mycat">
    <property name="password">mycat</property>
    <property name="schemas">TESTDB</property>
    <property name="readOnly">true</property>
</user>
<user name="mycat2">
    <property name="password">mycat</property>
    <property name="schemas">order</property>
</user>
```

配置说明：

配置中 name 是应用连接中间件逻辑库的用户名。

mycat 中 password 是应用连接中间件逻辑库的密码。

TESTDB是应用当前连接的逻辑库中所对应的逻辑表。schemas 中可以配置一个或多个。

true 中 readOnly 是应用连接中间件逻辑库所具有的权限。true 为只读，false 为读写都有，默认为 false

## [2. privileges标签权限控制](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2-privileges标签权限控制)

在 user 标签下的 privileges 标签可以对逻辑库（schema）、表（table）进行精细化的 DML 权限控

制。

privileges 标签下的 check 属性，如为 true 开启权限检查，为 false 不开启，默认为 false。

由于 Mycat 一个用户的 schemas 属性可配置多个逻辑库（schema） ，所以 privileges 的下级

节点 schema 节点同样可配置多个，对多库多表进行细粒度的 DML 权限控制。

Schema/Table 上的 dml 属性描述

注： 设置了 schema , 但只设置了个别 table 或 未设置 table 的 DML，自动继承 schema 的 DML 属性

privileges 配置事例如下：

```xml
<user name="zhuam">
    <property name="password">111111</property>
    <property name="schemas">TESTDB,TESTDB1</property>
    <!-- 表级权限: Table 级的 dml(curd)控制，未设置的 Table 继承 schema 的 dml -->
    <!-- TODO: 非 CURD SQL 语句, 透明传递至后端 -->
    <privileges check="true">
        <schema name="TESTDB" dml="0110" >
            <table name="table01" dml="0111"></table>
            <table name="table02" dml="1111"></table>
        </schema>
        <schema name="TESTDB1" dml="0110">
            <table name="table03" dml="1110"></table>
            <table name="table04" dml="1010"></table>
        </schema>
    </privileges>
</user>
```

# [17.防火墙配置](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_17防火墙配置)

白名单和 SQL 黑名单说明：

在 server.xml 中配置：

```xml
<firewall>
    <whitehost>
        <host user="mycat" host="127.0.0.1"></host> ip 白名单 用户对应的可以访问的 ip 地址
    </whitehost>
    <blacklist check="true">
         <property name="selelctAllow">false</property> 黑名单允许的 权限 后面为默认
    </blacklist>
</firewall
```

## [黑名单拦截明细配置](https://jshand.gitee.io/#/course/internet_arch/mycat?id=黑名单拦截明细配置)

| 配置项                 | 缺省值 | 描述                                                         |
| ---------------------- | ------ | ------------------------------------------------------------ |
| selelctAllow           | TRUE   | 是否允许执行SELECT语句                                       |
| selectAllColumnAllow   | TRUE   | 是否允许执行SELECT * FROM T这样的语句。如果设置为false,不允许 执行select * from t,但select * from (select id, name from t) a。这个选项是防御程序通过调用select *获得数据表的结构信息。 |
| selectIntoAllow        | TRUE   | SELECT查询中是否允许INTO字句                                 |
| deleteAllow            | TRUE   | 是否允许执行DELETE语句                                       |
| updateAllow            | TRUE   | 是否允许执行UPDATE语句                                       |
| insertAllow            | TRUE   | 是否允许执行INSERT语句                                       |
| replaceAllow           | TRUE   | 是否允许执行REPLACE语句                                      |
| mergeAllow             | TRUE   | 是否允许执行MERGE语句，这个只在Oracle中有用                  |
| callAllow              | TRUE   | 是否允许通过jdbc的call语法调用存储过程                       |
| setAllow               | TRUE   | 是否允许使用SET语法                                          |
| truncateAllow          | TRUE   | truncate 语句是危险，缺省打开，若需要自行关闭                |
| createTableAllow       | TRUE   | 是否允许创建表                                               |
| alterTableAllow        | TRUE   | 是否允许执行 Alter Table 语句                                |
| dropTableAllow         | true   | 是否允许修改表                                               |
| commentAllow           | FALSE  | 是否允许语句中存在注释，Oracle 的用户不用担心，Wall 能够识别 hints和注释的区别 |
| noneBaseStatementAllow | FALSE  | 是否允许非以上基本语句的其他语句，缺省关闭，通过这个选项     |
| multiStatementAllow    | FALSE  | 是否允许一次执行多条语句，缺省关闭                           |
| useAllow               | TRUE   | 是否允许执行 mysql 的 use 语句，缺省打开                     |
| describeAllow          | TRUE   | 是否允许执行 mysql 的 describe 语句，缺省打开                |
| showAllow              | TRUE   | 是否允许执行 mysql 的 show 语句，缺省打开                    |
| commitAllow            | TRUE   | 是否允许执行 commit 操作                                     |
| rollbackAllow          | TRUE   | 是否允许执行 roll back 操作                                  |
|                        |        |                                                              |

> 如果把 selectIntoAllow、deleteAllow、updateAllow、insertAllow、mergeAllow 都设置为 false，这就是一个只读数据源了。

## [拦截配置－永真条件](https://jshand.gitee.io/#/course/internet_arch/mycat?id=拦截配置－永真条件)

| 配置项                      | 缺省值 描述 | 描述                                                         |
| --------------------------- | ----------- | ------------------------------------------------------------ |
| selectWhereAlwayTrueCheck   | TRUE        | 检查 SELECT 语句的 WHERE 子句是否是一个永真条件              |
| selectHavingAlwayTrueCheck  | TRUE        | 检查 SELECT 语句的 HAVING 子句是否是一个永真条件             |
| deleteWhereAlwayTrueCheck   | TRUE        | 检查 DELETE 语句的 WHERE 子句是否是一个永真条件              |
| deleteWhereNoneCheck        | FALSE       | 检查 DELETE 语句是否无 where 条件，这是有风险的，但不是 SQL 注入类型的风险 |
| updateWhereAlayTrueCheck    | TRUE        | 检查 UPDATE 语句的 WHERE 子句是否是一个永真条件              |
| updateWhereNoneCheck        | FALSE       | 检查 UPDATE 语句是否无 where 条件，这是有风险的，但不是SQL 注入类型的风险 |
| conditionAndAlwayTrueAllow  | FALSE       | 检查查询条件(WHERE/HAVING子句)中是否包含 AND 永真条件        |
| conditionAndAlwayFalseAllow | FALSE       | 检查查询条件(WHERE/HAVING子句)中是否包含 AND 永假条件        |
| conditionLikeTrueAllow      | TRUE        | 检查查询条件(WHERE/HAVING 子句)中是否包含 LIKE 永真条件      |

## [其他拦截](https://jshand.gitee.io/#/course/internet_arch/mycat?id=其他拦截)

| 置项                      | 缺省值 描述 | 描述                                                         |
| ------------------------- | ----------- | ------------------------------------------------------------ |
| selectIntoOutfileAllow    | FALSE       | SELECT ... INTO OUTFILE 是否允许，这个是 mysql 注入攻击的常见手段 缺省是禁止的 |
| selectUnionCheck          | TRUE        | 检测 SELECT UNION                                            |
| selectMinusCheck          | TRUE        | 检测 SELECT MINUS                                            |
| selectExceptCheck         | TRUE        | 检测 SELECT EXCEPT                                           |
| selectIntersectCheck      | TRUE        | 检测 SELECT INTERSECT                                        |
| mustParameterized         | FALSE       | 是否必须参数化，如果为 True，则不允许类似 WHERE ID = 1 这种不参数化的 SQL |
| strictSyntaxCheck         | TRUE        | 是否进行严格的语法检测，Druid SQL Parser 在某些场景不能覆盖所有的 SQL 语法，出现解析 SQL 出错，可以临时把这个选项设置为 false，同时把 SQL 反馈给 Druid 的开发者。 |
| conditionOpXorAllow       | false       | 查询条件中是否允许有 XOR 条件。XOR 不常用，很难判断永真或者永假，缺省不允许。 |
| conditionOpBitwseAllow    | TRUE        | 查询条件中是否允许有"&"、"~"、"\|"、"^"运算符。              |
| conditionDoubleConstAllow | FALSE       | 查询条件中是否允许连续两个常量运算表达式                     |
| minusAllow                | true        | 是否允许 SELECT * FROM A MINUS SELECT * FROM B 这样的语句    |
| intersectAllow            | true        | 是否允许 SELECT * FROM A INTERSECT SELECT * FROM B 这样的语句 |
| constArithmeticAllow      | TRUE        | 拦截常量运算的条件，比如说 WHERE FID = 3 - 1，其中"3 - 1"是常量运算表达式。 |
| limitZeroAllow            | FALSE       | 是否允许 limit 0 这样的语句                                  |

## [禁用对象检测配置](https://jshand.gitee.io/#/course/internet_arch/mycat?id=禁用对象检测配置)

| 配置项        | 缺省值 | 描述                        |
| ------------- | ------ | --------------------------- |
| tableCheck    | TRUE   | 检测是否使用了禁用的表      |
| schemaCheck   | TRUE   | 检测是否使用了禁用的 Schema |
| functionCheck | true   | 检测是否使用了禁用的函数    |
| objectCheck   | TRUE   | 检测是否使用了“禁用对对象”  |
| variantCheck  | TRUE   | 检测是否使用了“禁用的变量”  |

# [18.Mycat-web(mycat-eye)](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_18mycat-webmycat-eye)

Mycat-web 是 Mycat 可视化运维的管理和监控平台，弥补了 Mycat 在监控上的空白。帮 Mycat 分

担统计任务和配置管理任务。Mycat-web 引入了 ZooKeeper 作为配置中心，可以管理多个节点。

Mycat-web 主要管理和监控 Mycat 的流量、连接、活动线程和内存等，具备 IP 白名单、邮件告警等模

块，还可以统计 SQL 并分析慢 SQL 和高频 SQL 等。为优化 SQL 提供依据。

以zookeeper作为配置中心，所以需要优先安装zookeeper

## [1.ZooKeeper 安装](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1zookeeper-安装)

ZooKeeper是一个[分布式](https://baike.baidu.com/item/分布式/19276232)的，开放源码的[分布式应用程序](https://baike.baidu.com/item/分布式应用程序/9854429)协调服务，是[Google](https://baike.baidu.com/item/Google)的Chubby一个[开源](https://baike.baidu.com/item/开源/246339)的实现，是Hadoop和[Hbase](https://baike.baidu.com/item/Hbase/7670213)的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。zookeeper使用Java编写，需要配置JAVA_HOME环境变量

```bash
[root@mycat jdk1.8.0_202]# vim ~/.bash_profile
# .bash_profile

# Get the aliases and functions
if [ -f ~/.bashrc ]; then
        . ~/.bashrc
fi

# User specific environment and startup programs
JAVA_HOME=/opt/jdk1.8.0_202
export JAVA_HOME

PATH=$PATH:$HOME/bin:$JAVA_HOME/bin

export PATH
```

source命令让环境变量生效

```bash
[root@mycat jdk1.8.0_202]# source ~/.bash_profile 
[root@mycat jdk1.8.0_202]# cd ~
[root@mycat ~]# java -version
java version "1.8.0_202"
Java(TM) SE Runtime Environment (build 1.8.0_202-b08)
Java HotSpot(TM) 64-Bit Server VM (build 25.202-b08, mixed mode)
[root@mycat ~]# 
```

此处使用zookeeper的3.5.9版本,官网下载页面：

https://zookeeper.apache.org/releases.html

在linux中切换到/opt目录使用wget 下载

```bash
#下载zookeeper
[root@mycat opt]# wget https://mirrors.bfsu.edu.cn/apache/zookeeper/zookeeper-3.5.9/apache-zookeeper-3.5.9-bin.tar.gz

#解压zookeeper-3.5.9
[root@mycat opt]# tar -zxvf apache-zookeeper-3.5.9-bin.tar.gz 

#进入zookeeper配置文件目录
[root@mycat opt]# cd apache-zookeeper-3.5.9-bin/conf

#使用默认配置文件
[root@mycat conf]# cp zoo_sample.cfg zoo.cfg

#启动zookeeper
[root@mycat bin]# ./zkServer.sh start
ZooKeeper JMX enabled by default
Using config: /opt/apache-zookeeper-3.5.9-bin/bin/../conf/zoo.cfg
Starting zookeeper ... STARTED
[root@mycat bin]# 
```

## [2.Mycat-web 安装](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2mycat-web-安装)

登录官方网站查看mycat-web的下载地址

```
http://dl.mycat.org.cn/mycat-web-1.0/
#进入/opt目录
[root@mycat bin]# cd /opt/

#下载mycat-web
[root@mycat opt]# wget http://dl.mycat.org.cn/mycat-web-1.0/Mycat-web-1.0-SNAPSHOT-20170102153329-linux.tar.gz
--2021-06-20 18:46:50--  http://dl.mycat.org.cn/mycat-web-1.0/Mycat-web-1.0-SNAPSHOT-20170102153329-linux.tar.gz
正在解析主机 dl.mycat.org.cn (dl.mycat.org.cn)... 210.51.26.184
正在连接 dl.mycat.org.cn (dl.mycat.org.cn)|210.51.26.184|:80... 已连接。
已发出 HTTP 请求，正在等待回应... 200 OK
长度：53956391 (51M) [application/octet-stream]
正在保存至: “Mycat-web-1.0-SNAPSHOT-20170102153329-linux.tar.gz”

100%[=====================================================================================================================================================>] 53,956,391  10.1MB/s 用时 5.7s   

2021-06-20 18:46:56 (9.06 MB/s) - 已保存 “Mycat-web-1.0-SNAPSHOT-20170102153329-linux.tar.gz” [53956391/53956391])



[root@mycat opt]# ls
Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz  redis-5.0.12.tar.gz
apache-zookeeper-3.5.9-bin         jdk1.8.0_202                                                                      Mycat-web-1.0-SNAPSHOT-20170102153329-linux.tar.gz    rh
apache-zookeeper-3.5.9-bin.tar.gz  jdk-8u202-linux-x64.tar.gz?AuthParam=1623665760_163646ebbccad330658ee014e84f5211  nmon_x86_64_centos7
containerd                         mycat                                                                             redis-5.0.12


#解压缩 mycat-web
[root@mycat opt]# tar -zxvf Mycat-web-1.0-SNAPSHOT-20170102153329-linux.tar.gz 
mycat-web/mycat-web/
mycat-web/mycat-web/static/
mycat-web/mycat-web/static/highcharts/
mycat-web/mycat-web/static/adminlte/
mycat-web/mycat-web/static/adminlte/dist/
mycat-web/mycat-web/static/adminlte/dist/css/
mycat-web/mycat-web/static/adminlte/dist/css/skins/
.....此处省略


#进入mycat-web的目录下运行启动命令
root@mycat opt]# cd /opt/mycat-web/
[root@mycat mycat-web]# ls
etc  lib  mycat-web  readme.txt  start.jar  start.sh
[root@mycat mycat-web]# ./start.sh  &
[1] 29188
[root@mycat mycat-web]# nohup: 忽略输入并把输出追加到"nohup.out"
```

## [3.使用web浏览器访问](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3使用web浏览器访问)

http://192.168.0.102:8082/mycat/ ，使用 `http://ip:port/mycat`访问管理界面

![img](https://jshand.gitee.io/imgs/mycat/2021-06-20_190455.png)

## [4.添加mycat服务（需要监控的mycat实例）](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_4添加mycat服务（需要监控的mycat实例）)

![img](https://jshand.gitee.io/imgs/mycat/2021-06-20_191026.png)

## [5.使用mycat-web进行监控](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_5使用mycat-web进行监控)

**Mycat** **性能监控指标**

在 Mycat-web 上可以进行 Mycat 性能监控，例如：内存分享、流量分析、连接分析、活动线程分

析等等。

![img](https://jshand.gitee.io/imgs/mycat/2021-06-20_191747.png)

![img](https://jshand.gitee.io/imgs/mycat/2021-06-20_191714.png)

![img](https://jshand.gitee.io/imgs/mycat/2021-06-20_191733.png)

# [常见错误](https://jshand.gitee.io/#/course/internet_arch/mycat?id=常见错误)

## [1.PacketTooBigException](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_1packettoobigexception)

com.mysql.jdbc.PacketTooBigException: Packet for query is too large (44 > -1). You can change this value on the server by setting the max_allowed_packet’ variable。 原因 将版本更换为5.1.35后不报错 官网上 MycatJDBC连接报 PacketTooBigException异常 答：检查mysqljdbc驱动的版本，在使用mycat1.3和mycat1.4版本情况下，不要使用jdbc5.1.37和38版本的驱动，会出现如下异常报错：com.mysql.jdbc.PacketTooBigException: Packet for query is too large (60 > -1). You can change this value on the server by setting the max_allowed_packet’ variable。建议使用jdbc5.1.35或者36的版本。 mycat1.6同样会出现这个问题，换成mysql5.1.40同样可用

## [2.错误 ConfigException](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_2错误-configexception)

Caused by: io.mycat.config.util.ConfigException: java.lang.NullPointerException 原因 schema.xml配置文件错误，我的dataNode上下不匹配了。

## [3.Timed out](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_3timed-out)

Startup failed: Timed out waiting for a signal from the JVM. JVM did not exit on request, terminated 解决办法 在wrapper.conf中添加

```properties
#超时时间300秒
wrapper.startup.timeout=300 
wrapper.ping.timeout=120
```

通过startup_nowrap.sh启动，报错 Caused by: io.mycat.config.util.ConfigException: Illegal table conf : table [ …] rule function [ rang-long ] partition size : 3 > table datanode size : 2, please make sure table datanode size = function partition size 默认的分片是分为3片，而我就设置了2个库。然后我又填了个新库，可以正常启动。 如果要修改分片规则，则需要修改rule.xml和其中对应的规则文件。

## [4.NumberFormatException](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_4numberformatexception)

MyCATSequenceProcessor.executeSeq(SesionSQLPair) java.lang.NumberFormatException: null 原因，主键编号未获取到 `<property name="sequnceHandlerType">0</property>`本地文件方式 sequence_conf.properties文件未配置表名

```properties
#default global sequence
GLOBAL.HISIDS=
GLOBAL.MINID=1
GLOBAL.MAXID=20000000
GLOBAL.CURID=0

# self define sequence
COMPANY.HISIDS=
COMPANY.MINID=1
COMPANY.MAXID=2000000
COMPANY.CURID=410
<table name="tbl" primaryKey="ID" autoIncrement="true" dataNode="dn$0-11" rule="sharding-by-substring" />
```

COMPANY应为schema.xml中的表名对应的大写，此处应为TBL

## [5.SQLSyntaxErrorException](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_5sqlsyntaxerrorexception)

java.sql.SQLSyntaxErrorException: com.alibaba.druid.sql.parser.ParserException: syntax error, expect ‘)’ 原因 报SQL语法错误，应该是SQL语句中有内嵌函数。 我的INSERT语句中VALUES中有时间函数now（）

## [6.SQLNonTransientException](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_6sqlnontransientexception)

SELECT aaa a, bbb b, ccc c, status status FROM demo WHERE a = ‘11111’ AND b = ‘22222’ AND status=1 err:java.sql.SQLNonTransientException: can’t find table define in schema STATUS schema:demo 原因 status字段名和别名一样，导致解析错误，去掉别名或者改成其他别名后正常

## [7.错误，按月分片](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_7错误，按月分片)

Caused by: com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Can’t find a valid data node for specified node index :TESTDB -> CREATE_TIME -> 2017-07-11 16:38:49 -> Index : 30 按自然月分片(sharding-by-month)，rule.xml中function中设置为

```
<function name="partbymonth" class="io.mycat.route.function.PartitionByMonth">
    <property name="dateFormat">yyyy-MM-dd</property>
    <property name="sBeginDate">2015-01-01</property>
</function>
```

起始日期2015-01-01到今天2017-07-11共30个月，需要30分片正常使用，将起始日期改为2017-07-01后正常，此时无法传入2017-07-01之前的数据，而且无法插入（起始日期+分片数量）之后月份的数据。即无法做到循环插入。

可使用以下规则做到按月循环插入，但是只能一个月一个表

```xml
<tableRule name="sharding-by-substring"> 
    <rule> 
        <columns>create_time</columns> 
        <algorithm>sharding-by-substring</algorithm> 
    </rule> 
</tableRule>
<function name="sharding-by-substring" 
    class="io.mycat.route.function.PartitionDirectBySubString"> 
    <property name="startIndex">5</property><!-- zero-based -->
    <property name="size">2</property> 
    <property name="partitionCount">12</property> 
    <property name="defaultPartition">0</property>
</function>
```

columns 标识将要分片的表字段， algorithm 分片函数 此方法为直接根据字符子串（必须是数字）计算分区号（由应用传递参数，显式指定分区号）。 startIndex,截取开始位置， size，截取长度， partitionCount，分片数量， defaultPartition，默认分片(截取到的不在分片数量内，则会按默认分片处理)

例如create_time=2017-07-04 17:30:03 在此配置中代表根据create_time中从startIndex=5开始，截取size=2位数字即07，07就是获取的分区，如果没有默认分配到defaultPartition

## [8.关于插入库名](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_8关于插入库名)

>  提供SQL插入语句时不要带库名，不然可能会全部插入一个库中

## [9.关于数据同步](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_9关于数据同步)

> mycat不提供数据同步，数据同步在MySQL中配置

## [10.关于主键](https://jshand.gitee.io/#/course/internet_arch/mycat?id=_10关于主键)

> mycat不支持联合主键
# [**1. MyBatis** 介绍](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1-mybatis-介绍)

## [1.1 官网](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_11-官网)

**Doc**： https://mybatis.org/mybatis-3/zh/index.html

**generator：**http://mybatis.org/generator/quickstart.html

**spring：**http://mybatis.org/spring/zh/getting-started.html

## [1.2 简介](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_12-简介)

MyBatis 是一款优秀的持久层框架，它支持自定义 SQL、存储过程以及高级映射。MyBatis 免除了几乎所有的 JDBC 代码以及设置参数和获取结果集的工作。MyBatis 可以通过简单的 XML 或注解来配置和映射原始类型、接口和 Java POJO（Plain Old Java Objects，普通老式 Java 对象）为数据库中的记录。

# [2. 入门程序搭建](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_2-入门程序搭建)

## [2.1 数据库脚本](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_21-数据库脚本)

~~~sql
```
/*==============================================================*/
/* DBMS name:      MySQL 5.0                                    */
/* Created on:     2020/12/22 10:26:43                          */
/*==============================================================*/


CREATE DATABASE /*!32312 IF NOT EXISTS*/ mybatis /*!40100 DEFAULT CHARACTER SET utf8mb4 */;
USE mybatis;



/*==============================================================*/
/* Table: check_apply                                           */
/*==============================================================*/
CREATE TABLE check_apply
(
   id                   INT NOT NULL AUTO_INCREMENT COMMENT 'id',
   register_id          int comment '病历号',
   item_id              int comment '项目id',
   item_name            varchar(100) comment '项目名称',
   fee                  decimal(8,2) comment '检查费用',
   status               int comment '状态',
   active               int default 1 comment '是否有效，1 有效，0 失效',
   createtime           datetime default CURRENT_TIMESTAMP comment '创建时间',
   primary key (id)
);

alter table check_apply comment '检查申请';

/*==============================================================*/
/* Table: check_item                                            */
/*==============================================================*/
create table check_item
(
   id                   int not null auto_increment comment 'id',
   name                 varchar(100) comment '检查名称',
   fee                  decimal(8,2) comment '检查费用',
   active               int default 1 comment '是否有效，1 有效，0 失效',
   createtime           datetime default CURRENT_TIMESTAMP comment '创建时间',
   primary key (id)
);

alter table check_item comment '检查项目';

/*==============================================================*/
/* Table: constant_item                                         */
/*==============================================================*/
create table constant_item
(
   id                   int not null auto_increment comment 'id',
   type_id              int comment '类别id',
   code                 varchar(100) comment '常数项代码',
   name                 varchar(100) comment '常数项名称',
   sort                 int comment '排序',
   active               int default 1 comment '是否有效，1 有效，0 失效',
   createtime           datetime default CURRENT_TIMESTAMP comment '创建时间',
   primary key (id)
);

alter table constant_item comment '常数项表';

/*==============================================================*/
/* Table: constant_type                                         */
/*==============================================================*/
create table constant_type
(
   id                   int not null auto_increment comment '主键id',
   code                 varchar(100) comment '代码',
   name                 varchar(100) comment '名称',
   active               int default 1 comment '是否有效，1 有效，0 失效',
   createtime           datetime default CURRENT_TIMESTAMP comment '创建时间',
   primary key (id)
);

alter table constant_type comment '常数类别';

/*==============================================================*/
/* Table: department                                            */
/*==============================================================*/
create table department
(
   id                   int not null auto_increment comment 'id',
   name                 varchar(100) comment '名称',
   address              varchar(200) comment '办公地址',
   leader               varchar(100) comment '负责人',
   active               int default 1 comment '是否有效，1 有效，0 失效',
   createtime           datetime default CURRENT_TIMESTAMP comment '创建时间',
   primary key (id)
);

alter table department comment '科室';

/*==============================================================*/
/* Table: inspect_apply                                         */
/*==============================================================*/
create table inspect_apply
(
   id                   int not null comment 'id',
   item_id              int comment '项目id',
   item_name            varchar(100) comment '项目名称',
   fee                  decimal(8,2) comment '检查费用',
   status               int comment '状态',
   register_id          int comment '病历号',
   active               int default 1 comment '是否有效，1 有效，0 失效',
   createtime           datetime default CURRENT_TIMESTAMP comment '创建时间',
   primary key (id)
);

alter table inspect_apply comment '检验申请';

/*==============================================================*/
/* Table: inspect_item                                          */
/*==============================================================*/
create table inspect_item
(
   id                   int not null auto_increment comment 'id',
   name                 varchar(100) comment '检查名称',
   fee                  decimal(8,2) comment '检查费用',
   active               int default 1 comment '是否有效，1 有效，0 失效',
   createtime           datetime default CURRENT_TIMESTAMP comment '创建时间',
   primary key (id)
);

alter table inspect_item comment '检验项目';

/*==============================================================*/
/* Table: menu                                                  */
/*==============================================================*/
create table menu
(
   menu_id              int not null auto_increment comment '菜单id',
   menu_name            varchar(100) comment '菜单名称',
   url                  varchar(100) comment '菜单url',
   parent_id            int comment '上级菜单id',
   active               int default 1 comment '是否有效，1 有效，0 失效',
   createtime           datetime default CURRENT_TIMESTAMP comment '创建时间',
   primary key (menu_id)
);

alter table menu comment '菜单';

/*==============================================================*/
/* Table: regist_level                                          */
/*==============================================================*/
create table regist_level
(
   id                   int not null auto_increment comment 'id',
   name                 varchar(100) comment '名称',
   fee                  decimal(8,2) comment '费用',
   active               int default 1 comment '是否有效，1 有效，0 失效',
   createtime           datetime default CURRENT_TIMESTAMP comment '创建时间',
   primary key (id)
);

alter table regist_level comment '挂号级别';

/*==============================================================*/
/* Table: register                                              */
/*==============================================================*/
create table register
(
   id                   int not null auto_increment comment 'id病历号',
   name                 varchar(100) comment '姓名',
   gender               int comment '性别',
   idno                 varchar(100) comment '身份证号',
   birthday             date comment '出生日期',
   age                  int comment '年龄',
   address              varchar(200) comment '家庭住址',
   regsit_level_id      int comment '挂号级别',
   dept_id              int comment '挂号科室',
   doctor_id            int comment '看诊医生',
   book                 int comment '是否要病历本',
   visittime            date comment '看诊时间',
   fee                  decimal(8,2) comment '挂号费用',
   readme               varchar(500) comment '主诉',
   present              varchar(500) comment '现病史',
   present_treat        varchar(500) comment '现病史治疗情况',
   history              varchar(500) comment '既往史',
   allergy              varchar(500) comment '过敏史',
   disease              varchar(500) comment '确诊疾病',
   suit                 varchar(500) comment '处置方案',
   drug                 varchar(500) comment '药品清单',
   status               int comment '状态',
   active               int default 1 comment '是否有效，1 有效，0 失效',
   createtime           datetime default CURRENT_TIMESTAMP comment '创建时间',
   primary key (id)
);

alter table register comment '诊疗信息';

/*==============================================================*/
/* Table: role                                                  */
/*==============================================================*/
create table role
(
   role_id              int not null auto_increment comment '角色id',
   role_name            varchar(100) comment '角色名称',
   active               int default 1 comment '是否有效，1 有效，0 失效',
   createtime           datetime default CURRENT_TIMESTAMP comment '创建时间',
   primary key (role_id)
);

alter table role comment '角色';

/*==============================================================*/
/* Table: role_menu                                             */
/*==============================================================*/
create table role_menu
(
   menu_id              int not null comment '菜单id',
   role_id              int not null comment '角色id',
   primary key (menu_id, role_id)
);

alter table role_menu comment '角色菜单信息';

/*==============================================================*/
/* Table: user                                                  */
/*==============================================================*/
create table user
(
   user_id              int not null auto_increment comment '医生id',
   username             varchar(100) comment '用户名',
   password             varchar(100) comment '密码',
   realname             varchar(100) comment '真实姓名',
   telephone            varchar(20) comment '电话号码',
   dept_id              int comment 'id',
   user_type            int comment '医生类型',
   lastlogin            datetime comment '最后登录时间',
   active               int default 1 comment '是否有效，1 有效，0 失效',
   createtime           datetime default CURRENT_TIMESTAMP comment '创建时间',
   primary key (user_id)
);

alter table user comment '医生-用户信息';

/*==============================================================*/
/* Table: user_role                                             */
/*==============================================================*/
create table user_role
(
   user_id              int not null comment '医生id',
   role_id              int not null comment '角色id',
   primary key (user_id, role_id)
);

alter table user_role comment '用户角色';

alter table role_menu add constraint FK_Reference_1 foreign key (menu_id)
      references menu (menu_id) on delete restrict on update restrict;

alter table role_menu add constraint FK_Reference_2 foreign key (role_id)
      references role (role_id) on delete restrict on update restrict;

alter table user add constraint FK_Reference_5 foreign key (dept_id)
      references department (id) on delete restrict on update restrict;

alter table user_role add constraint FK_Reference_3 foreign key (user_id)
      references user (user_id) on delete restrict on update restrict;

alter table user_role add constraint FK_Reference_4 foreign key (role_id)
      references role (role_id) on delete restrict on update restrict;
~~~

## [2.2 创建Maven项目](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_22-创建maven项目)

## [2.3 添加依赖](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_23-添加依赖)

1. mybaits 3.5.5
2. mysql数据库驱动 5.1.49
3. junit 4.12

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>mybatis-parent-java1</artifactId>
        <groupId>com.neuedu.mybatis</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <packaging>jar</packaging>
    <artifactId>01-mybaits-helloworld</artifactId>

    <dependencies>

        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.12</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.49</version>
        </dependency>


        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.5.5</version>
        </dependency>


    </dependencies>





</project>
```

## [2.4 创建SqlMapConfig.xml](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_24-创建sqlmapconfigxml)

XML 配置文件中包含了对 MyBatis 系统的核心设置，包括获取数据库连接实例的数据源（DataSource）以及决定事务作用域和控制方式的事务管理器（TransactionManager）。后面会再探讨 XML 配置文件的详细内容，这里先给出一个简单的示例：

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>


    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://127.0.0.1:3306/upload"/>
                <property name="username" value="root"/>
                <property name="password" value="root"/>
            </dataSource>
        </environment>
    </environments>


    <mappers>
        <!-- 每张表的 statement-->
        <mapper resource="mapper.xml"/>
    </mappers>
</configuration>
```

## [2.5 创建映射文件mapper.xml](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_25-创建映射文件mapperxml)

一个语句既可以通过 XML 定义，也可以通过注解定义。我们先看看 XML 定义语句的方式，事实上 MyBatis 提供的所有特性都可以利用基于 XML 的映射语言来实现，这使得 MyBatis 在过去的数年间得以流行。如果你用过旧版本的 MyBatis，你应该对这个概念比较熟悉。 但相比于之前的版本，新版本改进了许多 XML 的配置，后面我们会提到这些改进。这里给出一个基于 XML 映射语句的示例，它应该可以满足上个示例中 SqlSession 的调用

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.neuedu.mybaits.helloworld">


    <select id="selectUploadFiles" resultType="com.neuedu.mybaits.entity.UploadFile">
            select * from upload_files
    </select>


</mapper>
```

## [2.6 使用resource 加载Mapper配置文件](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_26-使用resource-加载mapper配置文件)

```
<mappers>
    <!-- 每张表的 statement-->
    <mapper resource="mapper.xml"/>
</mappers>
```

## [2.7 使用Mybaits](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_27-使用mybaits)

xml构建SQLSessionFactory并创建SQLSession对象,访问MapperStatement执行sql语句

```java
package com.neuedu.mybaits.helloworld;

import com.neuedu.mybaits.entity.UploadFile;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;
import org.junit.Test;

import java.io.IOException;
import java.io.InputStream;
import java.util.List;

public class RunnerTest {

    @Test
    public void test() throws IOException {
        String resource = "SqlMapConfig.xml";
        InputStream inputStream = Resources.getResourceAsStream(resource);
        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);


        SqlSession session = sqlSessionFactory.openSession();

        List<UploadFile> list = session.selectList("com.neuedu.mybaits.helloworld.selectUploadFiles");

        for (UploadFile uploadFile : list) {
            System.out.println(uploadFile);
        }

        session.close();

    }
}
```

# [3. 通用的增删改查(CRUD)](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_3-通用的增删改查crud)

使用`<select>`、`<insert>` 、`<update>` 、`<delete>` 分别执行 查询、新增、修改、删除的sql

- insert、update、delete三种sql不用特殊别名，返回类型，默认返回影响行数，整形。
- select需要指定返回类型, resultType 表示单条结果集映射的类型
  - 实体VO、Map、基础类型
- 当需要参数的时候 parameType，表示需要的参数类型
  - 实体VO、Map、基础类型（Integer、String）

## [3.1 查询sql语句](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_31-查询sql语句)

使用select标签表示执行查询类型的sql

- id：给MapperdStatement命名, 配合namespace 使用，表示全局唯一的一个SQL语句。
- resultType: 表示单条结果集映射的类型
- parameterType: 参数类型

```xml
    <select id="selectById" resultType="java.util.Map" parameterType="java.lang.Integer">
            select * from upload_files where id = #{id}
    </select>
```

## [3.2 更新、插入、查询sql语句](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_32-更新、插入、查询sql语句)

- id：给MapperdStatement命名, 配合namespace 使用，表示全局唯一的一个SQL语句。
- parameterType: 参数类型

```xml
<insert id="saveUploadFile" parameterType="java.util.Map">
        INSERT INTO upload_files (  origin_name,  path, upload_time, size,  ip  )
            VALUES   (  #{origin_name},  #{path},  #{upload_time},  #{size},  #{ip}  )

    </insert>


    <update id="update" parameterType="java.util.Map">
        UPDATE
          upload_files
        SET
          origin_name= #{origin_name},
          path= #{path},
          upload_time= #{upload_time},
          size= #{size},
          ip= #{ip}
        WHERE id= #{id}

    </update>


    <delete id="delete"  parameterType="java.lang.Integer">
        delete from upload_files  WHERE id= #{id}
    </delete>
```

## [3.3 绑定变量](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_33-绑定变量)

使用`#{key}`代表绑定变量,如果参数类型是Map，key就是Map的key，如果是实体key实体的属性，如果参数是基础类型（String），可以自定义。使用ognl表达式从作用域中获取数据,ONGL也可以参与运算,

root对象 map

 ip：ssss，

 size：555

root对象 uploadFile

 ip：ssss，

 size：555

# [4 用户接口对象](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_4-用户接口对象)

- SqlSessionFactory : 重量级的对象，线程安全的。采用工厂模式用于创建SQLSession对象。

- SqlSession ：轻量级的，线程不安全的。每次使用获取每个线程自己的SQLSession对象。面向用户的接口。

  - 执行查询、删除、修改 、新增、查询集合等方法。

    - selectList:查询集合

    - selectOne:查询单条数据

       当结果集为至多一条时使用，如果数据有多条报如下错误：

      ![img](https://jshand.gitee.io/imgs/mybatis/2021-03-22_111021.png)

    - 查询语句方法的返回结果类型由调用的接口决定（selectOne、selectList）

    - update、insert、delete:修改、插入、删除数据

    - 其他方法：select、selectMap、getMapper（）

  - 事务的管理commit、rollback、资源的关闭close

# [5.SqlMapConfig.xml文件](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_5sqlmapconfigxml文件)

全局的配置文件，配置数据源、事务等信息。配置文件以`<configuration>`为根节点，有如下子节点

## [5.1 environments](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_51-environments)

- 配置数据源和事务，支持配置多个

  - environments:代表一个数据库的连接信息

    - transactionManager：用于配置mybatis的事务管理方式：

      - JDBC – 这个配置直接使用了 JDBC 的提交和回滚设施，它依赖从数据源获得的连接来管理事务作用域。
      - MANAGED – 这个配置几乎没做什么。它从不提交或回滚一个连接，而是让容器来管理事务的整个生命周期（比如 JEE 应用服务器的上下文）。 默认情况下它会关闭连接。然而一些容器并不希望连接被关闭，因此需要将 closeConnection 属性设置为 false 来阻止默认的关闭行为。

    - dataSource：用于配置数据源

    -  **UNPOOLED**– 这个数据源的实现会每次请求时打开和关闭连接。虽然有点慢，但对那些数据库连接可用性要求不高的简单应用程序来说，是一个很好的选择。 性能表现则依赖于使用的数据库，对某些数据库来说，使用连接池并不重要，这个配置就很适合这种情形。UNPOOLED 类型的数据源仅仅需要配置以下 5 种属性：

      - `driver` – 这是 JDBC 驱动的 Java 类全限定名（并不是 JDBC 驱动中可能包含的数据源类）。
      - `url` – 这是数据库的 JDBC URL 地址。
      - `username` – 登录数据库的用户名。
      - `password` – 登录数据库的密码。
      - `defaultTransactionIsolationLevel` – 默认的连接事务隔离级别。
      - `defaultNetworkTimeout` – 等待数据库操作完成的默认网络超时时间（单位：毫秒）。查看 `java.sql.Connection#setNetworkTimeout()` 的 API 文档以获取更多信息。

      作为可选项，你也可以传递属性给数据库驱动。只需在属性名加上“driver.”前缀即可，例如：

      - `driver.encoding=UTF8`

      这将通过 DriverManager.getConnection(url, driverProperties) 方法传递值为 `UTF8` 的 `encoding` 属性给数据库驱动。

       **POOLED**– 这种数据源的实现利用“池”的概念将 JDBC 连接对象组织起来，避免了创建新的连接实例时所必需的初始化和认证时间。 这种处理方式很流行，能使并发 Web 应用快速响应请求。

      除了上述提到 UNPOOLED 下的属性外，还有更多属性用来配置 POOLED 的数据源：

      - `poolMaximumActiveConnections` – 在任意时间可存在的活动（正在使用）连接数量，默认值：10
      - `poolMaximumIdleConnections` – 任意时间可能存在的空闲连接数。
      - `poolMaximumCheckoutTime` – 在被强制返回之前，池中连接被检出（checked out）时间，默认值：20000 毫秒（即 20 秒）
      - `poolTimeToWait` – 这是一个底层设置，如果获取连接花费了相当长的时间，连接池会打印状态日志并重新尝试获取一个连接（避免在误配置的情况下一直失败且不打印日志），默认值：20000 毫秒（即 20 秒）。
      - `poolMaximumLocalBadConnectionTolerance` – 这是一个关于坏连接容忍度的底层设置， 作用于每一个尝试从缓存池获取连接的线程。 如果这个线程获取到的是一个坏的连接，那么这个数据源允许这个线程尝试重新获取一个新的连接，但是这个重新尝试的次数不应该超过 `poolMaximumIdleConnections` 与 `poolMaximumLocalBadConnectionTolerance` 之和。 默认值：3（新增于 3.4.5）
      - `poolPingQuery` – 发送到数据库的侦测查询，用来检验连接是否正常工作并准备接受请求。默认是“NO PING QUERY SET”，这会导致多数数据库驱动出错时返回恰当的错误消息。
      - `poolPingEnabled` – 是否启用侦测查询。若开启，需要设置 `poolPingQuery` 属性为一个可执行的 SQL 语句（最好是一个速度非常快的 SQL 语句），默认值：false。
      - `poolPingConnectionsNotUsedFor` – 配置 poolPingQuery 的频率。可以被设置为和数据库连接超时时间一样，来避免不必要的侦测，默认值：0（即所有连接每一时刻都被侦测 — 当然仅当 poolPingEnabled 为 true 时适用）。

       **JNDI** – 这个数据源实现是为了能在如 EJB 或应用服务器这类容器中使用，容器可以集中或在外部配置数据源，然后放置一个 JNDI 上下文的数据源引用。这种数据源配置只需要两个属性：

      - `initial_context` – 这个属性用来在 InitialContext 中寻找上下文（即，initialContext.lookup(initial_context)）。这是个可选属性，如果忽略，那么将会直接从 InitialContext 中寻找 data_source 属性。
      - `data_source` – 这是引用数据源实例位置的上下文路径。提供了 initial_context 配置时会在其返回的上下文中进行查找，没有提供时则直接在 InitialContext 中查找。

      和其他数据源配置类似，可以通过添加前缀“env.”直接把属性传递给 InitialContext。比如：

      - `env.encoding=UTF8`

      这就会在 InitialContext 实例化时往它的构造方法传递值为 `UTF8` 的 `encoding` 属性。

## [5.2 mappers](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_52-mappers)

用于定义Mapperd Statement，语句块

 用于管理执行的sql，参数、返回结果的封装

## [5.3 properties](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_53-properties)

用于定义全局的属性，可以在 SqlMapConfig.xml中使用，也可以在Mapper.xml中使用

- 首先读取在 properties 元素体内指定的属性。
- 然后根据 properties 元素中的 resource 属性读取类路径下属性文件，或根据 url 属性指定的路径读取属性文件，并覆盖之前读取过的同名属性。
- 最后读取作为方法参数传递的属性，并覆盖之前读取过的同名属性。

因此，通过方法参数传递的属性具有最高优先级，resource/url 属性中指定的配置文件次之，最低优先级的则是 properties 元素中指定的属性

## [5.4. settings](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_54-settings)

这是 MyBatis 中极为重要的调整设置，它们会改变 MyBatis 的运行时行为。 下表描述了设置中各项设置的含义、默认值等。

| 设置名                           | 描述                                                         | 有效值                                                       | 默认值                                                |
| -------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ----------------------------------------------------- |
| cacheEnabled                     | 全局性地开启或关闭所有映射器配置文件中已配置的任何缓存。     | true \| false                                                | true                                                  |
| lazyLoadingEnabled               | 延迟加载的全局开关。当开启时，所有关联对象都会延迟加载。 特定关联关系中可通过设置 `fetchType` 属性来覆盖该项的开关状态。 | true \| false                                                | false                                                 |
| aggressiveLazyLoading            | 开启时，任一方法的调用都会加载该对象的所有延迟加载属性。 否则，每个延迟加载属性会按需加载（参考 `lazyLoadTriggerMethods`)。 | true \| false                                                | false （在 3.4.1 及之前的版本中默认为 true）          |
| multipleResultSetsEnabled        | 是否允许单个语句返回多结果集（需要数据库驱动支持）。         | true \| false                                                | true                                                  |
| useColumnLabel                   | 使用列标签代替列名。实际表现依赖于数据库驱动，具体可参考数据库驱动的相关文档，或通过对比测试来观察。 | true \| false                                                | true                                                  |
| useGeneratedKeys                 | 允许 JDBC 支持自动生成主键，需要数据库驱动支持。如果设置为 true，将强制使用自动生成主键。尽管一些数据库驱动不支持此特性，但仍可正常工作（如 Derby）。 | true \| false                                                | False                                                 |
| autoMappingBehavior              | 指定 MyBatis 应如何自动映射列到字段或属性。 NONE 表示关闭自动映射；PARTIAL 只会自动映射没有定义嵌套结果映射的字段。 FULL 会自动映射任何复杂的结果集（无论是否嵌套）。 | NONE, PARTIAL, FULL                                          | PARTIAL                                               |
| autoMappingUnknownColumnBehavior | 指定发现自动映射目标未知列（或未知属性类型）的行为。 `NONE`: 不做任何反应 `WARNING`: 输出警告日志（`'org.apache.ibatis.session.AutoMappingUnknownColumnBehavior'` 的日志等级必须设置为 `WARN`） `FAILING`: 映射失败 (抛出 `SqlSessionException`) | NONE, WARNING, FAILING                                       | NONE                                                  |
| defaultExecutorType              | 配置默认的执行器。SIMPLE 就是普通的执行器；REUSE 执行器会重用预处理语句（PreparedStatement）； BATCH 执行器不仅重用语句还会执行批量更新。 | SIMPLE REUSE BATCH                                           | SIMPLE                                                |
| defaultStatementTimeout          | 设置超时时间，它决定数据库驱动等待数据库响应的秒数。         | 任意正整数                                                   | 未设置 (null)                                         |
| defaultFetchSize                 | 为驱动的结果集获取数量（fetchSize）设置一个建议值。此参数只可以在查询设置中被覆盖。 | 任意正整数                                                   | 未设置 (null)                                         |
| defaultResultSetType             | 指定语句默认的滚动策略。（新增于 3.5.2）                     | FORWARD_ONLY \| SCROLL_SENSITIVE \| SCROLL_INSENSITIVE \| DEFAULT（等同于未设置） | 未设置 (null)                                         |
| safeRowBoundsEnabled             | 是否允许在嵌套语句中使用分页（RowBounds）。如果允许使用则设置为 false。 | true \| false                                                | False                                                 |
| safeResultHandlerEnabled         | 是否允许在嵌套语句中使用结果处理器（ResultHandler）。如果允许使用则设置为 false。 | true \| false                                                | True                                                  |
| mapUnderscoreToCamelCase         | 是否开启驼峰命名自动映射，即从经典数据库列名 A_COLUMN 映射到经典 Java 属性名 aColumn。 | true \| false                                                | False                                                 |
| localCacheScope                  | MyBatis 利用本地缓存机制（Local Cache）防止循环引用和加速重复的嵌套查询。 默认值为 SESSION，会缓存一个会话中执行的所有查询。 若设置值为 STATEMENT，本地缓存将仅用于执行语句，对相同 SqlSession 的不同查询将不会进行缓存。 | SESSION \| STATEMENT                                         | SESSION                                               |
| jdbcTypeForNull                  | 当没有为参数指定特定的 JDBC 类型时，空值的默认 JDBC 类型。 某些数据库驱动需要指定列的 JDBC 类型，多数情况直接用一般类型即可，比如 NULL、VARCHAR 或 OTHER。 | JdbcType 常量，常用值：NULL、VARCHAR 或 OTHER。              | OTHER                                                 |
| lazyLoadTriggerMethods           | 指定对象的哪些方法触发一次延迟加载。                         | 用逗号分隔的方法列表。                                       | equals,clone,hashCode,toString                        |
| defaultScriptingLanguage         | 指定动态 SQL 生成使用的默认脚本语言。                        | 一个类型别名或全限定类名。                                   | org.apache.ibatis.scripting.xmltags.XMLLanguageDriver |
| defaultEnumTypeHandler           | 指定 Enum 使用的默认 `TypeHandler` 。（新增于 3.4.5）        | 一个类型别名或全限定类名。                                   | org.apache.ibatis.type.EnumTypeHandler                |
| callSettersOnNulls               | 指定当结果集中值为 null 的时候是否调用映射对象的 setter（map 对象时为 put）方法，这在依赖于 Map.keySet() 或 null 值进行初始化时比较有用。注意基本类型（int、boolean 等）是不能设置成 null 的。 | true \| false                                                | false                                                 |
| returnInstanceForEmptyRow        | 当返回行的所有列都是空时，MyBatis默认返回 `null`。 当开启这个设置时，MyBatis会返回一个空实例。 请注意，它也适用于嵌套的结果集（如集合或关联）。（新增于 3.4.2） | true \| false                                                | false                                                 |
| logPrefix                        | 指定 MyBatis 增加到日志名称的前缀。                          | 任何字符串                                                   | 未设置                                                |
| logImpl                          | 指定 MyBatis 所用日志的具体实现，未指定时将自动查找。        | SLF4J \| LOG4J \| LOG4J2 \| JDK_LOGGING \| COMMONS_LOGGING \| STDOUT_LOGGING \| NO_LOGGING | 未设置                                                |
| proxyFactory                     | 指定 Mybatis 创建可延迟加载对象所用到的代理工具。            | CGLIB \| JAVASSIST                                           | JAVASSIST （MyBatis 3.3 以上）                        |
| vfsImpl                          | 指定 VFS 的实现                                              | 自定义 VFS 的实现的类全限定名，以逗号分隔。                  | 未设置                                                |
| useActualParamName               | 允许使用方法签名中的名称作为语句参数名称。 为了使用该特性，你的项目必须采用 Java 8 编译，并且加上 `-parameters` 选项。（新增于 3.4.1） | true \| false                                                | true                                                  |
| configurationFactory             | 指定一个提供 `Configuration` 实例的类。 这个被返回的 Configuration 实例用来加载被反序列化对象的延迟加载属性值。 这个类必须包含一个签名为`static Configuration getConfiguration()` 的方法。（新增于 3.2.3） | 一个类型别名或完全限定类名。                                 | 未设置                                                |
| shrinkWhitespacesInSql           | 从SQL中删除多余的空格字符。请注意，这也会影响SQL中的文字字符串。 (新增于 3.5.5) | true \| false                                                | false                                                 |
| defaultSqlProviderType           | Specifies an sql provider class that holds provider method (Since 3.5.6). This class apply to the `type`(or `value`) attribute on sql provider annotation(e.g. `@SelectProvider`), when these attribute was omitted. | A type alias or fully qualified class name                   | Not set                                               |

## [5.5 类型别名typeAliases](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_55-类型别名typealiases)

- 可为 Java 类型设置一个缩写名字。 它仅用于 XML 配置，意在降低冗余的全限定类名书写。例如：

  ```
  <typeAliases>
    <typeAlias alias="Author" type="domain.blog.Author"/>
    <typeAlias alias="Blog" type="domain.blog.Blog"/>
    <typeAlias alias="Comment" type="domain.blog.Comment"/>
    <typeAlias alias="Post" type="domain.blog.Post"/>
    <typeAlias alias="Section" type="domain.blog.Section"/>
    <typeAlias alias="Tag" type="domain.blog.Tag"/>
  </typeAliases>
  ```

  当这样配置时，`Blog` 可以用在任何使用 `domain.blog.Blog` 的地方。

  也可以指定一个包名，MyBatis 会在包名下面搜索需要的 Java Bean，比如：

  ```
  <typeAliases>
    <package name="domain.blog"/>
  </typeAliases>
  ```

  每一个在包 `domain.blog` 中的 Java Bean，在没有注解的情况下，会使用 Bean 的首字母小写的非限定类名来作为它的别名。 比如 `domain.blog.Author` 的别名为 `author`；若有注解，则别名为其注解值。见下面的例子：

  ```
  @Alias("author")
  public class Author {
      ...
  }
  ```

  下面是一些为常见的 Java 类型内建的类型别名。它们都是不区分大小写的，注意，为了应对原始类型的命名重复，采取了特殊的命名风格。

  | 别名       | 映射的类型 |
  | ---------- | ---------- |
  | _byte      | byte       |
  | _long      | long       |
  | _short     | short      |
  | _int       | int        |
  | _integer   | int        |
  | _double    | double     |
  | _float     | float      |
  | _boolean   | boolean    |
  | string     | String     |
  | byte       | Byte       |
  | long       | Long       |
  | short      | Short      |
  | int        | Integer    |
  | integer    | Integer    |
  | double     | Double     |
  | float      | Float      |
  | boolean    | Boolean    |
  | date       | Date       |
  | decimal    | BigDecimal |
  | bigdecimal | BigDecimal |
  | object     | Object     |
  | map        | Map        |
  | hashmap    | HashMap    |
  | list       | List       |
  | arraylist  | ArrayList  |
  | collection | Collection |
  | iterator   |            |

# [7.resultMap](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_7resultmap)

 用于映射结果集，当查询结果中字段与实体属性名不一致需要用到ResultMap标签映射，

1. `<id>`用于主键字段，区分数据唯一性。
2. `<result>` 映射非主键字段;

- column: 表示映射的结果集中的字段
- property:映射的实体中的属性名字
- JdbcType: 数据库中字段类型
- JavaType: 属性的java类型

> demo：

```xml
    <resultMap id="resultMap" type="com.neuedu.entity.UploadFile">
<!--        <id column="id" property="id" jdbcType="int"  javaType="Integer"></id>-->
        <id     property="id"           column="id"         ></id>
        <result property="originName"   column="origin_name"></result>
        <result property="path"         column="path"></result>
        <result property="size"         column="size"></result>
        <result property="ip"           column="ip"></result>
        <result property="uploadTime"   column="upload_time"></result>
    </resultMap>
```

在查询标签上，添加resultMap属性，使用该resultMap 转换结果集映射关系

```xml
<select id="selectListofEntity" resultMap="resultMap" >
    select * from upload_files
</select>
```

# [6.使用SQLSession封装Dao](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_6使用sqlsession封装dao)

# [7.Mapper代理的形式开发](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_7mapper代理的形式开发)

跟原生SQLSession接口一样需要搭建myabtis，

## [7.1 添加加依赖](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_71-添加加依赖)

## [7.2 创建SqlMapConfig.xml](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_72-创建sqlmapconfigxml)

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>

    <properties resource="jdbc.properties"/>

    <environments default="dev">
        <environment id="dev">
            <transactionManager type="JDBC"></transactionManager>
            <dataSource type="UNPOOLED">
                <property name="username"   value="${jdbc.username}"/>
                <property name="password"   value="${jdbc.password}"/>
                <property name="url"        value="${jdbc.url}"/>
                <property name="driver"     value="${jdbc.driver}"/>
            </dataSource>
        </environment>
    </environments>



    <mappers>
        <mapper resource="UploadFilesMapper.xml"></mapper>
    </mappers>

</configuration>
```

## [7.3 定义Mapper代理对象的接口](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_73-定义mapper代理对象的接口)

```java
package com.neuedu.dao;

import com.neuedu.entity.UploadFile;
import com.neuedu.util.SqlSessionUtils;
import org.apache.ibatis.session.SqlSession;

import java.util.List;
import java.util.Map;

public interface UploadFilesMapper {


    /**
     * 查询集合
     *
     * @return
     */

    /**
     *  com.neuedu.dao.UploadFilesDao.selectListofEntity
     * @return
     */
    public List<UploadFile> selectListofEntity();


    /**
     * com.neuedu.dao.UploadFilesDao.selectById
     * @param id
     * @return
     */
    public UploadFile selectById(Integer id);

    public int selectCount();

    public int save(UploadFile uploadFile);

    public int update(UploadFile uploadFile);

    public int deleteById(Integer id);
}
```

## [7.4 编写Mapper映射文件](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_74-编写mapper映射文件)

编写(UploadFilesMapper.xml)

1. namespace为Mapper接口的全限定名
2. 方法上：
   1. 方法名 跟 Mapperd Statement id保持一致
   2. 方法入参 跟Statement 的入参一致
   3. 返回值类型如果是集合List，否则是其他类型

![img](https://jshand.gitee.io/imgs/mybatis/2021-03-23_090815.png)

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.neuedu.dao.UploadFilesMapper">

    <resultMap id="resultMap" type="com.neuedu.entity.UploadFile">
        <!--        <id column="id" property="id" jdbcType="int"  javaType="Integer"></id>-->
        <id property="id" column="id"></id>
        <result property="originName" column="origin_name"></result>
        <result property="path" column="path"></result>
        <result property="size" column="size"></result>
        <result property="ip" column="ip"></result>
        <result property="uploadTime" column="upload_time"></result>
    </resultMap>


    <!--使用 Entity 如果 字段跟属性名称不一致，set无效，需要有一个机制，转换 -->
    <select id="selectListofEntity" resultMap="resultMap">
            select * from upload_files
    </select>


    <!--    根据主键查询一条 selectOne-->
    <select id="selectById" resultMap="resultMap" parameterType="int">
            select * from upload_files where id = #{id}
    </select>


    <!--    查询总条数-->
    <select id="selectCount" resultType="int">
            select count(1) from upload_files
    </select>


    <!-- 插入数据-->
    <insert id="save" parameterType="com.neuedu.entity.UploadFile">
         INSERT INTO upload_files (  origin_name,  path, upload_time, size,  ip  )
            VALUES   (  #{originName},  #{path},  #{uploadTime},  #{size},  #{ip}  )
    </insert>



    <!--    更新数据-->
    <update id="update" parameterType="com.neuedu.entity.UploadFile">
        UPDATE
          upload_files
        SET
          origin_name= #{originName},
          path= #{path},
          upload_time= #{uploadTime},
          size= #{size},
          ip= #{ip}
        WHERE id= #{id}

    </update>

    <!--    根据主键删除数据-->
    <delete id="deleteById" parameterType="int">
        delete from upload_files where id = #{id}
    </delete>

</mapper>
```

## [7.5 编写的Mapper.xml配置到SqlMapConfig.xml中](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_75-编写的mapperxml配置到sqlmapconfigxml中)

使用的是resource属性配置资源映射

```
<mappers>
<mapper resource="UploadFilesMapper.xml"></mapper>
</mappers>
```

## [7.6. 单元测试](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_76-单元测试)

```java
package com.neuedu.dao;

import com.neuedu.dao.UploadFilesMapper;
import com.neuedu.entity.UploadFile;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;
import org.junit.Before;
import org.junit.Test;

import java.io.IOException;
import java.io.InputStream;
import java.util.Date;
import java.util.List;

import static org.junit.Assert.*;

public class UploadFilesMapperTest {



    SqlSessionFactory sqlSessionFactory;


    @Before
    public void setup() throws IOException {

        InputStream is = Resources.getResourceAsStream("SqlMapConfig.xml");
        sqlSessionFactory = new SqlSessionFactoryBuilder().build(is);
    }



    @Test
    public void selectListofEntity() {
        SqlSession session = sqlSessionFactory.openSession();
        UploadFilesMapper uploadFilesMapper = session.getMapper(UploadFilesMapper.class); //通过mybatis产生一个 代理对象
        List<UploadFile> list = uploadFilesMapper.selectListofEntity();
        for (UploadFile o : list) {
            System.out.println(o);
        }
    }

    @Test
    public void selectById() {
        SqlSession session = sqlSessionFactory.openSession();
        UploadFilesMapper UploadFilesMapper = session.getMapper(UploadFilesMapper.class); //通过mybatis产生一个 代理对象
        Integer id = 17;
        System.out.println(UploadFilesMapper.selectById(id));
    }

    @Test
    public void selectCount() {
        SqlSession session = sqlSessionFactory.openSession();
        UploadFilesMapper UploadFilesMapper = session.getMapper(UploadFilesMapper.class); //通过mybatis产生一个 代理对象
        int count = UploadFilesMapper.selectCount();
        System.out.println("count = " + count);
    }

    @Test
    public void save() {
        SqlSession session = sqlSessionFactory.openSession();
        UploadFilesMapper UploadFilesMapper = session.getMapper(UploadFilesMapper.class); //通过mybatis产生一个 代理对象
        UploadFile uploadFile = new UploadFile();

        uploadFile.setOriginName("考试成绩.xls");
        uploadFile.setPath("asdofuhsaofhsadofhsaofjshUploadFilesMapperp.xls");
        uploadFile.setUploadTime(new Date());
        uploadFile.setIp("127.0.0.1");
        uploadFile.setSize(500L);

        int count  = UploadFilesMapper.save(uploadFile);


        System.out.println("count = " + count);


    }

    @Test
    public void update() {
        SqlSession session = sqlSessionFactory.openSession();
        UploadFilesMapper UploadFilesMapper = session.getMapper(UploadFilesMapper.class); //通过mybatis产生一个 代理对象
        Integer id = 17;

        UploadFile uploadFile = UploadFilesMapper.selectById(id);
        System.out.println("update before :  "+uploadFile);

        uploadFile.setOriginName(uploadFile.getOriginName()+"-2021年3月22日16:19:14");
        int count = UploadFilesMapper.update(uploadFile);
        uploadFile = UploadFilesMapper.selectById(id);
        System.out.println("count = " + count);
        System.out.println("update after :  "+uploadFile);
    }

    @Test
    public void deleteById() {
        SqlSession session = sqlSessionFactory.openSession();
        UploadFilesMapper UploadFilesMapper = session.getMapper(UploadFilesMapper.class); //通过mybatis产生一个 代理对象
        Integer id = 18;
        int count =  UploadFilesMapper.deleteById(id);
        System.out.println("count = " + count);
    }
}
```

## [7.7 使用Class 映射Mapper](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_77-使用class-映射mapper)

 在SqlMapConfig中使用class 映射Mapper 需要满足如下条件:

1. mapper.xml中namespace为Mapper接口的全限定名一致
2. Mapper.xml和Mapper.java文件名称保持一致(扩展名除外，xml、java)
3. Mapper.xml和Mapper.java编译的目标位置相同

```xml
<mappers>
    <!--使用Class映射的Mapper  -->
    <mapper class="com.neuedu.dao.UploadFilesMapper"/>
</mappers>
```

## [7.8 使用package扫描](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_78-使用package扫描)

同class注册Mapper的要求是一样的

```xml
<mappers>
    <package name="com.neuedu.dao"/>
</mappers>
```

# [8.动态sql](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_8动态sql)

动态 SQL 是 MyBatis 的强大特性之一。如果你使用过 JDBC 或其它类似的框架，你应该能理解根据不同条件拼接 SQL 语句有多痛苦，例如拼接时要确保不能忘记添加必要的空格，还要注意去掉列表最后一个列名的逗号。利用动态 SQL，可以彻底摆脱这种痛苦。

使用动态 SQL 并非一件易事，但借助可用于任何 SQL 映射语句中的强大的动态 SQL 语言，MyBatis 显著地提升了这一特性的易用性。

- if
- choose (when, otherwise)
- trim (where, set)
- foreach

## [8.1 If](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_81-if)

使用if根据条件动态拼接sql，常用语where条件

```xml
<select id="selectListofEntity" resultMap="resultMap" parameterType="com.neuedu.entity.UploadFile">
        select * from upload_files
        where 1=1
        <if test="originName!=null and originName != ''">
            and origin_name = #{originName}
        </if>
    </select>
```

## [8.2 where](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_82-where)

`where`元素只会在子元素返回任何内容的情况下才插入 “WHERE” 子句。而且，若子句的开头为 “AND” 或 “OR”，`where` 元素也会将它们去除。

```xml
<select id="selectListofEntity" resultMap="resultMap" parameterType="com.neuedu.entity.UploadFile">
        select * from upload_files
        <where >
            <if test="originName!=null and originName != ''">
                and origin_name = #{originName}
            </if>
             <if test="size!=null">
                and size > #{size}
            </if>
        </where>
    </select>
```

### [8.2.1 单元测试的情况](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_821-单元测试的情况)

```java
@Test
public void selectListofEntity() {
    SqlSession session = sqlSessionFactory.openSession();
    UploadFilesMapper uploadFilesMapper = session.getMapper(UploadFilesMapper.class); //通过mybatis产生一个 代理对象


    UploadFile param = new UploadFile();
    //通过控制参数达到动态拼接sql的目的
    param.setOriginName("314.png");
    param.setSize(500L);

    List<UploadFile> list = uploadFilesMapper.selectListofEntity(param);
    for (UploadFile o : list) {
        System.out.println(o);
    }
    session.close();
}
```

### [8.2.2 等价的trim标签](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_822-等价的trim标签)

```xml
<select id="selectListofEntity" resultMap="resultMap" parameterType="com.neuedu.entity.UploadFile">
        select * from upload_files
        <trim prefix="where" prefixOverrides="and|or">

            <if test="originName!=null and originName != ''">
                or origin_name = #{originName}
            </if>
            <if test="size!=null">
                or size > #{size}
            </if>
     </trim>
    </select>
```

## [8.3 set标签](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_83-set标签)

`set`元素会动态地在行首插入 SET 关键字，并会删掉额外的逗号（这些逗号是在使用条件语句给列赋值时引入的）。

```xml
<update id="update" parameterType="com.neuedu.entity.UploadFile">
        UPDATE
        upload_files
        <set>
            <if test="originName!=null and originName!='' ">
                origin_name= #{originName},
            </if>
            <if test="path!=null and path!='' ">
                path= #{path},
            </if>
            <if test="uploadTime!=null ">
                upload_time= #{uploadTime},
            </if>
            <if test="size!=null ">
                size= #{size},
            </if>
            <if test="ip!=null and ip != ''">
                ip= #{ip},
            </if>
        </set>
        WHERE id= #{id}

    </update>
```

### [8.3.1单元测试](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_831单元测试)

```java
@Test
public void update() {
    SqlSession session = sqlSessionFactory.openSession();
    UploadFilesMapper UploadFilesMapper = session.getMapper(UploadFilesMapper.class); //通过mybatis产生一个 代理对象
    Integer id = 24;

    UploadFile uploadFile = UploadFilesMapper.selectById(id);
    System.out.println("update before :  "+uploadFile);

    uploadFile.setOriginName(uploadFile.getOriginName()+"-2021年3月22日16:19:14");
    int count = UploadFilesMapper.update(uploadFile);
    session.commit();


    uploadFile = UploadFilesMapper.selectById(id);
    System.out.println("count = " + count);
    System.out.println("update after :  "+uploadFile);
}
```

### [8.3.2 等价的trim标签](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_832-等价的trim标签)

```xml
<update id="update" parameterType="com.neuedu.entity.UploadFile">
    UPDATE
    upload_files

    <trim prefix="set" suffixOverrides=",">
        <if test="originName!=null and originName!='' ">
            origin_name= #{originName},
        </if>
        <if test="path!=null and path!='' ">
            path= #{path},
        </if>
        <if test="uploadTime!=null ">
            upload_time= #{uploadTime},
        </if>
        <if test="size!=null ">
            size= #{size},
        </if>
        <if test="ip!=null and ip != ''">
            ip= #{ip},
        </if>
    </trim>
    WHERE id= #{id}

</update>
```

## [8.4 choose (when ,otherwise)](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_84-choose-when-otherwise)

有时候，我们不想使用所有的条件，而只是想从多个条件中选择一个使用。针对这种情况，MyBatis 提供了 choose 元素，它有点像 Java 中的 switch 语句。

当第一个when条件成立则第一个条件作为sql的一部分，否则继续后面 when 判断，所有的when 都不满，则拼接otherwise的条件

```xml
<select id="selectCount" resultType="int">
        select count(1) from upload_files

        where 1=1
    <choose>
        <when test="originName!=null and originName != ''">
            and origin_name = #{originName}
        </when>
        <otherwise>
            and size > #{size}
        </otherwise>

    </choose>
</select>
```

## [8.5 trim](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_85-trim)

| 属性名          | 属性解释                                                     |
| --------------- | ------------------------------------------------------------ |
| prefix          | 要添加的前缀。比如这里因为没有使用WHERE，按照语法格式条件必须要有WHERE。此时就可以使用prefix属性给整个条件语句块前面添加一个`WHERE`关键字。 |
| prefixOverrides | 要删除的前缀。如果多出来指定的前缀，则将这些多出来的前缀修剪去除。比如:如果在整个语句中需要修剪去`AND` |
| suffix          | 要添加的后缀。使用方式与prefix类似，只是prefix是增加前缀，而suffix是添加一个后缀在被包裹的语句块中。 |
| suffixOverrides | 要删除的后缀。使用方式与prefixOverrides类似，只是一个是去除前面多余的关键字，suffixOverrides是删除多余后面的。 |

## [8.6 foreach](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_86-foreach)

动态 SQL 的另一个常见使用场景是对集合进行遍历（尤其是在构建 IN 条件语句的时候）

### [8.6.1 Statement写法](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_861-statement写法)

```xml
<delete id="deleteBatch">
        DELETE FROM upload_files WHERE id IN

        <foreach item="item" index="index" collection="list"  open="(" separator="," close=")">
            #{item}
        </foreach>

    </delete>

    <delete id="deleteBatch2">
        DELETE FROM upload_files WHERE id IN

        <foreach item="item" index="index" collection="array"  open="(" separator="," close=")">
            #{item}
        </foreach>

    </delete>
```

### [8.6.12 Mapper接口](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_8612-mapper接口)

```java
 public int deleteBatch( List list);

 public int deleteBatch2(Integer[] ids);
```

## [8.7 bind](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_87-bind)

用于在ongl上下文中定义变量

### [8.7.1 Statement语句](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_871-statement语句)

```xml
<select id="selectListofEntityWithBind" resultMap="resultMap" parameterType="com.neuedu.entity.UploadFile">
        select * from upload_files
    <where >

        <if test="originName!=null and originName != ''">
            <bind name="originNameAlias" value="  '%'+originName+'%'  "/>
            and origin_name  like '${originNameAlias}'
        </if>

    </where>
</select>
```

### [8.7.2 Mapper声明](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_872-mapper声明)

```java
public List<UploadFile> selectListofEntityWithBind(UploadFile uploadFile)
```

### [8.7.3 单元测试](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_873-单元测试)

```java
@Test
public void selectListofEntityWithBind() {
    SqlSession session = sqlSessionFactory.openSession();
    UploadFilesMapper uploadFilesMapper = session.getMapper(UploadFilesMapper.class); //通过mybatis产生一个 代理对象


    UploadFile param = new UploadFile();
    param.setOriginName("314");

    List<UploadFile> list = uploadFilesMapper.selectListofEntityWithBind(param);
    for (UploadFile o : list) {
        System.out.println(o);
    }
    session.close();
}
```

# [9#和$的区别](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_9和的区别)

1. \#是绑定变量
2. $拼接字符串 ,慎用

# [10.sql片段](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_10sql片段)

使用`sql`标签,定义sql片段，使用`include`在需要的位置引入片段

# [11.MybatisGenerator](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_11mybatisgenerator)

## [11.1 批量查询selectByExample](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_111-批量查询selectbyexample)

 根据条件动态查询,需要构造Example

```java
UploadFilesExample example = new UploadFilesExample();
UploadFilesExample.Criteria c = example.createCriteria();
```

> Criteria的方法

```java
c.andIdEqualTo(17);                      //id = ?
c.andIdGreaterThan(6);                     // id >?
c.andIdGreaterThanOrEqualTo(6);            // id>=?
c.andSizeIsNull();                        // and size is null
c.andSizeBetween(500,600);                // size between ? and ?
c.andOriginNameLike("%3%");             // origin_name like ?
```

### [11.1.2 单元测试](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1112-单元测试)

```java
/**
     * 批量查询
     */
    @Test
    public void selectByExample() {

        SqlSession session = sqlSessionFactory.openSession();
        UploadFilesMapper mapper = session.getMapper(UploadFilesMapper.class);


        UploadFilesExample example = new UploadFilesExample();

        // select * from table where   ( Criteria  )   and/or (  Criteria )
        UploadFilesExample.Criteria c = example.createCriteria();

        //andXXXXEqualTo
//        c.andIdEqualTo(17);  id = ?
//        c.andIdGreaterThan(6); // id >?
//        c.andIdGreaterThanOrEqualTo(6);// id>=?
//
//        c.andSizeIsNull();// and size is null
//        c.andSizeBetween(500,600);// size between ? and ?

        c.andOriginNameLike("%3%"); // origin_name like ?


        List<UploadFiles> list = mapper.selectByExample(example);
        for (UploadFiles uploadFiles : list) {
            System.out.println(uploadFiles);
        }
        session.close();
    }
```

## [11.2 根据主键查询 selectByPrimaryKey](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_112-根据主键查询-selectbyprimarykey)

```java
@Test
public void selectByPrimaryKey() {
    SqlSession session = sqlSessionFactory.openSession();
    UploadFilesMapper mapper = session.getMapper(UploadFilesMapper.class);
    UploadFiles uploadFiles = mapper.selectByPrimaryKey(17);

    System.out.println(uploadFiles);
    session.close();

}
```

sql语句如下：

```sql
select id, origin_name, path, upload_time, size, ip from upload_files where id = ?
```

## [11.3 全量字段插入 insert](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_113-全量字段插入-insert)

需要所有字段都提供值，如果没有提供插入的值，则插入为null，会覆盖字段的默认值

```java
@Test
    public void insert() {

        SqlSession session = sqlSessionFactory.openSession();
        UploadFilesMapper mapper = session.getMapper(UploadFilesMapper.class);


        UploadFiles uploadFiles = new UploadFiles();
        uploadFiles.setId(26);
        uploadFiles.setOriginName("aaaa.png");
        uploadFiles.setPath("aaaaaaaaaaaa.png");
        uploadFiles.setSize(10000);


        int count  = mapper.insert(uploadFiles);

        System.out.println("count = " + count);

        session.commit();
        session.close();

    }
```

sql语句如下：

```sql
insert into upload_files (id, origin_name, path, upload_time, size, ip ) values (?, ?, ?, ?, ?, ? )
```

## [11.4 选择性插入 insertSelective](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_114-选择性插入-insertselective)

据提供的字段，生成插入的sql ,不会覆盖没有插入字段的 默认值

```java
@Test
    public void insertSelective() {

        SqlSession session = sqlSessionFactory.openSession();
        UploadFilesMapper mapper = session.getMapper(UploadFilesMapper.class);


        UploadFiles uploadFiles = new UploadFiles();
        uploadFiles.setId(27);
        uploadFiles.setOriginName("aaaa.png");
        uploadFiles.setPath("aaaaaaaaaaaa.png");
        uploadFiles.setSize(10000);



        int count  = mapper.insertSelective(uploadFiles);

        System.out.println("count = " + count);

        session.commit();
        session.close();
    }
```

sql语句如下:

```sql
insert into upload_files ( id, origin_name, path, size ) values ( ?, ?, ?, ? )
```

# [12 关联查询](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_12-关联查询)

数据准备：

```sql
/*
SQLyog Ultimate v12.08 (64 bit)
MySQL - 5.7.18 : Database - mybatis_java1
*********************************************************************
*/


/*!40101 SET NAMES utf8 */;

/*!40101 SET SQL_MODE=''*/;

/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;
CREATE DATABASE /*!32312 IF NOT EXISTS*/`mybatis_java1` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin */;

USE `mybatis_java1`;

/*Table structure for table `account` */

DROP TABLE IF EXISTS `account`;

CREATE TABLE `account` (
  `acc_id` int(11) NOT NULL AUTO_INCREMENT,
  `stu_id` int(11) DEFAULT NULL,
  `acc_amout` varchar(500) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`acc_id`),
  KEY `AK_Key_1` (`acc_id`),
  KEY `FK_Reference_1` (`stu_id`),
  CONSTRAINT `FK_Reference_1` FOREIGN KEY (`stu_id`) REFERENCES `student` (`stu_id`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;

/*Data for the table `account` */

insert  into `account`(`acc_id`,`stu_id`,`acc_amout`) values (1,1,'50'),(2,2,'60'),(3,3,'80'),(4,4,'90'),(5,5,'500');

/*Table structure for table `order_detail` */

DROP TABLE IF EXISTS `order_detail`;

CREATE TABLE `order_detail` (
  `detail_id` int(11) NOT NULL,
  `order_id` int(11) DEFAULT NULL,
  `product_name` varchar(500) COLLATE utf8mb4_bin DEFAULT NULL,
  `price` decimal(10,2) DEFAULT NULL,
  PRIMARY KEY (`detail_id`),
  KEY `FK_Reference_2` (`order_id`),
  CONSTRAINT `FK_Reference_2` FOREIGN KEY (`order_id`) REFERENCES `product_order` (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;

/*Data for the table `order_detail` */

insert  into `order_detail`(`detail_id`,`order_id`,`product_name`,`price`) values (1,1,'保温壶','20.00'),(2,1,'报纸','30.00'),(3,2,'唐诗三百首','100.00'),(4,2,'儿童玩具车','400.00'),(5,2,'婴儿车','100.00');

/*Table structure for table `product_order` */

DROP TABLE IF EXISTS `product_order`;

CREATE TABLE `product_order` (
  `order_id` int(11) NOT NULL AUTO_INCREMENT,
  `createtime` datetime DEFAULT NULL,
  `amount` decimal(10,2) DEFAULT NULL,
  `addressee` varchar(100) COLLATE utf8mb4_bin DEFAULT NULL,
  `address` varchar(100) COLLATE utf8mb4_bin DEFAULT NULL,
  `status` varchar(100) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`order_id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;

/*Data for the table `product_order` */

insert  into `product_order`(`order_id`,`createtime`,`amount`,`addressee`,`address`,`status`) values (1,'2021-03-24 16:22:27','50.00','张三','黑龙江','代发货'),(2,'2021-03-10 16:22:49','600.00','王五','辽宁','已签收');

/*Table structure for table `stu_teacher_rela` */

DROP TABLE IF EXISTS `stu_teacher_rela`;

CREATE TABLE `stu_teacher_rela` (
  `teacher_id` int(11) DEFAULT NULL,
  `stu_id` int(11) DEFAULT NULL,
  KEY `FK_Reference_3` (`teacher_id`),
  KEY `FK_Reference_4` (`stu_id`),
  CONSTRAINT `FK_Reference_3` FOREIGN KEY (`teacher_id`) REFERENCES `teacher` (`teacher_id`),
  CONSTRAINT `FK_Reference_4` FOREIGN KEY (`stu_id`) REFERENCES `student` (`stu_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;

/*Data for the table `stu_teacher_rela` */

insert  into `stu_teacher_rela`(`teacher_id`,`stu_id`) values (1,1),(1,2),(2,2),(2,3),(3,3),(3,4),(3,5);

/*Table structure for table `student` */

DROP TABLE IF EXISTS `student`;

CREATE TABLE `student` (
  `stu_id` int(11) NOT NULL AUTO_INCREMENT,
  `stu_name` varchar(500) COLLATE utf8mb4_bin DEFAULT NULL,
  `stu_no` varchar(500) COLLATE utf8mb4_bin DEFAULT NULL,
  `birthday` datetime DEFAULT NULL,
  `address` varchar(500) COLLATE utf8mb4_bin DEFAULT NULL,
  `face` varchar(500) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`stu_id`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;

/*Data for the table `student` */

insert  into `student`(`stu_id`,`stu_name`,`stu_no`,`birthday`,`address`,`face`) values (1,'哈利波特','17040001','2021-03-24 14:06:40','伦敦','1'),(2,'郭靖','17040002','2021-03-24 14:06:43','大宋','2'),(3,'奥特曼','17040003','2021-03-16 14:06:44','日本','3'),(4,'成吉思汗','17040004','2021-03-10 14:06:46','蒙古','4'),(5,'特朗普','17040005','2021-03-24 14:06:48','美国','5');

/*Table structure for table `teacher` */

DROP TABLE IF EXISTS `teacher`;

CREATE TABLE `teacher` (
  `teacher_id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(500) COLLATE utf8mb4_bin DEFAULT NULL,
  `age` int(11) DEFAULT NULL,
  `salary` decimal(6,2) DEFAULT NULL,
  PRIMARY KEY (`teacher_id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;

/*Data for the table `teacher` */

insert  into `teacher`(`teacher_id`,`name`,`age`,`salary`) values (1,'张飞',50,'5555.01'),(2,'赵云',55,'8873.00'),(3,'刘备',66,'88.00');

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;
```

## [12.1 一对一关联查询](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_121-一对一关联查询)

- 通过全量sql，join on两张表关联查询。

  - 实体中需要枚举出所有的属性
  - resultMap将所有字段映射成实体中的属性

- association 需要执行两种sql，主表一种sql，从表一种sql。

  - 实体中（主表的实体）:添加从表的属性。
  - resultMap：主表信息映射跟单表查询保持不动，关联从表的属性 需要用association 关联需要给association 指定几个属性
    - property: 从表在主表实体中的属性名字
    - select : 查询从表的Statement ID
    - column： 从表查询是关联条件字段

  具体Mapper.xml语法如下：

  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.neuedu.dao.One2OneMapper">
  
      <resultMap id="resultMap1" type="com.neuedu.entity.StudentAndAccount">
  
          <!--学生的 -->
          <id column="stu_id" jdbcType="INTEGER" property="stuId"/>
          <result column="stu_name" jdbcType="VARCHAR" property="stuName"/>
          <result column="stu_no" jdbcType="VARCHAR" property="stuNo"/>
          <result column="birthday" jdbcType="TIMESTAMP" property="birthday"/>
          <result column="address" jdbcType="VARCHAR" property="address"/>
          <result column="face" jdbcType="VARCHAR" property="face"/>
  
          <!--账户的信息 -->
  
          <result column="acc_id" jdbcType="INTEGER" property="accId"/>
          <result column="stu_id" jdbcType="INTEGER" property="stuId"/>
          <result column="acc_amout" jdbcType="VARCHAR" property="accAmout"/>
  
      </resultMap>
  
      <resultMap id="resultMap2" type="com.neuedu.entity.Student">
  
          <!--学生的 -->
          <id column="stu_id" jdbcType="INTEGER" property="stuId"/>
          <result column="stu_name" jdbcType="VARCHAR" property="stuName"/>
          <result column="stu_no" jdbcType="VARCHAR" property="stuNo"/>
          <result column="birthday" jdbcType="TIMESTAMP" property="birthday"/>
          <result column="address" jdbcType="VARCHAR" property="address"/>
          <result column="face" jdbcType="VARCHAR" property="face"/>
  
          <!--账户的信息 -->
          <association property="account" column="stu_id" select="selectAccount">
          </association>
  ```

```
  </resultMap>


  <select id="selectStudentAndAccount" resultMap="resultMap1">
  SELECT
    student.stu_id,
    stu_name,
    stu_no,
    birthday,
    address,
    face,

    acc_id,
    acc_amout
  FROM
    student
    INNER JOIN account
      ON student.stu_id = account.stu_id
</select>

  <select id="selectStudentAndAccount2" resultMap="resultMap2">
  SELECT
    student.stu_id,
    stu_name,
    stu_no,
    birthday,
    address,
    face
  FROM student
</select>


  <select id="selectAccount" resultMap="com.neuedu.dao.AccountMapper.BaseResultMap" >
  select   acc_id, stu_id, acc_amout from account where stu_id = #{stu_id}
</select>
```

\```

## [12.2 延迟加载](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_122-延迟加载)

在关联查询是 使用 association 或者是collection 可以设置按需加载(获取从表对象的属性)，需要配置：

```xml
<setting name="lazyLoadingEnabled" value="true"/>
<setting name="aggressiveLazyLoading" value="false"/>
```

## [12.3. 一对多](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_123-一对多)

查询时需要通过collection标签识别从表的集合的信息:

- 如果是全量查询，需要指定：
  - property：从表在主表中的实体属性名
  - ofType：从表实体全限定名
  - 并在collection子标签中添加id、result标签映射从表中的字段

```xml
    <resultMap id="resultMap" type="com.neuedu.entity.MyProductOrder">

        <!-- 主表 -->
        <id column="order_id" jdbcType="INTEGER" property="orderId"/>
        <result column="createtime" jdbcType="TIMESTAMP" property="createtime"/>
        <result column="amount" jdbcType="DECIMAL" property="amount"/>
        <result column="addressee" jdbcType="VARCHAR" property="addressee"/>
        <result column="address" jdbcType="VARCHAR" property="address"/>
        <result column="status" jdbcType="VARCHAR" property="status"/>

        <collection property="orderDetails" ofType="com.neuedu.entity.OrderDetail">

            <id column="detail_id" jdbcType="INTEGER" property="detailId"/>
            <result column="order_id" jdbcType="INTEGER" property="orderId"/>
            <result column="product_name" jdbcType="VARCHAR" property="productName"/>
            <result column="price" jdbcType="DECIMAL" property="price"/>
        </collection>

    </resultMap>


    <select id="selectOrder" resultMap="resultMap">
    SELECT


      product_order.order_id,
      createtime,
      amount,
      addressee,
      address,
      STATUS,

      detail_id,
      product_name,
      price

     FROM product_order INNER JOIN  order_detail ON product_order.order_id = order_detail.order_id

    </select>
```

- 如果是延迟同样需要collection标签映射从表信息，额外需要指定如下属性
  - select: 从表查询sql的Statement ID
  - column：从表查询语句中的关联条件

```xml
<resultMap id="resultMap2" type="com.neuedu.entity.MyProductOrder" extends="com.neuedu.dao.ProductOrderMapper.BaseResultMap">
        <collection property="orderDetails" ofType="com.neuedu.entity.OrderDetail"
                    select="selectOrderDetailByOrderId" column="order_id">
        </collection>

    </resultMap>

    <select id="selectOrder2" resultMap="resultMap2">
    SELECT
      product_order.order_id,
      createtime,
      amount,
      addressee,
      address,
      STATUS

        FROM product_order

    </select>


    <select id="selectOrderDetailByOrderId" resultMap="com.neuedu.dao.OrderDetailMapper.BaseResultMap">
        select  detail_id, order_id, product_name, price from order_detail where  order_id = #{orderId}
    </select>
```

## [12.4 多对多的关系](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_124-多对多的关系)

数据库中的多对多关系往往可以看做两个一对多的关系，在mybatis中可以通过嵌套实现多对多的关系，collection嵌套association或者 association嵌套collection 使用

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.neuedu.dao.Many2ManyMapper">

    <resultMap id="teahcerMap" type="com.neuedu.entity.MyTeacher">
        <!-- 主表 Teacher -->
        <id column="teacher_id" jdbcType="INTEGER" property="teacherId" />
        <result column="name" jdbcType="VARCHAR" property="name" />
        <result column="age" jdbcType="INTEGER" property="age" />
        <result column="salary" jdbcType="DECIMAL" property="salary" />


        <!-- 从表 StudentTeacher
                property : 从表再主表实体中的属性 student_teahcer
                ofType : 从表单行记录映射的实体
                select: 查询从表的 sql（Mapperd Statement Id）
        -->
        <collection
                property="studentTeachers"
                ofType="com.neuedu.entity.StudentTeacher"
                select="selectStudentTeacher"
                column="teacher_id"
            >

        </collection>

    </resultMap>


    <resultMap id="studentTeacherMap" type="com.neuedu.entity.StudentTeacher">
        <result column="teacher_id" jdbcType="INTEGER" property="teacherId" />
        <result column="stu_id" jdbcType="INTEGER" property="studentId" />

        <association property="student"
                     javaType="com.neuedu.entity.Student"
                     select="selectStudent"
                     column="stu_id">
        </association>
    </resultMap>



    <resultMap id="studentMap" type="com.neuedu.entity.Student" extends="com.neuedu.dao.StudentMapper.BaseResultMap" >

    </resultMap>



    <select id="selectTeachers" resultMap="teahcerMap">

        select  teacher_id, name, age, salary from teacher

    </select>

    <select id="selectStudentTeacher" resultMap="studentTeacherMap">
        SELECT teacher_id ,stu_id FROM stu_teacher_rela WHERE teacher_id = #{teacher_id}
    </select>


    <select id="selectStudent" resultMap="studentMap">
        SELECT stu_id, stu_name, stu_no, birthday, address, face FROM student WHERE stu_id = #{stu_id}
    </select>


    <!--******************************************************************************************** -->
    <resultMap id="teahcerMap2" type="com.neuedu.entity.MyTeacher">
        <!--1 教师主表 -->
        <id column="teacher_id" jdbcType="INTEGER" property="teacherId" />
        <result column="name" jdbcType="VARCHAR" property="name" />
        <result column="age" jdbcType="INTEGER" property="age" />
        <result column="salary" jdbcType="DECIMAL" property="salary" />

        <!--从表 student_teacher -->
        <collection   property="studentTeachers"   ofType="com.neuedu.entity.StudentTeacher"  >
            <result column="teacher_id" jdbcType="INTEGER" property="teacherId" />
            <result column="stu_id" jdbcType="INTEGER" property="studentId" />

            <!--关联学生信息 -->
            <association property="student" javaType="com.neuedu.entity.Student">
                <id column="stu_id" jdbcType="INTEGER" property="stuId" />
                <result column="stu_name" jdbcType="VARCHAR" property="stuName" />
                <result column="stu_no" jdbcType="VARCHAR" property="stuNo" />
                <result column="birthday" jdbcType="TIMESTAMP" property="birthday" />
                <result column="address" jdbcType="VARCHAR" property="address" />
                <result column="face" jdbcType="VARCHAR" property="face" />
            </association>
        </collection>


    </resultMap>


    <!-- 延迟加载不生效 -->
    <select id="selectTeachers2" resultMap="teahcerMap2">
        SELECT
          teacher.teacher_id, NAME, age, salary,
          student.stu_id, stu_name, stu_no, birthday, address, face
        FROM
          teacher
          LEFT JOIN stu_teacher_rela ON teacher.`teacher_id` = stu_teacher_rela.`teacher_id`
          LEFT JOIN student  ON stu_teacher_rela.`stu_id` = student.`stu_id`
    </select>


</mapper>
```

# [13.缓存](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_13缓存)

 MyBatis 内置了一个强大的事务性查询缓存机制，它可以非常方便地配置和定制。为了使它更加强大而且易于配置，我们对 MyBatis 3 中的缓存实现进行了许多改进。

 默认情况下，只启用了本地的会话缓存，它仅仅对一个会话中的数据进行缓存。要启用全局的二级缓存

- 映射语句文件中的所有 select 语句的结果将会被缓存。
- 映射语句文件中的所有 insert、update 和 delete 语句会刷新缓存。
- 缓存会使用最近最少使用算法（LRU, Least Recently Used）算法来清除不需要的缓存。
- 缓存不会定时进行刷新（也就是说，没有刷新间隔）。
- 缓存会保存列表或对象（无论查询方法返回哪种）的 1024 个引用。
- 缓存会被视为读/写缓存，这意味着获取到的对象并不是共享的，可以安全地被调用者修改，而不干扰其他调用者或线程所做的潜在修改。

## [13.1 默认缓存（一级缓存）](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_131-默认缓存（一级缓存）)

mybatis默认在会话级别开启缓存,select查询会触发缓存，当有更新数据则会刷新缓存

```java
@Test
    public void testSelectByExample() {
        SqlSession session = factory.openSession();

        StudentMapper mapper = session.getMapper(StudentMapper.class);

        Student stu1 = mapper.selectByPrimaryKey(1);
        System.out.println("stu1:"+stu1);

        //执行update 触发缓存刷新
//        mapper.updateByPrimaryKey(stu1);


        Student stu2 = mapper.selectByPrimaryKey(1);
        System.out.println("stu2 = " + stu2);

        session.close();

    }
```

## [13.2 二级缓存](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_132-二级缓存)

二级缓存默认关闭，需要手动的打开,在namespace层生效,可以在某一个不需要缓存的 Statement上加`useCache="false"`

- 在SqlMapConfig.xml配置文件中设置cacheEnabled 为true

- 在需要开启缓存的Mapper.xml添加`<cache/>` 标记

  ```xml
  <cache
    eviction="FIFO"
    flushInterval="60000"
    size="512"
    readOnly="true"/>
  ```

- 可用的清除策略有：

  - `LRU` – 最近最少使用：移除最长时间不被使用的对象。
  - `FIFO` – 先进先出：按对象进入缓存的顺序来移除它们。
  - `SOFT` – 软引用：基于垃圾回收器状态和软引用规则移除对象。
  - `WEAK` – 弱引用：更积极地基于垃圾收集器状态和弱引用规则移除对象。

- flushInterval（刷新间隔）属性可以被设置为任意的正整数，设置的值应该是一个以毫秒为单位的合理时间量。 默认情况是不设置，也就是没有刷新间隔，缓存仅仅会在调用语句时刷新。

- size（引用数目）属性可以被设置为任意正整数，要注意欲缓存对象的大小和运行环境中可用的内存资源。默认值是 1024。

   readOnly（只读）属性可以被设置为 true 或 false。只读的缓存会给所有调用者返回缓存对象的相同实例。 因此这些对象不能被修改。这就提供了可观的性能提升。而可读写的缓存会（通过序列化）返回缓存对象的拷贝。 速度上会慢一些，但是更安全，因此默认值是 false。

- 当SQLSession执行commit或者close的时候才添加二级缓存的数据

## [13.3 Mybatis的默认缓存实现 ：](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_133-mybatis的默认缓存实现-：)

```
/**
 *    Copyright 2009-2019 the original author or authors.
 *
 *    Licensed under the Apache License, Version 2.0 (the "License");
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an "AS IS" BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package org.apache.ibatis.cache.impl;

import java.util.HashMap;
import java.util.Map;

import org.apache.ibatis.cache.Cache;
import org.apache.ibatis.cache.CacheException;

/**
 * @author Clinton Begin
 */
public class PerpetualCache implements Cache {

  private final String id;

  private final Map<Object, Object> cache = new HashMap<>();

  public PerpetualCache(String id) {
    this.id = id;
  }

  @Override
  public String getId() {
    return id;
  }

  @Override
  public int getSize() {
    return cache.size();
  }

  @Override
  public void putObject(Object key, Object value) {
    cache.put(key, value);
  }

  @Override
  public Object getObject(Object key) {
    return cache.get(key);
  }

  @Override
  public Object removeObject(Object key) {
    return cache.remove(key);
  }

  @Override
  public void clear() {
    cache.clear();
  }

  @Override
  public boolean equals(Object o) {
    if (getId() == null) {
      throw new CacheException("Cache instances require an ID.");
    }
    if (this == o) {
      return true;
    }
    if (!(o instanceof Cache)) {
      return false;
    }

    Cache otherCache = (Cache) o;
    return getId().equals(otherCache.getId());
  }

  @Override
  public int hashCode() {
    if (getId() == null) {
      throw new CacheException("Cache instances require an ID.");
    }
    return getId().hashCode();
  }

}
```

## [13.4 使用Ehcache类库](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_134-使用ehcache类库)

### [13.4.1 添加依赖](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1341-添加依赖)

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>mybatis-parent-java1</artifactId>
        <groupId>com.neuedu.mybatis</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>08-mybatis-cache</artifactId>
    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.12</version>
            <scope>test</scope>
        </dependency>


        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.49</version>
        </dependency>


        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.5.5</version>
        </dependency>

        <!--第三方的缓存类库 -->
        <dependency>
            <groupId>net.sf.ehcache</groupId>
            <artifactId>ehcache</artifactId>
            <version>2.10.2</version>
        </dependency>
        <!-- 整合Ehcache 和mybatis的Cache -->
        <dependency>
            <groupId>org.mybatis.caches</groupId>
            <artifactId>mybatis-ehcache</artifactId>
            <version>1.1.0</version>
        </dependency>


    </dependencies>

</project>
```

### [13.4.2 开启二级缓存](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1342-开启二级缓存)

在sqlMapConfig.xml中设置 缓存启动

```xml
 <settings>
        <setting name="logImpl" value="STDOUT_LOGGING"/>
        <setting name="lazyLoadingEnabled" value="true"/>
        <setting name="aggressiveLazyLoading" value="false"/>

        <setting name="cacheEnabled" value="true"/>
    </settings>
```

### [13.4.3 在namespace 中添加Ehcache的缓存](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1343-在namespace-中添加ehcache的缓存)

```xml
  <cache type="org.mybatis.caches.ehcache.EhcacheCache"/>
```

### [13.4.4 添加Ehcache主配置文件](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1344-添加ehcache主配置文件)

```xml
<ehcache xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="http://ehcache.org/ehcache.xsd">

    <!--diskStore：缓存数据持久化的目录 地址  -->
    <diskStore path="D:\ehcache" />

    <defaultCache
            maxEntriesLocalHeap="0"
            eternal="false"
            diskPersistent = "true"
            timeToIdleSeconds="1200"
            timeToLiveSeconds="1200">
    </defaultCache>

</ehcache>
```

# [14.分页查询](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_14分页查询)

[文档](https://pagehelper.github.io/docs/howtouse/)

## [14.1 准备分页查询数据](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_141-准备分页查询数据)

```xml
CREATE TABLE `student` (
  `stu_id` int(11) NOT NULL AUTO_INCREMENT,
  `stu_name` varchar(500) COLLATE utf8mb4_bin DEFAULT NULL,
  `stu_no` varchar(500) COLLATE utf8mb4_bin DEFAULT NULL,
  `birthday` datetime DEFAULT NULL,
  `address` varchar(500) COLLATE utf8mb4_bin DEFAULT NULL,
  `face` varchar(500) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`stu_id`)
) ENGINE=InnoDB AUTO_INCREMENT=36 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;

/*Data for the table `student` */

insert  into `student`(`stu_id`,`stu_name`,`stu_no`,`birthday`,`address`,`face`) values (1,'哈利波特','17040001','2021-03-24 14:06:40','伦敦','1'),(2,'郭靖','17040002','2021-03-24 14:06:43','大宋','2'),(3,'奥特曼','17040003','2021-03-16 14:06:44','日本','3'),(4,'成吉思汗','17040004','2021-03-10 14:06:46','蒙古','4'),(5,'特朗普','17040005','2021-03-24 14:06:48','美国','5'),(6,'分页查询0','17040005','2021-03-24 14:06:48','美国','5'),(7,'分页查询1','17040005','2021-03-24 14:06:48','美国','5'),(8,'分页查询2','17040005','2021-03-24 14:06:48','美国','5'),(9,'分页查询3','17040005','2021-03-24 14:06:48','美国','5'),(10,'分页查询4','17040005','2021-03-24 14:06:48','美国','5'),(11,'分页查询5','17040005','2021-03-24 14:06:48','美国','5'),(12,'分页查询6','17040005','2021-03-24 14:06:48','美国','5'),(13,'分页查询7','17040005','2021-03-24 14:06:48','美国','5'),(14,'分页查询8','17040005','2021-03-24 14:06:48','美国','5'),(15,'分页查询9','17040005','2021-03-24 14:06:48','美国','5'),(16,'分页查询10','17040005','2021-03-24 14:06:48','美国','5'),(17,'分页查询11','17040005','2021-03-24 14:06:48','美国','5'),(18,'分页查询12','17040005','2021-03-24 14:06:48','美国','5'),(19,'分页查询13','17040005','2021-03-24 14:06:48','美国','5'),(20,'分页查询14','17040005','2021-03-24 14:06:48','美国','5'),(21,'分页查询15','17040005','2021-03-24 14:06:48','美国','5'),(22,'分页查询16','17040005','2021-03-24 14:06:48','美国','5'),(23,'分页查询17','17040005','2021-03-24 14:06:48','美国','5'),(24,'分页查询18','17040005','2021-03-24 14:06:48','美国','5'),(25,'分页查询19','17040005','2021-03-24 14:06:48','美国','5'),(26,'分页查询20','17040005','2021-03-24 14:06:48','美国','5'),(27,'分页查询21','17040005','2021-03-24 14:06:48','美国','5'),(28,'分页查询22','17040005','2021-03-24 14:06:48','美国','5'),(29,'分页查询23','17040005','2021-03-24 14:06:48','美国','5'),(30,'分页查询24','17040005','2021-03-24 14:06:48','美国','5'),(31,'分页查询25','17040005','2021-03-24 14:06:48','美国','5'),(32,'分页查询26','17040005','2021-03-24 14:06:48','美国','5'),(33,'分页查询27','17040005','2021-03-24 14:06:48','美国','5'),(34,'分页查询28','17040005','2021-03-24 14:06:48','美国','5'),(35,'分页查询29','17040005','2021-03-24 14:06:48','美国','5');
```

## [14.2 使用PageHelper分页查询](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_142-使用pagehelper分页查询)

[官网](https://pagehelper.github.io/)

- 添加依赖

```xml
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper</artifactId>
    <version>5.1.11</version>
</dependency>
```

- 配置PageHelper插件(SqlMapConfig.xml中配置插件)

```xml
<plugins>
    <!-- com.github.pagehelper为PageHelper类所在包名 -->
    <plugin interceptor="com.github.pagehelper.PageInterceptor">

        <property name="helperDialect" value="mysql"/>
        <property name="reasonable" value="true"/>
    </plugin>
</plugins>
```

- 使用

  在需要分页查询的sql 之前设置分页条件

  - startPage(页号，每页显示条数)

```java
public  Page list(){
        SqlSession session = factory.openSession();
        StudentMapper mapper = session.getMapper(StudentMapper.class);

        Page<Object> page = PageHelper.startPage(2, 10);

        List<Student> list = mapper.selectAll();

        for (Student student : list) {
            System.out.println(student);
        }

        // page: 当前线程的分页结果
        System.out.println("page = " + page);


        return page;
}
```

- offsetPage

# [15 SSM框架整合](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_15-ssm框架整合)

- 搭建Spring、Springmvc框架
- 搭建mybatis的框架程序
- 整合mybaits ，Mapper 交给 IOC容器管理

## [15.1 创建Springmvc的程序](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_151-创建springmvc的程序)

- 创建web项目
- 添加依赖
  - spring-webmvc
  - jstl
  - lombok
  - junit :test
  - servlet-api : provide
  - jsp-api :provide
  - jackson

### [15.1.1 POM文件如下:](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1511-pom文件如下)

```xml
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.neuedu.mybatis</groupId>
    <artifactId>ssm</artifactId>
    <version>1.0-SNAPSHOT</version>
    <packaging>war</packaging>

    <name>ssm Maven Webapp</name>
    <!-- FIXME change it to the project's website -->
    <url>http://www.example.com</url>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <maven.compiler.source>1.8</maven.compiler.source>
        <maven.compiler.target>1.8</maven.compiler.target>
        <spring.version>5.1.14.RELEASE</spring.version>
        <junit.version>4.12</junit.version>
        <jstl.version>1.2</jstl.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>${junit.version}</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-webmvc</artifactId>
            <version>${spring.version}</version>
        </dependency>

        <dependency>
            <groupId>jstl</groupId>
            <artifactId>jstl</artifactId>
            <version>${jstl.version}</version>
        </dependency>


        <!--解析对象为json-->
        <!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-core -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-core</artifactId>
            <version>2.9.9</version>
        </dependency>

        <!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-annotations -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-annotations</artifactId>
            <version>2.9.9</version>
        </dependency>

        <!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
            <version>2.9.9.1</version>
        </dependency>


        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.16</version>
        </dependency>
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>javax.servlet-api</artifactId>
            <version>4.0.1</version>
        </dependency>
        <dependency>
            <groupId>javax.servlet.jsp</groupId>
            <artifactId>jsp-api</artifactId>
            <version>2.2</version>
        </dependency>
    </dependencies>


</project>
```

### [15.1.2 配置前端控制器](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1512-配置前端控制器)

在web.xml中配置前端控制器DispatcherServlet

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
         version="4.0">

    <!--配置前端控制器 -->
    <servlet>
      <servlet-name>DispatcherServlet</servlet-name>
      <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
        <init-param>
            <param-name>contextConfigLocation</param-name>
            <param-value>classpath:spring/spring-mvc.xml</param-value>
        </init-param>
    </servlet>

    <servlet-mapping>
        <servlet-name>DispatcherServlet</servlet-name>
        <url-pattern>/</url-pattern>
    </servlet-mapping>


</web-app>
```

### [15.1.3 配置SpringMVC文件](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1513-配置springmvc文件)

- 在resources目录中创建ioc的配置文件, spring/spring-mvc.xml

  - 包扫描

  - mvc:annoation-driver :配置HandlerMapping 、HandlerAdapter、ViewResolver

  - ViewResolver :配置视图解析器 配置前缀、后缀。

    - 日期转换（全局）

  - 配置默认的静态资源处理器

    [mvc:resouece-defult-serlver/](mvc:resouece-defult-serlver/)

  - 全局的异常处理器

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        https://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc.xsd">

    <!--包扫描的形式 注解驱动 -->
    <context:component-scan base-package="com.neuedu"/>

    <!--mvc的注解启动 -->
    <mvc:annotation-driven/>


    <!--默认的静态资源处理器 -->
    <mvc:default-servlet-handler/>

    <!--视图解析器 -->
    <bean class="org.springframework.web.servlet.view.InternalResourceViewResolver">
        <property name="prefix" value="/WEB-INF/"></property>
        <property name="suffix" value=".jsp"></property>
    </bean>


</beans>
```

### [15.3.4 创建Controller使用MVC](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1534-创建controller使用mvc)

- 创建Controller、service，并添加依赖
  - 响应视图的Controller

```java
package com.neuedu.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import java.util.HashMap;
import java.util.Map;

@Controller
public class HelloController {

    /**
     * http://localhost:8080/ssm/index
     * http://127.0.0.1:8080/ssm/index
     * @return
     */
    @RequestMapping("index")
    String hello(){
        return "hello";
    }

}
```

- 响应json的Controller

使用RestController注解注册Controller，所有Controller方法默认响应的是JSON格式数据

```java
package com.neuedu.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import java.util.HashMap;
import java.util.Map;

//@Controller
@RestController
public class UserController {


    /**
     * http://localhost:8080/ssm/map
     * @return
     */
    @RequestMapping("map")
//    @ResponseBody
    Map map(){

        Map map = new HashMap();
        map.put("name","jshand");
        map.put("address","HLJ");
        return map;

    }
}
```

## [15.2 搭建Mybatis环境](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_152-搭建mybatis环境)

- 准备数据
- 添加依赖
- 创建SqlMapConfig.xml
- 添加Mapper.xml、Mapper.java、实体类

### [15.2.1准备ssm数据库](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1521准备ssm数据库)

脚本如下：

```sql
/*
SQLyog Ultimate v12.08 (64 bit)
MySQL - 5.7.18 : Database - ssm-java1
*********************************************************************
*/


/*!40101 SET NAMES utf8 */;

/*!40101 SET SQL_MODE=''*/;

/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;
CREATE DATABASE /*!32312 IF NOT EXISTS*/`ssm-java1` /*!40100 DEFAULT CHARACTER SET utf8 */;

USE `ssm-java1`;

/*Table structure for table `check_apply` */

DROP TABLE IF EXISTS `check_apply`;

CREATE TABLE `check_apply` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `register_id` int(11) DEFAULT NULL COMMENT '病历号',
  `item_id` int(11) DEFAULT NULL COMMENT '项目id',
  `item_name` varchar(100) DEFAULT NULL COMMENT '项目名称',
  `fee` decimal(8,2) DEFAULT NULL COMMENT '检查费用',
  `status` int(11) DEFAULT NULL COMMENT '状态',
  `active` int(11) DEFAULT '1' COMMENT '是否有效，1 有效，0 失效',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=21 DEFAULT CHARSET=utf8 COMMENT='检查申请';

/*Data for the table `check_apply` */

insert  into `check_apply`(`id`,`register_id`,`item_id`,`item_name`,`fee`,`status`,`active`,`createtime`) values (4,4,1,'甲状腺超声（小器官）','110.00',1,1,'2021-01-06 10:05:26'),(5,4,2,'腹部超声','140.00',1,1,'2021-01-06 10:05:26'),(6,7,1,'甲状腺超声（小器官）','110.00',1,1,'2021-01-06 10:09:47'),(7,7,2,'腹部超声','140.00',1,1,'2021-01-06 10:09:47'),(14,8,1,'甲状腺超声（小器官）','110.00',1,1,'2021-01-06 10:13:45'),(15,8,2,'腹部超声','140.00',1,1,'2021-01-06 10:13:45'),(16,8,3,'腋窝超声','50.00',1,1,'2021-01-06 10:20:50'),(17,2,1,'甲状腺超声（小器官）','110.00',4,1,'2021-01-06 11:01:06'),(18,2,2,'腹部超声','140.00',4,1,'2021-01-06 11:01:06'),(19,21,1,'甲状腺超声（小器官）','110.00',2,1,'2021-01-07 15:02:16'),(20,21,2,'腹部超声','140.00',4,1,'2021-01-07 15:02:16');

/*Table structure for table `check_item` */

DROP TABLE IF EXISTS `check_item`;

CREATE TABLE `check_item` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `name` varchar(100) DEFAULT NULL COMMENT '检查名称',
  `fee` decimal(8,2) DEFAULT NULL COMMENT '检查费用',
  `active` int(11) DEFAULT '1' COMMENT '是否有效，1 有效，0 失效',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8 COMMENT='检查项目';

/*Data for the table `check_item` */

insert  into `check_item`(`id`,`name`,`fee`,`active`,`createtime`) values (1,'甲状腺超声（小器官）','110.00',1,'2021-01-05 11:04:44'),(2,'腹部超声','140.00',1,'2021-01-05 13:40:09'),(3,'腋窝超声','50.00',1,'2021-01-05 13:40:27'),(4,'测试待删除','120.00',0,'2021-01-05 13:41:07');

/*Table structure for table `constant_item` */

DROP TABLE IF EXISTS `constant_item`;

CREATE TABLE `constant_item` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `type_id` int(11) DEFAULT NULL COMMENT '类别id',
  `code` varchar(100) DEFAULT NULL COMMENT '常数项代码',
  `name` varchar(100) DEFAULT NULL COMMENT '常数项名称',
  `sort` int(11) DEFAULT NULL COMMENT '排序',
  `active` int(11) DEFAULT '1' COMMENT '是否有效，1 有效，0 失效',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8 COMMENT='常数项表';

/*Data for the table `constant_item` */

insert  into `constant_item`(`id`,`type_id`,`code`,`name`,`sort`,`active`,`createtime`) values (1,1,'1','男',1,1,'2020-12-29 13:40:20'),(2,1,'2','女士',1,1,'2020-12-29 14:05:58'),(3,1,'3','33',333,0,'2020-12-29 14:07:05'),(4,5,'SHOW','展示菜单',0,1,'2021-01-04 11:28:02'),(5,5,'BTN','按钮',0,1,'2021-01-04 11:28:14'),(6,6,'1','是',0,1,'2021-01-04 14:02:59'),(7,6,'2','否',2,1,'2021-01-04 14:03:10'),(8,7,'1','已挂号',0,1,'2021-01-04 14:05:48'),(9,7,'2','已接诊',2,1,'2021-01-04 14:06:05'),(10,7,'3','已退号',3,1,'2021-01-04 14:06:16'),(11,8,'1','待缴费',1,1,'2021-01-06 14:03:27'),(12,8,'2','待检查',2,1,'2021-01-06 14:03:44'),(13,8,'3','已检查',3,1,'2021-01-06 14:03:55'),(14,8,'4','已退费',4,1,'2021-01-06 14:04:04');

/*Table structure for table `constant_type` */

DROP TABLE IF EXISTS `constant_type`;

CREATE TABLE `constant_type` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '主键id',
  `code` varchar(100) DEFAULT NULL COMMENT '代码',
  `name` varchar(100) DEFAULT NULL COMMENT '名称',
  `active` int(11) DEFAULT '1' COMMENT '是否有效，1 有效，0 失效',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8 COMMENT='常数类别';

/*Data for the table `constant_type` */

insert  into `constant_type`(`id`,`code`,`name`,`active`,`createtime`) values (1,'XB','性别',1,'2020-12-29 11:32:19'),(2,'GHZT','挂号状态',1,'2020-12-29 11:51:25'),(3,'JCZT','检查状态',1,'2020-12-29 11:52:26'),(4,'JYZT','检验状态',1,'2020-12-29 14:04:48'),(5,'MENU_TYPE','菜单类型',1,'2021-01-04 11:27:35'),(6,'IS_BOOK','是否需要病历本',1,'2021-01-04 14:02:38'),(7,'REGISTER_STATUS','挂号状态',1,'2021-01-04 14:05:36'),(8,'APPLY_STATUS','申请状态（检查、检验）',1,'2021-01-06 14:02:19');

/*Table structure for table `department` */

DROP TABLE IF EXISTS `department`;

CREATE TABLE `department` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `name` varchar(100) DEFAULT NULL COMMENT '名称',
  `address` varchar(200) DEFAULT NULL COMMENT '办公地址',
  `leader` varchar(100) DEFAULT NULL COMMENT '负责人',
  `active` int(11) DEFAULT '1' COMMENT '是否有效，1 有效，0 失效',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8 COMMENT='科室';

/*Data for the table `department` */

insert  into `department`(`id`,`name`,`address`,`leader`,`active`,`createtime`) values (1,'神经内科','1111','1',1,'2020-12-23 09:06:58'),(2,'消化科','内科楼101','扁鹊主任',1,'2021-01-04 15:24:31'),(3,'普外科','外科大楼2层','孙医生',1,'2021-01-04 15:41:49');

/*Table structure for table `inspect_apply` */

DROP TABLE IF EXISTS `inspect_apply`;

CREATE TABLE `inspect_apply` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `item_id` int(11) DEFAULT NULL COMMENT '项目id',
  `item_name` varchar(100) DEFAULT NULL COMMENT '项目名称',
  `fee` decimal(8,2) DEFAULT NULL COMMENT '检查费用',
  `status` int(11) DEFAULT NULL COMMENT '状态',
  `register_id` int(11) DEFAULT NULL COMMENT '病历号',
  `active` int(11) DEFAULT '1' COMMENT '是否有效，1 有效，0 失效',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8 COMMENT='检验申请';

/*Data for the table `inspect_apply` */

insert  into `inspect_apply`(`id`,`item_id`,`item_name`,`fee`,`status`,`register_id`,`active`,`createtime`) values (1,1,'乙肝抗原','200.00',4,2,1,'2021-01-06 11:12:06'),(2,2,'血常规','40.00',4,2,1,'2021-01-06 11:12:06'),(3,1,'乙肝抗原','200.00',2,21,1,'2021-01-07 15:02:25'),(4,2,'血常规','40.00',2,21,1,'2021-01-07 15:02:26');

/*Table structure for table `inspect_item` */

DROP TABLE IF EXISTS `inspect_item`;

CREATE TABLE `inspect_item` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `name` varchar(100) DEFAULT NULL COMMENT '检查名称',
  `fee` decimal(8,2) DEFAULT NULL COMMENT '检查费用',
  `active` int(11) DEFAULT '1' COMMENT '是否有效，1 有效，0 失效',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8 COMMENT='检验项目';

/*Data for the table `inspect_item` */

insert  into `inspect_item`(`id`,`name`,`fee`,`active`,`createtime`) values (1,'乙肝抗原','200.00',1,'2021-01-05 10:57:47'),(2,'血常规','40.00',1,'2021-01-05 11:09:10'),(3,'肝功5项','60.00',1,'2021-01-05 11:10:12'),(4,'尿常规','60.00',1,'2021-01-05 13:51:19'),(5,'测试删除项目','10.00',0,'2021-01-05 13:51:46');

/*Table structure for table `menu` */

DROP TABLE IF EXISTS `menu`;

CREATE TABLE `menu` (
  `menu_id` int(11) NOT NULL AUTO_INCREMENT COMMENT '菜单id',
  `menu_name` varchar(100) DEFAULT NULL COMMENT '菜单名称',
  `url` varchar(100) DEFAULT NULL COMMENT '菜单url',
  `parent_id` int(11) DEFAULT NULL COMMENT '上级菜单id',
  `menu_type` int(10) DEFAULT NULL COMMENT '菜单类型1 展示、2按钮',
  `active` int(11) DEFAULT '1' COMMENT '是否有效，1 有效，0 失效',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`menu_id`)
) ENGINE=InnoDB AUTO_INCREMENT=28 DEFAULT CHARSET=utf8 COMMENT='菜单';

/*Data for the table `menu` */

insert  into `menu`(`menu_id`,`menu_name`,`url`,`parent_id`,`menu_type`,`active`,`createtime`) values (1,'系统管理',NULL,NULL,1,1,'2020-12-28 14:13:19'),(2,'用户管理','/user',1,1,1,'2020-12-28 14:54:43'),(4,'角色管理','/role',1,1,1,'2020-12-28 14:55:59'),(5,'挂号收费',NULL,NULL,1,1,'2020-12-28 15:51:32'),(6,'挂号','/regist',5,1,1,'2020-12-28 15:51:47'),(7,'收费','/fee',5,1,1,'2020-12-28 15:52:06'),(8,'退号','unregist',5,1,1,'2020-12-28 15:52:16'),(9,'退费','refund',5,1,1,'2020-12-28 15:52:24'),(10,'用户查询','/user?type=query',2,2,1,'2021-01-04 11:21:55'),(11,'用户添加','/user?type=add',2,2,1,'2021-01-04 11:24:46'),(12,'用户所有操作','/user',2,2,1,'2021-01-04 11:25:14'),(13,'菜单管理','/menu',1,1,1,'2021-01-07 11:38:49'),(14,'门诊医生',NULL,NULL,1,1,'2021-01-07 11:39:57'),(15,'门诊病历','doctor',14,1,1,'2021-01-07 11:41:40'),(16,'基础数据管理',NULL,NULL,1,1,'2021-01-07 11:41:53'),(17,'部门管理','dept',16,1,1,'2021-01-07 11:42:01'),(18,'挂号级别管理','regist_level',16,1,1,'2021-01-07 11:42:11'),(19,'检查项目维护','check_item',16,1,1,'2021-01-07 11:42:15'),(20,'检验项目维护','inspect_item',16,1,1,'2021-01-07 11:42:23'),(21,'常数类别','constant_type',16,1,1,'2021-01-07 11:42:31'),(22,'常数项目管理','constant_item',16,1,1,'2021-01-07 11:42:40'),(23,'角色的处理','/role',4,2,1,'2021-01-07 14:16:38'),(24,'患者的信息','/register',15,2,1,'2021-01-07 14:18:21'),(25,'医生相关的操作','/doctor',24,2,1,'2021-01-07 14:19:24'),(26,'部门的操作','/dept',2,2,1,'2021-01-07 14:51:05'),(27,'挂号级别查询','/regist_level',2,2,1,'2021-01-07 14:51:25');

/*Table structure for table `regist_level` */

DROP TABLE IF EXISTS `regist_level`;

CREATE TABLE `regist_level` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `name` varchar(100) DEFAULT NULL COMMENT '名称',
  `fee` decimal(8,2) DEFAULT NULL COMMENT '费用',
  `active` int(11) DEFAULT '1' COMMENT '是否有效，1 有效，0 失效',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8 COMMENT='挂号级别';

/*Data for the table `regist_level` */

insert  into `regist_level`(`id`,`name`,`fee`,`active`,`createtime`) values (1,'专家','500.00',1,'2021-01-04 13:58:22'),(2,'教授','400.00',1,'2021-01-04 13:58:40'),(3,'主治','30.00',1,'2021-01-04 13:58:44'),(4,'住院医师','10.00',1,'2021-01-04 13:59:09'),(5,'测试级别','30.50',1,'2021-01-04 14:24:36'),(6,'实习大夫','2.00',1,'2021-01-04 14:55:20');

/*Table structure for table `register` */

DROP TABLE IF EXISTS `register`;

CREATE TABLE `register` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'id病历号',
  `name` varchar(100) DEFAULT NULL COMMENT '姓名',
  `gender` int(11) DEFAULT NULL COMMENT '性别',
  `idno` varchar(100) DEFAULT NULL COMMENT '身份证号',
  `birthday` date DEFAULT NULL COMMENT '出生日期',
  `age` int(11) DEFAULT NULL COMMENT '年龄',
  `address` varchar(200) DEFAULT NULL COMMENT '家庭住址',
  `regsit_level_id` int(11) DEFAULT NULL COMMENT '挂号级别',
  `dept_id` int(11) DEFAULT NULL COMMENT '挂号科室',
  `doctor_id` int(11) DEFAULT NULL COMMENT '看诊医生',
  `book` int(11) DEFAULT NULL COMMENT '是否要病历本',
  `visittime` date DEFAULT NULL COMMENT '看诊时间',
  `fee` decimal(8,2) DEFAULT NULL COMMENT '挂号费用',
  `readme` varchar(500) DEFAULT NULL COMMENT '主诉',
  `present` varchar(500) DEFAULT NULL COMMENT '现病史',
  `present_treat` varchar(500) DEFAULT NULL COMMENT '现病史治疗情况',
  `history` varchar(500) DEFAULT NULL COMMENT '既往史',
  `allergy` varchar(500) DEFAULT NULL COMMENT '过敏史',
  `disease` varchar(500) DEFAULT NULL COMMENT '确诊疾病',
  `suit` varchar(500) DEFAULT NULL COMMENT '处置方案',
  `drug` varchar(500) DEFAULT NULL COMMENT '药品清单',
  `status` int(11) DEFAULT NULL COMMENT '状态',
  `active` int(11) DEFAULT '1' COMMENT '是否有效，1 有效，0 失效',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=22 DEFAULT CHARSET=utf8 COMMENT='诊疗信息';

/*Data for the table `register` */

insert  into `register`(`id`,`name`,`gender`,`idno`,`birthday`,`age`,`address`,`regsit_level_id`,`dept_id`,`doctor_id`,`book`,`visittime`,`fee`,`readme`,`present`,`present_treat`,`history`,`allergy`,`disease`,`suit`,`drug`,`status`,`active`,`createtime`) values (1,'张飞',1,'232323232136546456',NULL,40,NULL,1,25,NULL,1,'2021-01-04','501.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,1,1,'2021-01-04 14:07:05'),(2,'张三',1,'1212121212',NULL,1212,'12121212112',1,1,NULL,1,NULL,'500.00','主诉1','现病史2','现病史治疗情况2','既往史2','过敏史2',NULL,NULL,NULL,2,1,'2021-01-05 09:22:56'),(3,'关羽',1,'1212121221121211','2010-01-04',50,'黑龙江齐齐哈尔',1,1,27,1,NULL,'500.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,2,0,'2021-01-05 09:26:50'),(4,'刘备',1,'1212121221121211',NULL,50,'黑龙江齐齐哈尔',2,1,27,1,NULL,'500.00','主诉12111','现病1211','现病史治疗情221','既往史321','过敏史421',NULL,NULL,NULL,2,1,'2021-01-05 09:27:19'),(5,'孙悟空',1,'1212121221121211','2010-01-04',50,'黑龙江齐齐哈尔',1,1,27,1,NULL,'500.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,1,0,'2021-01-05 09:28:56'),(6,'刘备',1,'1212121221121211','2010-01-04',50,'黑龙江齐齐哈尔',2,1,27,1,'2021-01-07','500.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,1,0,'2021-01-05 09:30:34'),(7,'李逵',1,'1212121221121211',NULL,50,'黑龙江齐齐哈尔',1,1,27,1,'2021-01-07','500.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,3,1,'2021-01-05 09:36:54'),(8,'诸葛亮',1,'1212121221121211',NULL,50,'黑龙江齐齐哈尔',2,1,27,1,'2021-01-07','501.00','122','112','12','12','121212',NULL,NULL,NULL,1,1,'2021-01-05 09:41:52'),(9,'关羽',1,'54654654165464564','2021-01-12',50,'12121212121212',1,1,27,1,'2021-01-06','501.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,1,0,'2021-01-05 09:46:40'),(12,'诸葛亮',1,'1212121','2010-01-04',80,'东吴',2,2,25,1,'2021-01-06','401.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,1,0,'2021-01-05 10:53:19'),(13,'孙尚香',2,'5464854654654','2017-01-03',18,'东吴',2,2,25,1,'2021-01-08','401.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,1,0,'2021-01-05 10:54:23'),(15,'邹兆龙',1,'45651654684651651','2011-01-03',48,'32132132',1,1,27,1,'2021-01-07','501.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,1,1,'2021-01-06 10:29:41'),(16,'邹毅',1,'121212112212','2015-12-28',55,'1212121212',1,2,23,0,'2021-01-07','500.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,1,1,'2021-01-06 10:32:38'),(17,'徐玮辰',1,'12121212121212',NULL,50,'大撒旦法师法',2,1,28,0,'2021-01-13','400.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,3,1,'2021-01-06 10:35:53'),(18,'徐罗成',1,'12121212',NULL,12,'是大是大非',1,1,27,0,'2021-01-06','500.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,3,1,'2021-01-06 10:44:08'),(19,'杨旭',1,'231321321',NULL,50,'1212121212',1,2,23,0,'2021-01-08','500.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,3,1,'2021-01-07 14:55:43'),(20,'露露',2,'121212121','2016-01-04',50,'1211212',1,2,29,1,'2021-01-08','501.00',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,1,1,'2021-01-07 14:56:42'),(21,'韦吉亮',1,'121212',NULL,50,'121212',1,2,23,1,'2021-01-07','501.00','主诉','现病史','现病史治疗情况','既往史','过敏史\n',NULL,'尊医嘱，多喝水，多喝热水',NULL,2,1,'2021-01-07 15:01:45');

/*Table structure for table `role` */

DROP TABLE IF EXISTS `role`;

CREATE TABLE `role` (
  `role_id` int(11) NOT NULL AUTO_INCREMENT COMMENT '角色id',
  `role_name` varchar(100) DEFAULT NULL COMMENT '角色名称',
  `active` int(11) DEFAULT '1' COMMENT '是否有效，1 有效，0 失效',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`role_id`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8 COMMENT='角色';

/*Data for the table `role` */

insert  into `role`(`role_id`,`role_name`,`active`,`createtime`) values (1,'门诊医生',1,'2020-12-28 13:38:52'),(2,'挂号收费员',1,'2020-12-28 13:39:21'),(3,'系统管理员',1,'2020-12-28 13:39:41'),(4,'测试角色',0,'2020-12-28 13:59:02'),(5,'测试校验',1,'2021-01-07 10:49:23');

/*Table structure for table `role_menu` */

DROP TABLE IF EXISTS `role_menu`;

CREATE TABLE `role_menu` (
  `menu_id` int(11) NOT NULL COMMENT '菜单id',
  `role_id` int(11) NOT NULL COMMENT '角色id',
  PRIMARY KEY (`menu_id`,`role_id`),
  KEY `FK_Reference_2` (`role_id`),
  CONSTRAINT `FK_Reference_1` FOREIGN KEY (`menu_id`) REFERENCES `menu` (`menu_id`),
  CONSTRAINT `FK_Reference_2` FOREIGN KEY (`role_id`) REFERENCES `role` (`role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='角色菜单信息';

/*Data for the table `role_menu` */

insert  into `role_menu`(`menu_id`,`role_id`) values (5,2),(6,2),(7,2),(8,2),(9,2),(1,3),(2,3),(4,3),(5,3),(6,3),(7,3),(8,3),(9,3),(10,3),(11,3),(12,3),(13,3),(14,3),(15,3),(16,3),(17,3),(18,3),(19,3),(20,3),(21,3),(22,3),(23,3),(24,3),(25,3),(26,3),(27,3);

/*Table structure for table `user` */

DROP TABLE IF EXISTS `user`;

CREATE TABLE `user` (
  `user_id` int(11) NOT NULL AUTO_INCREMENT COMMENT '医生id',
  `username` varchar(100) DEFAULT NULL COMMENT '用户名',
  `password` varchar(100) DEFAULT NULL COMMENT '密码',
  `realname` varchar(100) DEFAULT NULL COMMENT '真实姓名',
  `telephone` varchar(20) DEFAULT NULL COMMENT '电话号码',
  `dept_id` int(11) DEFAULT NULL COMMENT 'id',
  `user_type` int(11) DEFAULT NULL COMMENT '医生类型',
  `regist_level` int(10) DEFAULT NULL COMMENT '医生级别',
  `lastlogin` datetime DEFAULT NULL COMMENT '最后登录时间',
  `active` int(11) DEFAULT '1' COMMENT '是否有效，1 有效，0 失效',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`user_id`),
  KEY `FK_Reference_5` (`dept_id`),
  CONSTRAINT `FK_Reference_5` FOREIGN KEY (`dept_id`) REFERENCES `department` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=60 DEFAULT CHARSET=utf8 COMMENT='医生-用户信息';

/*Data for the table `user` */

insert  into `user`(`user_id`,`username`,`password`,`realname`,`telephone`,`dept_id`,`user_type`,`regist_level`,`lastlogin`,`active`,`createtime`) values (21,'admin','123456','管理员','13888888880',1,1,1,NULL,0,'2020-12-23 09:07:06'),(22,'jshand','123456','姓名1','13888888881',1,1,1,NULL,0,'2020-12-23 09:07:06'),(23,'huatuo','123456','华佗','13888888882',2,1,1,NULL,1,'2020-12-23 09:07:06'),(24,'admin3','1234563','姓名3','13888888883',2,1,2,NULL,1,'2020-12-23 09:07:06'),(25,'bianque','1234564','扁鹊','13888888884',2,1,2,NULL,1,'2020-12-23 09:07:06'),(26,'admin5','1234565','姓名5','13888888885',2,1,2,NULL,1,'2020-12-23 09:07:06'),(27,'admin6','1234566','姓名6','13888888886',1,1,1,NULL,1,'2020-12-23 09:07:06'),(28,'admin7','1234567','姓名7','13888888887',1,1,2,NULL,1,'2020-12-23 09:07:06'),(29,'admin8','1234568','姓名8','13888888888',2,1,1,NULL,1,'2020-12-23 09:07:06'),(30,'admin9','1234569','姓名dddddd','13888888889',2,1,2,NULL,1,'2020-12-23 09:07:06'),(31,'admin10','12345610','姓名10','138888888810',1,1,1,NULL,1,'2020-12-23 09:07:06'),(32,'admin11','12345611','姓名11','138888888811',2,1,2,NULL,1,'2020-12-23 09:07:06'),(33,'admin12','12345612','姓名12','138888888812',1,1,1,NULL,1,'2020-12-23 09:07:06'),(34,'admin13','12345613','姓名13','138888888813',1,1,2,NULL,1,'2020-12-23 09:07:06'),(35,'admin14','12345614','姓名14','138888888814',1,1,1,NULL,1,'2020-12-23 09:07:06'),(36,'admin15','12345615','姓名15','138888888815',1,1,2,NULL,1,'2020-12-23 09:07:06'),(37,'admin16','12345616','姓名16','138888888816',1,1,NULL,NULL,1,'2020-12-23 09:07:06'),(38,'admin17','12345617','姓名17','138888888817',1,1,NULL,NULL,1,'2020-12-23 09:07:06'),(39,'admin18','12345618','姓名18','138888888818',1,1,NULL,NULL,1,'2020-12-23 09:07:06'),(40,'admin19','12345619','姓名19','138888888819',1,1,NULL,NULL,1,'2020-12-23 09:07:06'),(51,'vuejs','123456','张医生','17745125669',2,1,NULL,NULL,1,'2020-12-25 09:19:19'),(52,'aaa','123456','135341','32131321',2,1,NULL,NULL,1,'2020-12-25 09:21:19'),(53,'abcbdb','123456','45646','121212',NULL,1,NULL,NULL,1,'2020-12-25 09:22:19'),(54,'aaaa','11212','121212','1212',2,1,NULL,NULL,1,'2020-12-25 09:23:31'),(55,'abcdef','123456','4564864','321321321',NULL,1,NULL,NULL,1,'2020-12-25 09:24:51'),(56,'lastuser','123456','789789','6541651',NULL,1,NULL,NULL,1,'2020-12-25 09:27:06'),(57,'l22222','12345864646','3213','21321',NULL,1,NULL,NULL,1,'2020-12-25 09:27:50'),(58,'qqq','qqq','qqq','18404075932',NULL,1,NULL,NULL,1,'2020-12-28 08:59:02'),(59,NULL,NULL,NULL,NULL,NULL,1,NULL,NULL,1,'2021-01-04 16:43:10');

/*Table structure for table `user_role` */

DROP TABLE IF EXISTS `user_role`;

CREATE TABLE `user_role` (
  `user_id` int(11) NOT NULL COMMENT '医生id',
  `role_id` int(11) NOT NULL COMMENT '角色id',
  PRIMARY KEY (`user_id`,`role_id`),
  KEY `FK_Reference_4` (`role_id`),
  CONSTRAINT `FK_Reference_3` FOREIGN KEY (`user_id`) REFERENCES `user` (`user_id`),
  CONSTRAINT `FK_Reference_4` FOREIGN KEY (`role_id`) REFERENCES `role` (`role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='用户角色';

/*Data for the table `user_role` */

insert  into `user_role`(`user_id`,`role_id`) values (23,1),(25,1),(23,2),(21,3),(23,3),(25,3);

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;
```

### [15.2.2 添加依赖](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1522-添加依赖)

- mybaits
- mysql-connector-java
- pageHelper

```xml
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.neuedu.mybatis</groupId>
    <artifactId>ssm</artifactId>
    <version>1.0-SNAPSHOT</version>
    <packaging>war</packaging>

    <name>ssm Maven Webapp</name>
    <!-- FIXME change it to the project's website -->
    <url>http://www.example.com</url>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <maven.compiler.source>1.8</maven.compiler.source>
        <maven.compiler.target>1.8</maven.compiler.target>
        <spring.version>5.1.14.RELEASE</spring.version>
        <junit.version>4.12</junit.version>
        <jstl.version>1.2</jstl.version>
        <jackson.version>2.9.9</jackson.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>${junit.version}</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-webmvc</artifactId>
            <version>${spring.version}</version>
        </dependency>

        <dependency>
            <groupId>jstl</groupId>
            <artifactId>jstl</artifactId>
            <version>${jstl.version}</version>
        </dependency>


        <!--解析对象为json-->
        <!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-core -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-core</artifactId>
            <version>${jackson.version}</version>
        </dependency>

        <!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-annotations -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-annotations</artifactId>
            <version>${jackson.version}</version>
        </dependency>

        <!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
            <version>${jackson.version}</version>
        </dependency>


        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.16</version>
        </dependency>
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>javax.servlet-api</artifactId>
            <version>4.0.1</version>
        </dependency>
        <dependency>
            <groupId>javax.servlet.jsp</groupId>
            <artifactId>jsp-api</artifactId>
            <version>2.2</version>
        </dependency>



        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.49</version>
        </dependency>


        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.5.5</version>
        </dependency>

        <!-- https://mvnrepository.com/artifact/com.github.pagehelper/pagehelper -->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper</artifactId>
            <version>5.1.11</version>
        </dependency>

    </dependencies>


</project>
```

### [15.2.3 创建核心配置文件](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1523-创建核心配置文件)

创建核心配置文件SqlMapConfig.xml和jdbc.properties

- jdbc.properties

```properties
jdbc.username=root
jdbc.password=root
jdbc.url=jdbc:mysql://127.0.0.1:3306/ssm-java1
jdbc.driver=com.mysql.jdbc.Driver
```

- SqlMapConfig.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>



    <properties resource="mybatis/jdbc.properties"/>

    <settings>
        <setting name="logImpl" value="STDOUT_LOGGING"/>
        <setting name="lazyLoadingEnabled" value="true"/>
        <setting name="aggressiveLazyLoading" value="false"/>

        <setting name="cacheEnabled" value="true"/>

    </settings>



    <plugins>
        <!-- com.github.pagehelper为PageHelper类所在包名 -->
        <plugin interceptor="com.github.pagehelper.PageInterceptor">
            <!-- 使用下面的方式配置参数，后面会有所有的参数介绍 -->
            <property name="helperDialect" value="mysql"/>
            <property name="reasonable" value="true"/>
        </plugin>
    </plugins>



    <environments default="dev">
        <environment id="dev">
            <transactionManager type="JDBC"></transactionManager>
            <dataSource type="UNPOOLED">
                <property name="username"   value="${jdbc.username}"/>
                <property name="password"   value="${jdbc.password}"/>
                <property name="url"        value="${jdbc.url}"/>
                <property name="driver"     value="${jdbc.driver}"/>
            </dataSource>
        </environment>
    </environments>

    <mappers>
       <package name="com.neuedu.mapper"/>
    </mappers>

</configuration>
```

### [15.2.4 逆向工程](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1524-逆向工程)

逆向生成Mapper.xml、Mapper.java、实体(Example)

### [15.2.5 单元测试](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1525-单元测试)

```java
package com.neuedu.mapper;

import com.neuedu.entity.Menu;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;
import org.junit.Before;
import org.junit.Test;

import java.io.IOException;
import java.io.InputStream;
import java.util.List;

import static org.junit.Assert.*;

public class MenuMapperTest {

    SqlSessionFactory sqlSessionFactory ;

    @Before
    public void setUp() throws IOException {
        InputStream is = Resources.getResourceAsStream("mybatis/SqlMapConfig.xml");
        sqlSessionFactory = new SqlSessionFactoryBuilder().build(is);
    }



    @Test
    public void selectByExample() {
        SqlSession session = sqlSessionFactory.openSession();
        MenuMapper menuMapper = session.getMapper(MenuMapper.class);

        List<Menu> list = menuMapper.selectByExample(null);

        for (Menu menu : list) {
            System.out.println(menu);
        }


        session.close();
    }
}
```

## [15.3 将Mybaits整合到 IOC容器](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_153-将mybaits整合到-ioc容器)

将Mapper 创建的 过程 交给ioc， 在Ioc 中定义Mapper（Bean）,Mapper类本身是抽象，在ioc中声明的是 代理对象。使用Factory模式创建Mapper

 `SqlSession.getMapper(MenuMapper.class)`

使用Mybaits-spring提供的 工厂类用于创建 Mapper

使用Mybatis-spring

1. 添加依赖
2. 在IOC容器中定义SqlSessionFactoryBean
3. 定义Mapper
4. 在Service中注入Mapper（Dao）

### [15.3.1添加依赖](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1531添加依赖)

添加由mybatis提供的类库，用于整合Spring

- mybaits-spring
- 数据源：dbcp2
- 事务
- aop

```xml
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.neuedu.mybatis</groupId>
    <artifactId>ssm</artifactId>
    <version>1.0-SNAPSHOT</version>
    <packaging>war</packaging>

    <name>ssm Maven Webapp</name>
    <!-- FIXME change it to the project's website -->
    <url>http://www.example.com</url>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <maven.compiler.source>1.8</maven.compiler.source>
        <maven.compiler.target>1.8</maven.compiler.target>
        <spring.version>5.1.14.RELEASE</spring.version>
        <junit.version>4.12</junit.version>
        <jstl.version>1.2</jstl.version>
        <jackson.version>2.9.9</jackson.version>
        <lombok.version>1.18.16</lombok.version>
        <servlet-api.version>4.0.1</servlet-api.version>
        <jsp.version>2.2</jsp.version>
        <mysql.version>5.1.49</mysql.version>
        <mybatis.version>3.5.5</mybatis.version>
        <pagehelper.version>5.1.11</pagehelper.version>
        <mybatis-spring.version>2.0.6</mybatis-spring.version>

        <aspectjweaver.version>1.9.6</aspectjweaver.version>
        <dbcp2.version>2.7.0</dbcp2.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>${junit.version}</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-webmvc</artifactId>
            <version>${spring.version}</version>
        </dependency>


        <!--Spring-JDBC模块 -->
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-jdbc</artifactId>
            <version>${spring.version}</version>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-tx</artifactId>
            <version>${spring.version}</version>
        </dependency>



        <!--AOP依赖 -->
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-aop</artifactId>
            <version>${spring.version}</version>
        </dependency>

        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-test</artifactId>
            <version>${spring.version}</version>
        </dependency>


        <dependency>
            <groupId>jstl</groupId>
            <artifactId>jstl</artifactId>
            <version>${jstl.version}</version>
        </dependency>


        <!--解析对象为json-->
        <!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-core -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-core</artifactId>
            <version>${jackson.version}</version>
        </dependency>

        <!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-annotations -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-annotations</artifactId>
            <version>${jackson.version}</version>
        </dependency>

        <!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
            <version>${jackson.version}</version>
        </dependency>


        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>${lombok.version}</version>
        </dependency>
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>javax.servlet-api</artifactId>
            <version>${servlet-api.version}</version>
        </dependency>
        <dependency>
            <groupId>javax.servlet.jsp</groupId>
            <artifactId>jsp-api</artifactId>
            <version>${jsp.version}</version>
        </dependency>



        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>${mysql.version}</version>
        </dependency>


        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>${mybatis.version}</version>
        </dependency>


        <!-- https://mvnrepository.com/artifact/org.mybatis/mybatis-spring -->
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis-spring</artifactId>
            <version>${mybatis-spring.version}</version>
        </dependency>

        <!-- https://mvnrepository.com/artifact/com.github.pagehelper/pagehelper -->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper</artifactId>
            <version>${pagehelper.version}</version>
        </dependency>





        <!--Spring AOP 依赖的 织入模块 -->
        <dependency>
            <groupId>org.aspectj</groupId>
            <artifactId>aspectjweaver</artifactId>
            <version>${aspectjweaver.version}</version>
        </dependency>

        <!-- https://mvnrepository.com/artifact/org.apache.commons/commons-dbcp2 -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-dbcp2</artifactId>
            <version>${dbcp2.version}</version>
        </dependency>

    </dependencies>


</project>
```

### [15.3.2 定义SqlSessionFactoryBean](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1532-定义sqlsessionfactorybean)

在Spring的IOC容器中SqlSessionFactoryBean，主要在IOC容器中管理 DataSource,在SqlMapConfig.xml中将环境的配置去掉了（environments）

```xml
<!--读取属性文件 -->
    <context:property-placeholder location="classpath:mybatis/jdbc.properties" />

    <!-- 数据源-->
    <bean id="dataSource" class="org.apache.commons.dbcp2.BasicDataSource">
        <property name="username"       value="${jdbc.username}"/>
        <property name="password"   value="${jdbc.password}"/>
        <property name="url"        value="${jdbc.url}"/>
        <property name="driverClassName"     value="${jdbc.driver}"/>
    </bean>

   <bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
       <property name="configLocation" value="classpath:mybatis/SqlMapConfig.xml"/>
       <property name="dataSource" ref="dataSource"></property>
   </bean>
```

### [15.3.3 在IOC容器创建Mapper代理对象](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1533-在ioc容器创建mapper代理对象)

```
<!--1 单个MenuMapper 定义 -->
    <bean id="menuMapper" class="org.mybatis.spring.mapper.MapperFactoryBean">
        <property name="mapperInterface" value="com.neuedu.mapper.MenuMapper"/>
        <property name="sqlSessionFactory" ref="sqlSessionFactory"></property>
    </bean>

  <!--1 单个UserMapper 定义 -->
    <bean id="userMapper" class="org.mybatis.spring.mapper.MapperFactoryBean">
        <property name="mapperInterface" value="com.neuedu.mapper.UserMapper"/>
        <property name="sqlSessionFactory" ref="sqlSessionFactory"></property>
    </bean>
```

### [15.3.4 单元测试](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1534-单元测试)

```java
package com.neuedu.mapper;


import com.neuedu.entity.Menu;
import com.neuedu.entity.User;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;

import java.util.List;

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = "classpath:spring/spring-mvc.xml")
public class IocTest {



    @Autowired
    MenuMapper menuMapper;
    @Autowired
    UserMapper userMapper;




    @Test
    public void test1(){

        List<Menu> list = menuMapper.selectByExample(null);
        for (Menu menu : list) {
            System.out.println(menu);
        }

    }

    @Test
    public void test2(){

        List<User> list = userMapper.selectByExample(null);
        for (User user : list) {
            System.out.println(user);
        }
    }

}
```

### [15.3.5 使用包扫描的形式注册Mapper](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1535-使用包扫描的形式注册mapper)

适用于多个Mapper注册时使用

```xml
<!-- 使用 MapperScanner  扫描多个Mapper ：包扫描-->
    <bean class="org.mybatis.spring.mapper.MapperScannerConfigurer">
        <property name="sqlSessionFactoryBeanName" value="sqlSessionFactory"></property>
        <property name="basePackage" value="com.neuedu.mapper"/>
    </bean>
```

## [15.4 添加事务管理器](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_154-添加事务管理器)

### [15.4.1 xml形式声明事务](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1541-xml形式声明事务)

```xml
   <!--声明了 事务管理器的 增强  xml形式声明事务   -->

    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"></property>
    </bean>

    <tx:advice id="txAdvice" transaction-manager="txMtransactionManageranager">
        <tx:attributes>
            <tx:method name="select*" propagation="SUPPORTS"/>
            <tx:method name="save*" propagation="REQUIRED" isolation="DEFAULT" />
            <tx:method name="update*" propagation="REQUIRED"/>
            <tx:method name="delete*" propagation="REQUIRED"/>
        </tx:attributes>
    </tx:advice>


    <aop:config>
        <aop:advisor advice-ref="txAdvice" pointcut="execution(* com.neuedu.service.*.*(..))"></aop:advisor>
    </aop:config>
```

### [15.4.2 注解驱动声明式事务](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_1542-注解驱动声明式事务)

在需要加事务的方法上或类上添加 @Transactional注解

```java
package com.neuedu.service.impl;

import com.neuedu.mapper.MenuMapper;
import com.neuedu.service.MenuService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
public class MenuServiceImple implements MenuService {

    @Autowired
    MenuMapper mapper;



    @Transactional(propagation = Propagation.REQUIRED,rollbackFor = Exception.class )
    @Override
    public List selectAll() {
        return mapper.selectByExample(null);
    }
}
```

# [16 Mybatis-PLUS MP](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_16-mybatis-plus-mp)

## [16.1 官网](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_161-官网)

https://baomidou.com/

## [16.2 代码生成器](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_162-代码生成器)

- 添加依赖

  - 单元测试
  - 生成器 依赖
  - Freemarker
  - 数据库的驱动
  - lombok
  - 日志

  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  
  <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
      <parent>
          <artifactId>mybatis-parent-java1</artifactId>
          <groupId>com.neuedu.mybatis</groupId>
          <version>1.0-SNAPSHOT</version>
      </parent>
      <modelVersion>4.0.0</modelVersion>
  
      <artifactId>09-mybatis-plus-generator</artifactId>
      <packaging>war</packaging>
  
      <name>09-mybatis-plus-generator Maven Webapp</name>
      <!-- FIXME change it to the project's website -->
      <url>http://www.example.com</url>
  
      <properties>
          <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
          <maven.compiler.source>1.7</maven.compiler.source>
          <maven.compiler.target>1.7</maven.compiler.target>
      </properties>
  
      <dependencies>
          <dependency>
              <groupId>junit</groupId>
              <artifactId>junit</artifactId>
              <version>4.12</version>
              <scope>test</scope>
          </dependency>
  
          <dependency>
              <groupId>com.baomidou</groupId>
              <artifactId>mybatis-plus-generator</artifactId>
              <version>3.3.2</version>
          </dependency>
  
          <dependency>
              <groupId>org.freemarker</groupId>
              <artifactId>freemarker</artifactId>
              <version>2.3.30</version>
          </dependency>
  
          <dependency>
              <groupId>mysql</groupId>
              <artifactId>mysql-connector-java</artifactId>
              <version>5.1.49</version>
          </dependency>
          <!-- https://mvnrepository.com/artifact/org.slf4j/slf4j-api -->
          <dependency>
              <groupId>org.slf4j</groupId>
              <artifactId>slf4j-api</artifactId>
              <version>1.8.0-beta4</version>
          </dependency>
  ```

```
      <!-- https://mvnrepository.com/artifact/log4j/log4j -->
      <dependency>
          <groupId>log4j</groupId>
          <artifactId>log4j</artifactId>
          <version>1.2.17</version>
      </dependency>



  </dependencies>

  <build>
      <finalName>09-mybatis-plus-generator</finalName>
      <pluginManagement><!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) -->
          <plugins>
              <plugin>
                  <artifactId>maven-clean-plugin</artifactId>
                  <version>3.1.0</version>
              </plugin>
              <!-- see http://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_war_packaging -->
              <plugin>
                  <artifactId>maven-resources-plugin</artifactId>
                  <version>3.0.2</version>
              </plugin>
              <plugin>
                  <artifactId>maven-compiler-plugin</artifactId>
                  <version>3.8.0</version>
              </plugin>
              <plugin>
                  <artifactId>maven-surefire-plugin</artifactId>
                  <version>2.22.1</version>
              </plugin>
              <plugin>
                  <artifactId>maven-war-plugin</artifactId>
                  <version>3.2.2</version>
              </plugin>
              <plugin>
                  <artifactId>maven-install-plugin</artifactId>
                  <version>2.5.2</version>
              </plugin>
              <plugin>
                  <artifactId>maven-deploy-plugin</artifactId>
                  <version>2.8.2</version>
              </plugin>
          </plugins>
      </pluginManagement>
  </build>
- 设置log4j的配置文件

```properties
log4j.rootLogger=DEBUG, stdout  


log4j.appender.stdout=org.apache.log4j.ConsoleAppender  
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout  
log4j.appender.stdout.layout.ConversionPattern=[%p]\:%d{HH:mm:ss} %c(%L\u884C) %m%n
```

自定义以生成逻辑

```java
package com.neuedu.mp.generator;


import com.baomidou.mybatisplus.core.exceptions.MybatisPlusException;
import com.baomidou.mybatisplus.core.toolkit.StringPool;
import com.baomidou.mybatisplus.core.toolkit.StringUtils;
import com.baomidou.mybatisplus.generator.AutoGenerator;
import com.baomidou.mybatisplus.generator.InjectionConfig;
import com.baomidou.mybatisplus.generator.config.*;
import com.baomidou.mybatisplus.generator.config.po.TableInfo;
import com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;
import com.baomidou.mybatisplus.generator.engine.FreemarkerTemplateEngine;

import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;
import java.util.logging.Logger;

// 演示例子，执行 main 方法控制台输入模块表名回车自动生成对应项目目录中
public class CodeGenerator {

    /**
     * <p>
     * 读取控制台内容
     * </p>
     */
    public static String scanner(String tip) {


        Scanner scanner = new Scanner(System.in);
        StringBuilder help = new StringBuilder();
        help.append("请输入" + tip + "：");
        System.out.println(help.toString());
        if (scanner.hasNext()) {
            String ipt = scanner.next();
            if (StringUtils.isNotBlank(ipt)) {
                return ipt;
            }
        }
        throw new MybatisPlusException("请输入正确的" + tip + "！");
    }

    public static void main(String[] args) {
        // 代码生成器
        AutoGenerator mpg = new AutoGenerator();

        // 全局配置
        GlobalConfig gc = new GlobalConfig();
//        String projectPath = System.getProperty("user.dir");
        final String projectPath ="C:\\Users\\Administrator\\Desktop\\mp";
        gc.setOutputDir(projectPath + "/src/main/java");
        gc.setAuthor("金山");
        gc.setOpen(false);
        // gc.setSwagger2(true); 实体属性 Swagger2 注解
        mpg.setGlobalConfig(gc);

        // 数据源配置
        DataSourceConfig dsc = new DataSourceConfig();
        dsc.setUrl("jdbc:mysql://localhost:3306/ssm-java1?useUnicode=true&useSSL=false&characterEncoding=utf8");
        // dsc.setSchemaName("public");
        dsc.setDriverName("com.mysql.jdbc.Driver");
        dsc.setUsername("root");
        dsc.setPassword("root");
        mpg.setDataSource(dsc);

        // 包配置
        PackageConfig pc = new PackageConfig();
        final String pack = "com.neuedu.his";
//        pc.setModuleName(scanner("模块名"));
        pc.setParent(pack);
        mpg.setPackageInfo(pc);

        // 自定义配置
        InjectionConfig cfg = new InjectionConfig() {
            @Override
            public void initMap() {
                // to do nothing
            }
        };

//         如果模板引擎是 freemarker
        String templatePath = "/templates/mapper.xml.ftl";
        // 如果模板引擎是 velocity
        // String templatePath = "/templates/mapper.xml.vm";

        // 自定义输出配置
        List<FileOutConfig> focList = new ArrayList<>();
        // 自定义配置会被优先输出
        focList.add(new FileOutConfig(templatePath) {
            @Override
            public String outputFile(TableInfo tableInfo) {
                // 自定义输出文件名 ， 如果你 Entity 设置了前后缀、此处注意 xml 的名称会跟着发生变化！！
                return projectPath + "/src/main/resources/mapper/"+pack.replace(".","/") +"/" + tableInfo.getEntityName() + "Mapper" + StringPool.DOT_XML;
            }
        });
        /*
        cfg.setFileCreate(new IFileCreate() {
            @Override
            public boolean isCreate(ConfigBuilder configBuilder, FileType fileType, String filePath) {
                // 判断自定义文件夹是否需要创建
                checkDir("调用默认方法创建的目录，自定义目录用");
                if (fileType == FileType.MAPPER) {
                    // 已经生成 mapper 文件判断存在，不想重新生成返回 false
                    return !new File(filePath).exists();
                }
                // 允许生成模板文件
                return true;
            }
        });
        */
        cfg.setFileOutConfigList(focList);
        mpg.setCfg(cfg);

        // 配置模板
        TemplateConfig templateConfig = new TemplateConfig();

        // 配置自定义输出模板
        //指定自定义模板路径，注意不要带上.ftl/.vm, 会根据使用的模板引擎自动识别
        // templateConfig.setEntity("templates/entity2.java");
        // templateConfig.setService();
        // templateConfig.setController();

        templateConfig.setXml(null);
        mpg.setTemplate(templateConfig);

        // 策略配置
        StrategyConfig strategy = new StrategyConfig();
        strategy.setNaming(NamingStrategy.underline_to_camel);
        strategy.setColumnNaming(NamingStrategy.underline_to_camel);
//        strategy.setSuperEntityClass("你自己的父类实体,没有就不用设置!");
        strategy.setEntityLombokModel(true);
//        strategy.setRestControllerStyle(true);
        // 公共父类
//        strategy.setSuperControllerClass("你自己的父类控制器,没有就不用设置!");
        // 写于父类中的公共字段
//        strategy.setSuperEntityColumns("id");
//        strategy.setInclude(scanner("表名，多个英文逗号分割").split(","));  //默认生成所有表的
        strategy.setControllerMappingHyphenStyle(true);
//        strategy.setTablePrefix(pc.getModuleName() + "_");
        mpg.setStrategy(strategy);
        mpg.setTemplateEngine(new FreemarkerTemplateEngine());
        mpg.execute();
    }

}
```

## [16.3 在Sringmvc中使用 MP](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_163-在sringmvc中使用-mp)

使用ssm集成 MP

- ssm

- 将mybaits调换为 MP（Mybatis-PLUS）

  - 将mybatis的依赖替换成 MP的依赖
  - 删除mybatis、mybatis-spring pagehelper

  ```xml
  <!--mybatis-plus -->
  <dependency>
      <groupId>com.baomidou</groupId>
      <artifactId>mybatis-plus</artifactId>
      <version>3.4.2</version>
  </dependency>
  
  <!-- 日志 -->
   <!-- https://mvnrepository.com/artifact/org.slf4j/slf4j-api -->
          <dependency>
              <groupId>org.slf4j</groupId>
              <artifactId>slf4j-api</artifactId>
              <version>1.8.0-beta4</version>
          </dependency>
  ```

```
      <!-- https://mvnrepository.com/artifact/log4j/log4j -->
      <dependency>
          <groupId>log4j</groupId>
          <artifactId>log4j</artifactId>
          <version>1.2.17</version>
      </dependency>
- 修改SQLSessionFactory

```xml
<bean id="sqlSessionFactory" class="com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean">
        <property name="dataSource" ref="dataSource"/>
        <property name="mapperLocations" value="classpath:com/neuedu/his/mapper/*.xml"/>
        <property name="typeAliasesPackage" value="com.neuedu.his.entity"/>
    </bean>
```

修改MapperScannerConfigurer扫描的Mapper包

```xml
    <bean class="org.mybatis.spring.mapper.MapperScannerConfigurer">
        <property name="basePackage" value="com.neuedu.his.mapper"/>
    </bean>
```

- 单元测试

  ```
  package com.neuedu.his.controller;
  ```

import com.neuedu.his.service.IMenuService; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.RequestMapping;

import org.springframework.stereotype.Controller; import org.springframework.web.bind.annotation.RestController;

import java.util.List;

/**

- 

- 菜单 前端控制器

- 

- 

- @author 金山

- @since 2021-03-30

- / @RestController @RequestMapping("/menu") public class MenuController {

  @Autowired IMenuService menuService;

```
  /**
   *  http://127.0.0.1:8080/mp/menu/list
   * @return
   */
  @RequestMapping("list")
  List list(){
      return menuService.list();
  }
```

}

```
## 16.4 自定义sql

MP是对mybatis无侵入是的封装，自定义sql与mybatis原生的sql用法一样，定义Mapper.java、定义Mapper.java

## 16.5 分页

在IOC容器中给SQLSessionFactory 注入分页插件

```xml
 <bean id="sqlSessionFactory" class="com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean">
      <property name="dataSource" ref="dataSource"/>
      <property name="mapperLocations" value="classpath:com/neuedu/his/mapper/*.xml"/>
      <property name="typeAliasesPackage" value="com.neuedu.his.entity"/>

      <property name="plugins">
          <array>
              <ref bean="mybatisPlusInterceptor"/>
          </array>
      </property>
  </bean>

  <bean id="mybatisPlusInterceptor" class="com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor">
      <property name="interceptors">
          <list>
              <ref bean="paginationInnerInterceptor"/>
          </list>
      </property>
  </bean>
  <!--分页插件-->
  <bean id="paginationInnerInterceptor" class="com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor">
      <constructor-arg name="dbType" value="MYSQL"/>
  </bean>
```

- 测试代码

```java
@Test
    public void page(){

        Integer pageNum = 2;
        Integer pageSize = 5;
        IPage<Menu> page = new Page(pageNum,pageSize);

        page = menuService.page(page);
        List<Menu>  list = page.getRecords();
        for (Menu menu : list) {
            System.out.println(menu);
        }
    }
```

## [16.7 自定义sql的分页](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_167-自定义sql的分页)

- 在Mapper.xml 自定义sql。

  ```xml
      <select id="userSelectListPage" resultMap="resultMap">
          select * from menu 
      </select>
  ```

- 在Mapper.java

  ```java
  Page<Menu> userSelectListPage(Page page);
  ```

- 在service中使用

  ```java
  getBaseMapper().userSelectListPage(page);
  ```

  如果想在自定义sql中使用QueryWrapper封装的 where条件则代码如下：

  - Mapper.xml

  ```xml
    <select id="userSelectListPage" resultMap="resultMap">
          select * from menu ${ew.customSqlSegment}
      </select>
  ```

  - Mapper.java

  ```java
      Page<Menu> userSelectListPage(Page page, @Param(Constants.WRAPPER) Wrapper wrapper);
  ```

  - Service

  ```
   @Override
      public Page<Menu> userSelectListPage(Page page, Wrapper wrapper) {
          return getBaseMapper().userSelectListPage(page,wrapper);
      }
  ```

- 测试代码

```
@Test
    public void userSelectListPage(){

        Integer pageNum = 1;
        Integer pageSize = 5;
        Page<Menu> page = new Page(pageNum,pageSize);

        QueryWrapper wrapper = new QueryWrapper();
        wrapper.like("menu_name","管理");
        page = menuService.userSelectListPage(page, wrapper);

        List<Menu>  list = page.getRecords();
        for (Menu menu : list) {
            System.out.println(menu);
        }
    }    
```

## [17 日志](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_17-日志)

日志：可以按需的打印日志

常见的日志类库:

- log4j
- log4j2
- logback
- common-logging
- jdk-log
- Slf4J :日志的框架，抽象的,跟不同的日志的组件整合（log4j、logback）

## [17.1 SLF4J 整合log4j](https://jshand.gitee.io/#/course/13_mybatis/mybatis?id=_171-slf4j-整合log4j)

- 添加依赖

```xml
<dependency>
  <groupId>org.slf4j</groupId>
  <artifactId>slf4j-api</artifactId>
  <version>1.7.21</version>
</dependency>
<dependency>
  <groupId>org.slf4j</groupId>
  <artifactId>slf4j-log4j12</artifactId>
  <version>1.7.21</version>
</dependency>
<dependency>
  <groupId>log4j</groupId>
  <artifactId>log4j</artifactId>
  <version>1.2.17</version>
</dependency>
```

- 编辑log4j的日志配置文件
- 配置文件详解：https://my.oschina.net/u/3359365/blog/1559125

```properties
# 总的配置开关，级别 trace  debug info warn  error falat
log4j.rootLogger=INFO, stdout  

#设置不同包的打印之日的 级别
log4j.logger.com.neuedu.his.service=ALL

#打印的外观
log4j.appender.stdout=org.apache.log4j.ConsoleAppender  
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout  
log4j.appender.stdout.layout.ConversionPattern=[%p]\:%d{HH:mm:ss} %c(%L\u884C) %m%n
```

- 程序中使用日志框架

```
package com.neuedu.his.service;

import lombok.extern.slf4j.Slf4j;

import org.junit.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Slf4j
public class Log4jTest {

    Logger log = LoggerFactory.getLogger(Log4jTest.class);

    @Test
    public void test(){
        log.trace("trace");
        log.debug("debug");
        log.info("info");
        log.warn("warn");
        log.error("error");

    }

}
```

- lombok 对日志的支持，可以在类上面声明 @Slf4j注解，相当于在类中声明了log对象